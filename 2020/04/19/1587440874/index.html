<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="テスト駆動開発から始めるRuby入門 ~6時間でオブジェクト指向のエッセンスを体験する~"><meta name="keywords" content="テスト駆動開発,Ruby"><meta name="author" content="k2works"><meta name="copyright" content="k2works"><title>テスト駆動開発から始めるRuby入門 ~6時間でオブジェクト指向のエッセンスを体験する~ | １つの価値３つの領域 思想と技術</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-48713941-1', 'auto');
ga('send', 'pageview');</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#初めに"><span class="toc-number">1.</span> <span class="toc-text">初めに</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#概要"><span class="toc-number">1.1.</span> <span class="toc-text">概要</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#オブジェクト指向プログラム"><span class="toc-number">1.1.1.</span> <span class="toc-text">オブジェクト指向プログラム</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#オブジェクト指向設計"><span class="toc-number">1.1.2.</span> <span class="toc-text">オブジェクト指向設計</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#モジュールの分割"><span class="toc-number">1.1.3.</span> <span class="toc-text">モジュールの分割</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Before"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">Before</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#After"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">After</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#オブジェクト指向から始めるテスト駆動開発"><span class="toc-number">2.</span> <span class="toc-text">オブジェクト指向から始めるテスト駆動開発</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#テスト駆動開発"><span class="toc-number">2.1.</span> <span class="toc-text">テスト駆動開発</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TODO-リスト作成"><span class="toc-number">2.1.1.</span> <span class="toc-text">TODO リスト作成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#タイプ-1-の場合"><span class="toc-number">2.1.2.</span> <span class="toc-text">タイプ 1 の場合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#タイプ-2-の場合"><span class="toc-number">2.1.3.</span> <span class="toc-text">タイプ 2 の場合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#タイプ-3-の場合"><span class="toc-number">2.1.4.</span> <span class="toc-text">タイプ 3 の場合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#それ以外のタイプの場合"><span class="toc-number">2.1.5.</span> <span class="toc-text">それ以外のタイプの場合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#オブジェクト指向"><span class="toc-number">2.2.</span> <span class="toc-text">オブジェクト指向</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#手続き型プログラム"><span class="toc-number">2.2.1.</span> <span class="toc-text">手続き型プログラム</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#オブジェクト指向プログラム-1"><span class="toc-number">2.2.2.</span> <span class="toc-text">オブジェクト指向プログラム</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#カプセル化"><span class="toc-number">2.3.</span> <span class="toc-text">カプセル化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#フィールドのカプセル化"><span class="toc-number">2.3.1.</span> <span class="toc-text">フィールドのカプセル化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setter-の削除"><span class="toc-number">2.3.2.</span> <span class="toc-text">setter の削除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ポリモーフィズム"><span class="toc-number">2.4.</span> <span class="toc-text">ポリモーフィズム</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ポリモーフィズムによる条件記述の置き換え-1"><span class="toc-number">2.4.1.</span> <span class="toc-text">ポリモーフィズムによる条件記述の置き換え 1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ポリモーフィズムによる条件記述の置き換え-2"><span class="toc-number">2.4.2.</span> <span class="toc-text">ポリモーフィズムによる条件記述の置き換え 2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ポリモーフィズムによる条件記述の置き換え-3"><span class="toc-number">2.4.3.</span> <span class="toc-text">ポリモーフィズムによる条件記述の置き換え 3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ポリモーフィズムによる条件記述の置き換え-4"><span class="toc-number">2.4.4.</span> <span class="toc-text">ポリモーフィズムによる条件記述の置き換え 4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#State-Strategy-によるタイプコードの置き換え"><span class="toc-number">2.4.5.</span> <span class="toc-text">State&#x2F;Strategy によるタイプコードの置き換え</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#継承"><span class="toc-number">2.5.</span> <span class="toc-text">継承</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#スーパークラスの抽出"><span class="toc-number">2.5.1.</span> <span class="toc-text">スーパークラスの抽出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#メソッド名の変更"><span class="toc-number">2.5.2.</span> <span class="toc-text">メソッド名の変更</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#メソッドの移動"><span class="toc-number">2.5.3.</span> <span class="toc-text">メソッドの移動</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#値オブジェクト"><span class="toc-number">2.6.</span> <span class="toc-text">値オブジェクト</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#オブジェクトによるプリミティブの置き換え"><span class="toc-number">2.6.1.</span> <span class="toc-text">オブジェクトによるプリミティブの置き換え</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#マジックナンバーの置き換え"><span class="toc-number">2.6.2.</span> <span class="toc-text">マジックナンバーの置き換え</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#オブジェクトによるプリミティブの置き換え-1"><span class="toc-number">2.6.3.</span> <span class="toc-text">オブジェクトによるプリミティブの置き換え</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#学習用テスト"><span class="toc-number">2.6.4.</span> <span class="toc-text">学習用テスト</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ファーストクラスコレクション"><span class="toc-number">2.7.</span> <span class="toc-text">ファーストクラスコレクション</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#コレクションのカプセル化"><span class="toc-number">2.7.1.</span> <span class="toc-text">コレクションのカプセル化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#学習用テスト-1"><span class="toc-number">2.7.2.</span> <span class="toc-text">学習用テスト</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#オブジェクト指向設計-1"><span class="toc-number">2.8.</span> <span class="toc-text">オブジェクト指向設計</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#メソッドオブジェクトによるメソッドの置き換え"><span class="toc-number">2.8.1.</span> <span class="toc-text">メソッドオブジェクトによるメソッドの置き換え</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#メソッドオブジェクトによるメソッドの置き換え-1"><span class="toc-number">2.8.2.</span> <span class="toc-text">メソッドオブジェクトによるメソッドの置き換え</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#デッドコードの削除"><span class="toc-number">2.8.3.</span> <span class="toc-text">デッドコードの削除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#デザインパターン"><span class="toc-number">2.8.4.</span> <span class="toc-text">デザインパターン</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例外"><span class="toc-number">2.9.</span> <span class="toc-text">例外</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#アサーションの導入"><span class="toc-number">2.9.1.</span> <span class="toc-text">アサーションの導入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#例外によるエラーコードの置き換え"><span class="toc-number">2.9.2.</span> <span class="toc-text">例外によるエラーコードの置き換え</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#アルゴリズムの置き換え"><span class="toc-number">2.9.3.</span> <span class="toc-text">アルゴリズムの置き換え</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#マジックナンバーの置き換え-1"><span class="toc-number">2.9.4.</span> <span class="toc-text">マジックナンバーの置き換え</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#特殊ケースの導入"><span class="toc-number">2.9.5.</span> <span class="toc-text">特殊ケースの導入</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#モジュール分割"><span class="toc-number">2.10.</span> <span class="toc-text">モジュール分割</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ドメインモデル"><span class="toc-number">2.10.1.</span> <span class="toc-text">ドメインモデル</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#アプリケーション"><span class="toc-number">2.10.2.</span> <span class="toc-text">アプリケーション</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#テスト"><span class="toc-number">2.10.3.</span> <span class="toc-text">テスト</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#エントリーポイント"><span class="toc-number">2.10.4.</span> <span class="toc-text">エントリーポイント</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ふりかえり"><span class="toc-number">2.11.</span> <span class="toc-text">ふりかえり</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#オブジェクト指向プログラム-2"><span class="toc-number">2.11.1.</span> <span class="toc-text">オブジェクト指向プログラム</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#オブジェクト指向設計-2"><span class="toc-number">2.11.2.</span> <span class="toc-text">オブジェクト指向設計</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#モジュールの分割-1"><span class="toc-number">2.11.3.</span> <span class="toc-text">モジュールの分割</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#良い設計"><span class="toc-number">2.11.4.</span> <span class="toc-text">良い設計</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考サイト"><span class="toc-number">3.</span> <span class="toc-text">参考サイト</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考図書"><span class="toc-number">4.</span> <span class="toc-text">参考図書</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars1.githubusercontent.com/u/3236312?s=400&amp;u=e1bde5f87a640284db5e7bde55b7ecb2aa0f1eac&amp;v=4"></div><div class="author-info__name text-center">k2works</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">23</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">12</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">１つの価値３つの領域 思想と技術</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">テスト駆動開発から始めるRuby入門 ~6時間でオブジェクト指向のエッセンスを体験する~</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-19</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%8A%80%E8%A1%93/">技術</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%8A%80%E8%A1%93/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0/">プログラミング</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p><a href="https://gitpod.io/#https://github.com/hiroshima-arc/tdd_rb/tree/episode-3" target="_blank" rel="noopener">Open in Gitpod</a></p>
<h2 id="初めに"><a href="#初めに" class="headerlink" title="初めに"></a>初めに</h2><p>この記事は <a href="https://k2works.github.io/2020/04/16/1587009564/">テスト駆動開発から始める Ruby 入門 -2 時間で TDD とリファクタリングのエッセンスを体験する-</a> の続編です。</p>
<p>前提として エピソード１を完了して、<a href="https://k2works.github.io/2020/04/17/1587440287/">テスト駆動開発から始める Ruby 入門 -ソフトウェア開発の三種の神器を準備する-</a> で開発環境を構築したところから始まります。 別途、<a href="https://gitpod.io/#https://github.com/hiroshima-arc/tdd_rb/tree/episode-3" target="_blank" rel="noopener">セットアップ済み環境</a> を用意していますのでこちらからだとすぐに始めることが出来ます。</p>
<p>本記事は一応オブジェクト指向プログラム入門者向けとなっていますが、入門者の方は用語についてはわからなくても結構です、コードを繰り返し写経することで感覚を掴んでもらえば自ずと書いてあることはわかるようになってきますので。あと、概要はオブジェクト指向プログラム経験者に向けて書いたのものなので読み飛ばしてもらって結構です（ネタバレ内容です）、経験者の方からのツッコミお待ちしております。</p>
<h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>本記事では、 <strong>オブジェクト指向プログラム</strong> から <strong>オブジェクト指向設計</strong> そして <strong>モジュール分割</strong> を <strong>テスト駆動開発</strong> を通じて実践していきます。</p>
<h4 id="オブジェクト指向プログラム"><a href="#オブジェクト指向プログラム" class="headerlink" title="オブジェクト指向プログラム"></a>オブジェクト指向プログラム</h4><p>エピソード 1 で作成したプログラムの追加仕様を <strong>テスト駆動開発</strong> で実装します。 次に <strong>手続き型コード</strong> との比較から <strong>オブジェクト指向プログラム</strong> を構成する <strong>カプセル化</strong> <strong>ポリモフィズム</strong> <strong>継承</strong> という概念をコードベースの <strong>リファクタリング</strong> を通じて解説します。</p>
<p>具体的には <strong>フィールドのカプセル</strong> から <strong>setter の削除</strong> を適用することにより <strong>カプセル化</strong> を実現します。続いて、 <strong>ポリモーフィズムによる条件記述の置き換え</strong> から <strong>State/Strategy によるタイプコードの置き換え</strong> を適用することにより <strong>ポリモーフィズム</strong> の効果を体験します。そして、 <strong>スーパークラスの抽出</strong> から <strong>メソッド名の変更</strong> <strong>メソッドの移動</strong> の適用を通して <strong>継承</strong> の使い方を体験します。さらに <strong>値オブジェクト</strong> と <strong>ファーストクラス</strong> というオブジェクト指向プログラミングに必要なツールの使い方も学習します。</p>
<h4 id="オブジェクト指向設計"><a href="#オブジェクト指向設計" class="headerlink" title="オブジェクト指向設計"></a>オブジェクト指向設計</h4><p>次に設計の観点から <strong>単一責任の原則</strong> に違反している <code>FizzBuzz</code> クラスを <strong>デザインパターン</strong> の 1 つである <strong>Command パターン</strong> を使ったリファクタリングである <strong>メソッドオブジェクトによるメソッドの置き換え</strong> を適用してクラスの責務を分割します。オブジェクト指向設計のイデオムである <strong>デザインパターン</strong> として <strong>Command パターン</strong> 以外に <strong>Value Object パターン</strong> <strong>Factory Method パターン</strong> <strong>Strategy パターン</strong> を <strong>リファクタリング</strong> を適用する過程ですでに実現していたことを説明します。そして、<strong>オープン・クローズドの原則</strong> を満たすコードに <strong>リファクタリング</strong> されたことで既存のコードを変更することなく振る舞いを変更できるようになることを解説します。</p>
<p>加えて、正常系の設計を改善した後 <strong>アサーションの導入</strong> <strong>例外によるエラーコードの置き換え</strong> といった例外系の <strong>リファクタリング</strong> を適用します。最後に <strong>ポリモーフィズム</strong> の応用として <strong>特殊ケースの導入</strong> の適用による <strong>Null Object パターン</strong> を使った <strong>オープン・クローズドの原則</strong> に従った安全なコードの追加方法を解説します。</p>
<h4 id="モジュールの分割"><a href="#モジュールの分割" class="headerlink" title="モジュールの分割"></a>モジュールの分割</h4><p>仕上げは、<strong>モノリシック</strong> なファイルから個別のクラスモジュールへの分割を <strong>ドメインオブジェクト</strong> の抽出を通して <strong>ドメインモデル</strong> へと整理することにより <strong>モジュール分割</strong> を実現することを体験してもらいます。最後に <strong>良いコード</strong> と <strong>良い設計</strong> について考えます。</p>
<h5 id="Before"><a href="#Before" class="headerlink" title="Before"></a>Before</h5><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/beac3f11-f8c8-e8a5-7e09-ea0dda7e6693.png" alt="diag-c63943e73aed75ba31adf85779eaf481.png"></p>
<h5 id="After"><a href="#After" class="headerlink" title="After"></a>After</h5><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/b4adb851-0e0d-a5eb-f490-cddd272822cc.png" alt="diag-84a49e2f281dfc169055d0bfc4b4aeb6.png"></p>
<a id="more"></a>

<h2 id="オブジェクト指向から始めるテスト駆動開発"><a href="#オブジェクト指向から始めるテスト駆動開発" class="headerlink" title="オブジェクト指向から始めるテスト駆動開発"></a>オブジェクト指向から始めるテスト駆動開発</h2><h3 id="テスト駆動開発"><a href="#テスト駆動開発" class="headerlink" title="テスト駆動開発"></a>テスト駆動開発</h3><p>エピソード 1 ので作成したプログラムに以下の仕様を追加します。</p>
<p>仕様</p>
<pre><code>1 から 100 までの数をプリントするプログラムを書け。
ただし 3 の倍数のときは数の代わりに｢Fizz｣と、5 の倍数のときは｢Buzz｣とプリントし、
3 と 5 両方の倍数の場合には｢FizzBuzz｣とプリントすること。
タイプごとに出力を切り替えることができる。
タイプ１は通常、タイプ２は数字のみ、タイプ３は FizzBuzz の場合のみをプリントする。</code></pre><p>早速開発に取り掛かりましょう。エピソード 2 で開発環境の自動化をしているので以下のコマンドを実行するだけで開発を始めることができます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rake</span><br></pre></td></tr></table></figure>

<p><code>guard</code> が起動するとコンソールが使えなくなるのでもう一つコンソールを開いておきましょう。もしくは <code>.</code> を使うことで <code>guard</code> 内でコンソールのコマンドを呼び出すことができます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[1] guard(main)&gt; . ls</span><br><span class="line">coverage  Gemfile.lock  lib      provisioning  README.md  tmp</span><br><span class="line">Gemfile   Guardfile     main.rb  Rakefile      <span class="built_in">test</span>       Vagrantfile</span><br><span class="line">[2] guard(main)&gt; . <span class="built_in">pwd</span></span><br><span class="line">/workspace/tdd_rb</span><br><span class="line">[3] guard(main)&gt; . git status</span><br></pre></td></tr></table></figure>

<h4 id="TODO-リスト作成"><a href="#TODO-リスト作成" class="headerlink" title="TODO リスト作成"></a>TODO リスト作成</h4><p>まずは追加仕様を <strong>TODO リスト</strong> に落とし込んでいきます。</p>
<p>TODO リスト</p>
<ul>
<li><p>タイプ 1 の場合</p>
<ul>
<li><p>数を文字列にして返す</p>
<ul>
<li>1 を渡したら文字列”1”を返す</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="タイプ-1-の場合"><a href="#タイプ-1-の場合" class="headerlink" title="タイプ 1 の場合"></a>タイプ 1 の場合</h4><p><strong>テストファースト</strong> <strong>アサートファースト</strong> で最初に失敗するテストから始めます。テストを追加しましょう。</p>
<p>ここでは既存の <code>FizzBuzz.generate</code> メソッドにタイプを <strong>引数</strong> として追加することで対応できるように変更してみたいと思います。まず、 <code>fizz_buzz_test.rb</code> ファイルに以下のテストコードを追加します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">'タイプごとに出力を切り替えることができる'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">        assert_equal <span class="string">'1'</span>, FizzBuzz.generate(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">'配列や繰り返し処理を理解する'</span> <span class="keyword">do</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">05:32:51 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest to /workspace/tdd_rb/coverage. 4 / 11 LOC (36.36%) covered.</span><br><span class="line">Started with run options --guard --seed 37049</span><br><span class="line"></span><br><span class="line">ERROR[<span class="string">"test_1を渡したら文字列1を返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x00005623e6a24260 @name="タイプごとに出力を切り替えることができる::タイプ1の場合"&gt;, 0.0019176720088580623]</span></span><br><span class="line"> test_1を渡したら文字列1を返す<span class="comment">#タイプごとに出力を切り替えることができる::タイプ1の場合 (0.00s)</span></span><br><span class="line">Minitest::UnexpectedError:         ArgumentError: wrong number of arguments (given 2, expected 1)</span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:6:<span class="keyword">in</span> `generate<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:74:in `test_1を渡したら文字列1を返す'</span></span><br><span class="line"></span><br><span class="line">  25/25: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00796s</span><br><span class="line">25 tests, 26 assertions, 0 failures, 1 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>ArgumentError: wrong number of arguments (given 2, expected 1)</code> <strong>引数</strong> が違うと指摘されていますね。 <code>FizzBuzz.generate</code> メソッドの引数の変更したいのですが既存のテストを壊したくないのでここは <strong>デフォルト引数</strong> 使ってみましょう。</p>
<blockquote>
<p>メソッドの引数にはデフォルト値を指定する定義方法があります。これは、メソッドの引数を省略した場合に割り当てられる値です。</p>
<p>— かんたん Ruby</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">class FizzBuzz</span><br><span class="line">  MAX_NUMBER = 100</span><br><span class="line"></span><br><span class="line">  def self.generate(number, <span class="built_in">type</span> = 1)</span><br><span class="line">    is_fizz = number.modulo(3).zero?</span><br><span class="line">    is_buzz = number.modulo(5).zero?</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">    <span class="built_in">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">    <span class="built_in">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  end</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">05:32:52 - INFO - Inspecting Ruby code style: <span class="built_in">test</span>/fizz_buzz_test.rb Guardfile</span><br><span class="line"> 2/2 files |====================================== 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">2 files inspected, no offenses detected</span><br><span class="line">05:32:54 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/loading_background.png coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/border.png</span><br><span class="line"> 0/0 files |====================================== 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">0 files inspected, no offenses detected</span><br><span class="line">05:37:29 - INFO - Inspecting Ruby code style: lib/fizz_buzz.rb</span><br><span class="line">lib/fizz_buzz.rb:6:29: W: [Corrected] Lint/UnusedMethodArgument: Unused method argument - <span class="built_in">type</span>. If it<span class="string">'s necessary, use _ or _type as an argument name to indicate that it won'</span>t be used.</span><br><span class="line">  def self.generate(number, <span class="built_in">type</span> = 1)</span><br><span class="line">                            ^^^^</span><br><span class="line"> 1/1 file |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">1 file inspected, 1 offense detected, 1 offense corrected</span><br><span class="line">05:37:31 - INFO - Inspecting Ruby code style: lib/fizz_buzz.rb</span><br><span class="line"> 1/1 file |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">1 file inspected, no offenses detected</span><br><span class="line">[1] guard(main)&gt;</span><br><span class="line">05:39:37 - INFO - Run all</span><br><span class="line">05:39:37 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest to /workspace/tdd_rb/coverage. 4 / 11 LOC (36.36%) covered.</span><br><span class="line">Started with run options --guard --seed 8607</span><br><span class="line"></span><br><span class="line">  25/25: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00723s</span><br><span class="line">25 tests, 27 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ちなみにここでは 引数に <code>type=1</code> と入力したのですがコードフォーマットによって以下のように自動修正されます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">class FizzBuzz</span><br><span class="line">  MAX_NUMBER = 100</span><br><span class="line"></span><br><span class="line">  def self.generate(number, _type = 1)</span><br><span class="line">    is_fizz = number.modulo(3).zero?</span><br><span class="line">    is_buzz = number.modulo(5).zero?</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">    <span class="built_in">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">    <span class="built_in">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  end</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>case 式</strong> を使って <strong>引数</strong> を判定できるように変更しましょう。ちなみに <code>_type</code> をメソッド内で変数として使うと警告されるので <code>type</code> に変更しています。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">generate</span><span class="params">(number, type = <span class="number">1</span>)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">      is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Started with run options --seed 51330</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Progress: |=============================================================|</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00828s</span><br><span class="line">25 tests, 27 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">04:27:12 - INFO - Inspecting Ruby code style: lib/fizz_buzz.rb</span><br><span class="line"> 1/1 file |=================== 100 ====================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">1 file inspected, no offenses detected</span><br><span class="line">04:27:13 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/loading_background.png coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/border.png</span><br><span class="line"> 0/0 files |=================== 100 ===================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">0 files inspected, no offenses detected</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストは無事通りました。ここでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'test: タイプ1の場合'</span></span><br></pre></td></tr></table></figure>

<p>追加仕様の取っ掛かりができました。既存のテストを流用したいので先程作成したテストを削除して以下のように新しいグループ内に既存テストコードを移動しましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列<span class="title">Fizz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Fizz'</span>, @fizzbuzz.generate(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @fizzbuzz.generate(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @fizzbuzz.generate(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.generate(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          @result = FizzBuzz.generate_list</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の初めは文字列の1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @result.first</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の最後は文字列の<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @result.last</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の2番目は文字列の<span class="title">Fizz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Fizz'</span>, @result[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の4番目は文字列の<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @result[<span class="number">4</span>]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の14番目は文字列の<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @result[<span class="number">14</span>]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストコードが壊れていないことを確認したらコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: メソッドのインライン化'</span></span><br></pre></td></tr></table></figure>

<p>TODO リスト</p>
<ul>
<li><p>タイプ 1 の場合</p>
<ul>
<li><p>数を文字列にして返す</p>
<ul>
<li><del>1 を渡したら文字列”1”を返す</del></li>
</ul>
</li>
<li><p>3 の倍数のときは数の代わりに｢Fizz｣と返す_</p>
<ul>
<li><del>3 を渡したら文字列”Fizz”を返す</del></li>
</ul>
</li>
<li><p>5 の倍数のときは｢Buzz｣と返す_</p>
<ul>
<li><del>5 を渡したら文字列”Buzz”を返す</del></li>
</ul>
</li>
<li><p>3 と 5 両方の倍数の場合には｢FizzBuzz｣と返す_</p>
<ul>
<li><del>15 を渡したら文字列”FizzBuzz”を返す</del></li>
</ul>
</li>
</ul>
</li>
<li><p>タイプ 2 の場合</p>
<ul>
<li><p>数を文字列にして返す</p>
<ul>
<li>1 を渡したら文字列”1”を返す</li>
</ul>
</li>
<li><p>3 の倍数のときは数を文字列にして返す</p>
<ul>
<li>3 を渡したら文字列”3”を返す</li>
</ul>
</li>
<li><p>5 の倍数のときは数を文字列にして返す</p>
<ul>
<li>5 を渡したら文字列”5”を返す</li>
</ul>
</li>
<li><p>3 と 5 両方の倍数の場合には数を文字列にして返す</p>
<ul>
<li>15 を渡したら文字列”15”を返す</li>
</ul>
</li>
</ul>
</li>
<li><p>タイプ 3 の場合</p>
<ul>
<li><p>数を文字列にして返す</p>
<ul>
<li>1 を渡したら文字列”1”を返す</li>
</ul>
</li>
<li><p>3 の倍数のときは数を文字列にして返す</p>
<ul>
<li>3 を渡したら文字列”3”を返す</li>
</ul>
</li>
<li><p>5 の倍数のときは数を文字列にして返す</p>
<ul>
<li>5 を渡したら文字列”5”を返す</li>
</ul>
</li>
<li><p>3 と 5 両方の倍数の場合には｢FizzBuzz｣と返す</p>
<ul>
<li>15 を渡したら文字列”FizzBuzz”を返す</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="タイプ-2-の場合"><a href="#タイプ-2-の場合" class="headerlink" title="タイプ 2 の場合"></a>タイプ 2 の場合</h4><p>TODO リスト</p>
<ul>
<li><p><del>タイプ 1 の場合</del></p>
</li>
<li><p>タイプ 2 の場合</p>
<ul>
<li><p>数を文字列にして返す</p>
<ul>
<li>1 を渡したら文字列”1”を返す</li>
</ul>
</li>
<li><p>3 の倍数のときは数を文字列にして返す</p>
<ul>
<li>3 を渡したら文字列”3”を返す</li>
</ul>
</li>
<li><p>5 の倍数のときは数を文字列にして返す</p>
<ul>
<li>5 を渡したら文字列”5”を返す</li>
</ul>
</li>
<li><p>3 と 5 両方の倍数の場合には数を文字列にして返す</p>
<ul>
<li>15 を渡したら文字列”15”を返す</li>
</ul>
</li>
</ul>
</li>
<li><p>タイプ 3 の場合</p>
<ul>
<li><p>数を文字列にして返す</p>
<ul>
<li>1 を渡したら文字列”1”を返す</li>
</ul>
</li>
<li><p>3 の倍数のときは数を文字列にして返す</p>
<ul>
<li>3 を渡したら文字列”3”を返す</li>
</ul>
</li>
<li><p>5 の倍数のときは数を文字列にして返す</p>
<ul>
<li>5 を渡したら文字列”5”を返す</li>
</ul>
</li>
<li><p>3 と 5 両方の倍数の場合には｢FizzBuzz｣と返す</p>
<ul>
<li>15 を渡したら文字列”FizzBuzz”を返す</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>続いて、タイプ 2 の場合に取り掛かりましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.generate(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">FAIL[<span class="string">"test_1を渡したら文字列1を返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x00005555ec747100 @name="数を文字列にして返す::タイプ2の場合::その他の場合"&gt;, 0.002283181995153427]</span></span><br><span class="line"> test_1を渡したら文字列1を返す<span class="comment">#数を文字列にして返す::タイプ2の場合::その他の場合 (0.00s)</span></span><br><span class="line">        Expected: <span class="string">"1"</span></span><br><span class="line">          Actual: nil</span><br><span class="line">        /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:75:<span class="keyword">in</span> `test_1を渡したら文字列1を返す<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  24/24: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Finished in 0.00437s</span></span><br><span class="line"><span class="string">24 tests, 26 assertions, 1 failures, 0 errors, 0 skips</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>まだ <strong>引数</strong> に 2 を渡した場合は何もしないので <strong>case 式</strong> に 2 を渡した場合の処理を追加します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">generate</span><span class="params">(number, type = <span class="number">1</span>)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">      is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Started with run options --seed 19625</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Progress: |=============================================================================|</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00894s</span><br><span class="line">24 tests, 26 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストが通ったのでテストケースを追加します。ここはタイプ 1 の場合をコピーして編集すれば良いでしょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.generate(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.generate(<span class="number">5</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列15を返す</span></span><br><span class="line">          assert_equal <span class="string">'15'</span>, @fizzbuzz.generate(<span class="number">15</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.generate(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest to /workspace/tdd_rb/coverage. 4 / 13 LOC (30.77%) covered.</span><br><span class="line">Started with run options --guard --seed 898</span><br><span class="line"></span><br><span class="line">  27/27: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00900s</span><br><span class="line">27 tests, 29 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line"></span><br><span class="line">06:27:40 - INFO - Inspecting Ruby code style of all files</span><br><span class="line"><span class="built_in">test</span>/fizz_buzz_test.rb:11:3: C: Metrics/BlockLength: Block has too many lines. [70/62]</span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span> ...</span><br><span class="line">  ^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line"> 7/7 files |====================================== 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">7 files inspected, 1 offense detected</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストは通りましたが何やら警告が表示されるようになりました。　<br><a href="https://rubocop.readthedocs.io/en/latest/cops_metrics/#metricsblocklength" target="_blank" rel="noopener">Metrics/BlockLength:Block has too many lines.</a> これは <code>数を文字列にして返す</code> テストケースのコードブロックが長いという警告のようですがテストコードはチェックの対象から外しておきたいので <code>.rubocop_todo.yml</code> に以下コードを追加してチェック対象から外しておきます。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Offense count: 2</span></span><br><span class="line"><span class="comment"># Configuration parameters: CountComments, ExcludedMethods.</span></span><br><span class="line"><span class="comment"># ExcludedMethods: refine</span></span><br><span class="line"><span class="attr">Metrics/BlockLength:</span></span><br><span class="line">  <span class="attr">Max:</span> <span class="number">62</span></span><br><span class="line">  <span class="attr">Exclude:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"test/fizz_buzz_test.rb"</span></span><br></pre></td></tr></table></figure>

<p>ちなみに <code>guard(main)&gt;</code> にカーソルを合わせてエンターキーを押すと自動化タスクが実行されます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[1] guard(main)&gt;</span><br><span class="line">02:03:15 - INFO - Run all</span><br><span class="line">/home/gitpod/.rvm/rubies/ruby-2.6.3/bin/ruby -w -I<span class="string">"lib"</span> -I<span class="string">"/workspace/.rvm/gems/rake-13.0.1/lib"</span> <span class="string">"/workspace/.rvm/gems/rake-13.0.1/lib/rake/rake_test_loader.rb"</span> <span class="string">"./test/fizz_buzz_test.rb"</span></span><br><span class="line">/home/gitpod/.rvm/rubies/ruby-2.6.3/bin/ruby -w -I<span class="string">"lib"</span> -I<span class="string">"/workspace/.rvm/gems/rake-13.0.1/lib"</span> <span class="string">"/workspace/.rvm/gems/rake-13.0.1/lib/rake/rake_test_loader.rb"</span> <span class="string">"./test/fizz_buzz_test.rb"</span></span><br><span class="line">Started with run options --seed 47335</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Progress: |==============================================================================|</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00781s</span><br><span class="line">27 tests, 29 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">Started with run options --seed 47825</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Progress: |==============================================================================|</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00761s</span><br><span class="line">27 tests, 29 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">02:03:17 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 13 / 13 LOC (100.0%) covered.</span><br><span class="line">Started with run options --guard --seed 17744</span><br><span class="line"></span><br><span class="line">  27/27: [===========================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00789s</span><br><span class="line">27 tests, 29 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line"></span><br><span class="line">02:03:17 - INFO - Inspecting Ruby code style of all files</span><br><span class="line"> 7/7 files |=========================== 100 ============================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">7 files inspected, no offenses detected</span><br><span class="line">02:03:19 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/border.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/loading_background.png</span><br><span class="line"> 0/0 files |=========================== 100 ============================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">0 files inspected, no offenses detected</span><br><span class="line">[1] guard(main)&gt;</span><br></pre></td></tr></table></figure>

<p>警告は消えたのでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'test: タイプ2の場合'</span></span><br></pre></td></tr></table></figure>

<p>TODO リスト</p>
<ul>
<li><p><del>タイプ 1 の場合</del></p>
</li>
<li><p>タイプ 2 の場合</p>
<ul>
<li><p>数を文字列にして返す</p>
<ul>
<li><del>1 を渡したら文字列”1”を返す</del></li>
</ul>
</li>
<li><p>3 の倍数のときは数を文字列にして返す</p>
<ul>
<li><del>3 を渡したら文字列”3”を返す</del></li>
</ul>
</li>
<li><p>5 の倍数のときは数を文字列にして返す</p>
<ul>
<li><del>5 を渡したら文字列”5”を返す</del></li>
</ul>
</li>
<li><p>3 と 5 両方の倍数の場合には数を文字列にして返す</p>
<ul>
<li><del>15 を渡したら文字列”15”を返す</del></li>
</ul>
</li>
</ul>
</li>
<li><p>タイプ 3 の場合</p>
<ul>
<li><p>数を文字列にして返す</p>
<ul>
<li>1 を渡したら文字列”1”を返す</li>
</ul>
</li>
<li><p>3 の倍数のときは数を文字列にして返す</p>
<ul>
<li>3 を渡したら文字列”3”を返す</li>
</ul>
</li>
<li><p>5 の倍数のときは数を文字列にして返す</p>
<ul>
<li>5 を渡したら文字列”5”を返す</li>
</ul>
</li>
<li><p>3 と 5 両方の倍数の場合には｢FizzBuzz｣と返す</p>
<ul>
<li>15 を渡したら文字列”FizzBuzz”を返す</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="タイプ-3-の場合"><a href="#タイプ-3-の場合" class="headerlink" title="タイプ 3 の場合"></a>タイプ 3 の場合</h4><p>TODO リスト</p>
<ul>
<li><p><del>タイプ 1 の場合</del></p>
</li>
<li><p><del>タイプ 2 の場合</del></p>
</li>
<li><p>タイプ 3 の場合</p>
<ul>
<li><p>数を文字列にして返す</p>
<ul>
<li>1 を渡したら文字列”1”を返す</li>
</ul>
</li>
<li><p>3 の倍数のときは数を文字列にして返す</p>
<ul>
<li>3 を渡したら文字列”3”を返す</li>
</ul>
</li>
<li><p>5 の倍数のときは数を文字列にして返す</p>
<ul>
<li>5 を渡したら文字列”5”を返す</li>
</ul>
</li>
<li><p>3 と 5 両方の倍数の場合には｢FizzBuzz｣と返す</p>
<ul>
<li>15 を渡したら文字列”FizzBuzz”を返す</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>続いて、タイプ 3 の場合ですがやることは同じなので今回は一気にテストを書いてみましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.generate(<span class="number">3</span>, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.generate(<span class="number">5</span>, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @fizzbuzz.generate(<span class="number">15</span>, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.generate(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> FAIL[<span class="string">"test_1を渡したら文字列1を返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x00005642171ea5a0 @name="数を文字列にして返す::タイプ3の場合::その他の場合"&gt;, 0.003375133004738018]</span></span><br><span class="line"> test_1を渡したら文字列1を返す<span class="comment">#数を文字列にして返す::タイプ3の場合::その他の場合 (0.00s)</span></span><br><span class="line">        Expected: <span class="string">"1"</span></span><br><span class="line">          Actual: nil</span><br><span class="line">        /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:123:<span class="keyword">in</span> `test_1を渡したら文字列1を返す<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> FAIL["test_5を渡したら文字列5を返す", #&lt;Minitest::Reporters::Suite:0x000056421723af78 @name="数を文字列にして返す::タイプ3の場合::五の倍数の場合"&gt;, 0.003832244998193346]</span></span><br><span class="line"><span class="string"> test_5を渡したら文字列5を返す#数を文字列にして返す::タイプ3の場合::五の倍数の場合 (0.00s)</span></span><br><span class="line"><span class="string">        Expected: "5"</span></span><br><span class="line"><span class="string">          Actual: nil</span></span><br><span class="line"><span class="string">        /workspace/tdd_rb/test/fizz_buzz_test.rb:111:in `test_5を渡したら文字列5を返す'</span></span><br><span class="line"></span><br><span class="line"> FAIL[<span class="string">"test_3を渡したら文字列3を返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x0000564217297340 @name="数を文字列にして返す::タイプ3の場合::三の倍数の場合"&gt;, 0.0043466729985084385]</span></span><br><span class="line"> test_3を渡したら文字列3を返す<span class="comment">#数を文字列にして返す::タイプ3の場合::三の倍数の場合 (0.00s)</span></span><br><span class="line">        Expected: <span class="string">"3"</span></span><br><span class="line">          Actual: nil</span><br><span class="line">        /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:105:<span class="keyword">in</span> `test_3を渡したら文字列3を返す<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> FAIL["test_15を渡したら文字列FizzBuzzを返す", #&lt;Minitest::Reporters::Suite:0x00005642174dec98 @name="数を文字列にして返す::タイプ3の場合::三と五の倍数の場合"&gt;, 0.006096020006225444]</span></span><br><span class="line"><span class="string"> test_15を渡したら文字列FizzBuzzを返す#数を文字列にして返す::タイプ3の場合::三と五の倍数の場合 (0.01s)</span></span><br><span class="line"><span class="string">        Expected: "FizzBuzz"</span></span><br><span class="line"><span class="string">          Actual: nil</span></span><br><span class="line"><span class="string">        /workspace/tdd_rb/test/fizz_buzz_test.rb:117:in `test_15を渡したら文字列FizzBuzzを返す'</span></span><br><span class="line"></span><br><span class="line">  31/31: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00650s</span><br><span class="line">31 tests, 33 assertions, 4 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>case 式</strong> に処理を追加します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">generate</span><span class="params">(number, type = <span class="number">1</span>)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">      is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">      is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Started with run options --seed 12137</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Progress: |=============================================================================|</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.01662s</span><br><span class="line">31 tests, 33 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">05:06:44 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/loading_background.png coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/border.png lib/fizz_buzz.rb</span><br><span class="line">lib/fizz_buzz.rb:6:3: C: Metrics/CyclomaticComplexity: Cyclomatic complexity <span class="keyword">for</span> generate is too high. [10/8]</span><br><span class="line">  def self.generate(number, <span class="built_in">type</span> = 1) ...</span><br><span class="line">  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">lib/fizz_buzz.rb:6:3: C: Metrics/PerceivedComplexity: Perceived complexity <span class="keyword">for</span> generate is too high. [8/7]</span><br><span class="line">  def self.generate(number, <span class="built_in">type</span> = 1) ...</span><br><span class="line">  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line"> 1/1 file |=========================== 100 ============================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">1 file inspected, 2 offenses detected</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストは通りましたが新しい警告が表示されるようになりました。とりあえずコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'test: タイプ3の場合'</span></span><br></pre></td></tr></table></figure>

<p>処理の追加により一部重複が発生しました。ここは、 <strong>ステートメントのスライド</strong> を適用して重複をなくしておきましょう。</p>
<blockquote>
<p>ステートメントのスライド</p>
<p>旧：重複した条件記述の断片の統合</p>
<p>— リファクタリング(第 2 版)</p>
</blockquote>
<blockquote>
<p>重複した条件記述の断片の統合</p>
<p>条件式のすべて分岐に同じコードの断片がある。</p>
<p>それを式の外側に移動する。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">generate</span><span class="params">(number, type = <span class="number">1</span>)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">      is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">      is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">generate</span><span class="params">(number, type = <span class="number">1</span>)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>警告は消えていませんがプログラムは壊れていないことが確認できたのでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: ステートメントのスライド'</span></span><br></pre></td></tr></table></figure>

<p>TODO リスト</p>
<ul>
<li><p><del>タイプ 1 の場合</del></p>
</li>
<li><p><del>タイプ 2 の場合</del></p>
</li>
<li><p>タイプ 3 の場合</p>
<ul>
<li><p>数を文字列にして返す</p>
<ul>
<li><del>1 を渡したら文字列”1”を返す</del></li>
</ul>
</li>
<li><p>3 の倍数のときは数を文字列にして返す</p>
<ul>
<li><del>3 を渡したら文字列”3”を返す</del></li>
</ul>
</li>
<li><p>5 の倍数のときは数を文字列にして返す</p>
<ul>
<li><del>5 を渡したら文字列”5”を返す</del></li>
</ul>
</li>
<li><p>3 と 5 両方の倍数の場合には｢FizzBuzz｣と返す</p>
<ul>
<li><del>15 を渡したら文字列”FizzBuzz”を返す</del></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="それ以外のタイプの場合"><a href="#それ以外のタイプの場合" class="headerlink" title="それ以外のタイプの場合"></a>それ以外のタイプの場合</h4><p>追加仕様には対応しましたがタイプ 1,2,3 以外の値が <strong>引数</strong> として渡された場合はどうしましょうか？ 現状では <code>nil</code> を返しますがこのような例外ケースも考慮する必要があります。</p>
<p>TODO リスト</p>
<ul>
<li><p><del>タイプ 1 の場合</del></p>
</li>
<li><p><del>タイプ 2 の場合</del></p>
</li>
<li><p><del>タイプ 3 の場合</del></p>
</li>
<li><p>それ以外のタイプの場合</p>
</li>
</ul>
<p><strong>例外処理</strong> を追加します。まず、例外のテストですが以下の様に書きます。</p>
<blockquote>
<p>例外とは記述したプログラムが想定していない値を受け取ったり、何らかの障害が発生した場合に処理を中断して、例外オブジェクトを生成して呼び出し元のメソッドに処理を戻す機構です。</p>
<p>— かんたん Ruby</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>例外を返す</span></span><br><span class="line">        e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">          @fizzbuzz.generate(<span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'該当するタイプは存在しません'</span>, e.message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> FAIL[<span class="string">"test_例外を返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x0000558a26888e60 @name="数を文字列にして返す::それ以外のタイプの場合"&gt;, 0.003033002998563461]</span></span><br><span class="line"> test_例外を返す<span class="comment">#数を文字列にして返す::それ以外のタイプの場合 (0.00s)</span></span><br><span class="line">        RuntimeError expected but nothing was raised.</span><br><span class="line">        /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:134:<span class="keyword">in</span> `test_例外を返す<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Finished in 0.00609s</span></span><br><span class="line"><span class="string">32 tests, 34 assertions, 1 failures, 0 errors, 0 skips</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p><strong>case 式</strong> に該当しないタイプが指定された場合は <strong>例外を発生させる</strong> ようにします。</p>
<blockquote>
<p>例外を明示的に発生させるには「raise」を使います。raise には発生させたい例外クラスを指定するのですが、何も指定しない場合は RuntimeError オブジェクトが生成されます。</p>
<p>— かんたん Ruby</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">generate</span><span class="params">(number, type = <span class="number">1</span>)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">07:04:53 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 16 / 16 LOC (100.0%) covered.</span><br><span class="line">Started with run options --guard --seed 32508</span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00600s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストが通ったのでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'test: それ以外のタイプの場合'</span></span><br></pre></td></tr></table></figure>

<p>TODO リスト</p>
<ul>
<li><p><em>タイプ 1 の場合</em></p>
</li>
<li><p><em>タイプ 2 の場合</em></p>
</li>
<li><p><em>タイプ 3 の場合</em></p>
</li>
<li><p><em>それ以外のタイプの場合</em></p>
</li>
</ul>
<p><strong>TODO リスト</strong><br>をすべて完了しました。追加仕様を満たすプログラムは出来ましたがまだ改善の余地がありそうですね。以降ではオブジェクト指向アプローチによるコードのリファクタリングを解説していきたいと思います。</p>
<h3 id="オブジェクト指向"><a href="#オブジェクト指向" class="headerlink" title="オブジェクト指向"></a>オブジェクト指向</h3><h4 id="手続き型プログラム"><a href="#手続き型プログラム" class="headerlink" title="手続き型プログラム"></a>手続き型プログラム</h4><p><strong>オブジェクト指向</strong> の解説の前に以下のコードを御覧ください。いわゆる <strong>手続き型</strong> で書かれたコードですが、これも追加仕様を満たしています。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">MAX_NUMBER = <span class="number">100</span></span><br><span class="line">type = <span class="number">1</span></span><br><span class="line">list = []</span><br><span class="line"></span><br><span class="line">MAX_NUMBER.times <span class="keyword">do</span> <span class="params">|i|</span></span><br><span class="line">  r = <span class="string">''</span></span><br><span class="line">  i += <span class="number">1</span></span><br><span class="line">  <span class="keyword">case</span> type</span><br><span class="line">  <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">0</span> &amp;&amp; i % <span class="number">5</span> == <span class="number">0</span></span><br><span class="line">      r = <span class="string">'FizzBuzz'</span></span><br><span class="line">    <span class="keyword">elsif</span> i % <span class="number">3</span> == <span class="number">0</span></span><br><span class="line">      r = <span class="string">'Fizz'</span></span><br><span class="line">    <span class="keyword">elsif</span> i % <span class="number">5</span> == <span class="number">0</span></span><br><span class="line">      r = <span class="string">'Buzz'</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      r = i.to_s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">    r = i.to_s</span><br><span class="line">  <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">0</span> &amp;&amp; i % <span class="number">5</span> == <span class="number">0</span></span><br><span class="line">      r = <span class="string">'FizzBuzz'</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      r = i.to_s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    r = <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  list.push(r)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">puts list</span><br></pre></td></tr></table></figure>

<p>処理の流れをフローチャートにしたものです、実態はコードに記述されている内容を記号に置き換えて人間が読めるようにしたものです。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/964a4749-a319-a323-5b6b-3e9cc31d72e4.png" alt="diag-c465147b957dba9fdfaa1a1196d29378.png"></p>
<h4 id="オブジェクト指向プログラム-1"><a href="#オブジェクト指向プログラム-1" class="headerlink" title="オブジェクト指向プログラム"></a>オブジェクト指向プログラム</h4><p>続いて、これまでに作ってきたコードがこちらになります。上記の <strong>手続き型コード</strong> との大きな違いとして <code>class</code> というキーワードでくくられている部分があります。</p>
<blockquote>
<p>クラスとは、大まかに説明すると何らかの値と処理（メソッド）をひとかたまりにしたものです。</p>
<p>— かんたん Ruby</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">generate</span><span class="params">(number, type = <span class="number">1</span>)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><a href="https://ja.wikipedia.org/wiki/%E7%B5%B1%E4%B8%80%E3%83%A2%E3%83%87%E3%83%AA%E3%83%B3%E3%82%B0%E8%A8%80%E8%AA%9E" target="_blank" rel="noopener">UML</a> を使って上記のコードの構造をクラス図として表現しました。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/beac3f11-f8c8-e8a5-7e09-ea0dda7e6693.png" alt="diag-c63943e73aed75ba31adf85779eaf481.png"></p>
<p>更にシーケンス図を使って上記のコードの振る舞いを表現しました。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/d4b24b58-1d0b-1ffe-f0ab-76968012a0f3.png" alt="diag-4cda3860e38bd75023756d182d6db0b7.png"></p>
<p><strong>手続き型コード</strong> のフローチャートと比べてどう思われましたか？具体的な記述が少なくデータや処理の概要だけを表現しているけど FizzBuzz のルールを知っている人であれば何をやろうとしているかのイメージはつかみやすいのではないでしょうか？だから何？と思われるかもしれませんが現時点では <strong>オブジェクト指向</strong> において <strong>抽象化</strong> がキーワードだという程度の認識で十分です。</p>
<p>オブジェクト指向の理解を深める取り掛かりにはこちらの記事を参照してください。</p>
<ul>
<li><a href="https://qiita.com/nrslib/items/73bf176147192c402049" target="_blank" rel="noopener">オブジェクト指向のいろは</a></li>
</ul>
<p>オブジェクト指向の詳細は控えるとして、ここでは <strong>カプセル化</strong> <strong>ポリモフィズム</strong> <strong>継承</strong> というオブジェクト指向プログラムで原則とされる概念をリファクタリングを通して体験してもらい、オブジェクト指向プログラムの感覚を掴んでもらうことを目的に解説を進めていきたいと思います。</p>
<h3 id="カプセル化"><a href="#カプセル化" class="headerlink" title="カプセル化"></a>カプセル化</h3><h4 id="フィールドのカプセル化"><a href="#フィールドのカプセル化" class="headerlink" title="フィールドのカプセル化"></a>フィールドのカプセル化</h4><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/beac3f11-f8c8-e8a5-7e09-ea0dda7e6693.png" alt="diag-c63943e73aed75ba31adf85779eaf481.png"></p>
<p>まず、データとロジックを１つのクラスにまとめていくためのリファクタリングを実施していくとします。<code>FizzBuzz</code> クラスに FizzBuzz 配列を保持できるようして以下のように取得できるようにしたいと思います。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">          fizzbuzz.generate_list</span><br><span class="line">          @result = fizzbuzz.list</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>まず、 <strong>インスタンス変数</strong> 追加します。次に <code>self</code> キーワードを外して <strong>クラスメソッド</strong> から <strong>インスタンスメソッド</strong> に変更します。</p>
<blockquote>
<p>クラスメソッドはいくつか定義方法がありますが、どの方法を使ってもクラスメソッドとして定義されれば「クラス名.メソッド名」という形で呼び出せます。</p>
<p>— かんたん Ruby</p>
</blockquote>
<blockquote>
<p>インスタンスメソッドはコンストラクタと同じようにクラス内で def キーワードを使ってメソッドを定義するだけで作成できます。</p>
<p>— かんたん Ruby</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">generate</span><span class="params">(number, type = <span class="number">1</span>)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">list</span></span></span><br><span class="line">    @list</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number, type = <span class="number">1</span>)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">ERROR[<span class="string">"test_15を渡したら文字列FizzBuzzを返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x00005613555ed120 @name="数を文字列にして返す::タイプ3の場合::三と五の倍数の場合"&gt;, 0.0041351839900016785]</span></span><br><span class="line"> test_15を渡したら文字列FizzBuzzを返す<span class="comment">#数を文字列にして返す::タイプ3の場合::三と五の倍数の場合 (0.00s)</span></span><br><span class="line">Minitest::UnexpectedError:         NoMethodError: undefined method `generate<span class="string">' for FizzBuzz:Class</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:117:in `test_15を渡したら文字列FizzBuzzを返す'</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>FizzBuzz 配列を <strong>インスタンス変数</strong> <code>@list</code> に <strong>代入</strong> して <strong>インスタンス変数</strong>経由で取得できるように変更しました。変更にあたり <strong>クラスメソッド</strong> <code>FizzBuzz.generate</code> と <code>FizzBuzz.generate_list</code> を <strong>インスタンスメソッド</strong> に変更しています。それに伴ってテストが失敗して <code>NoMethodError: undefined method `generate&#39;</code> と表示されるようになってしまいました。<strong>インスタンスメソッド</strong> が使えるようにするため　<code>new</code> メソッドを使って FizzBuzz クラスの <strong>インスタンス</strong> を作り FizzBuzz 配列を <strong>インスタンス変数</strong> 経由で取得するようにテストコードを変更します。</p>
<blockquote>
<p>クラスとして定義された情報を元に具体的な値を伴ったオブジェクトを作成することをインスタンス化と呼び、生成されたオブジェクトのことをインスタンスと呼びます。</p>
<p>— かんたん Ruby</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzz.new</span><br><span class="line">          fizzbuzz.generate_list</span><br><span class="line">          @result = fizzbuzz.list</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">07:17:36 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 5 / 17 LOC (29.41%) covered.</span><br><span class="line">Started with run options --guard --seed 7701</span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00616s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストが直りました。<strong>クラスメソッド</strong> <strong>インスタンスメソッド</strong> <strong>インスタンス変数</strong> <strong>インスタンス</strong> などいろんな単語が出てきて戸惑ってしまったかもしれませんが、ピンとこないうちは <strong>クラス</strong> に値や状態を保持させるためには <strong>インスタンス化</strong> する必要があってそのためには <code>new</code> メソッドを使わないといけないのね程度の理解で十分です。大概のことは手を動かしているうちにピンと来るようになります。</p>
<p><strong>インスタンス変数</strong> に直接アクセスしているのでここは <strong>アクセッサメソッド</strong> を使って <strong>フィールドのカプセル化</strong> を適用しておきます。</p>
<blockquote>
<p>オブジェクト指向ではクラス内の値をカプセル化することが重要ですが、時には内部で保持しているインスタンス変数を参照や更新できる方が良い場合もあります。複雑な処理ではなく、単にインスタンス変数にアクセスするためのメソッドのことを、アクセッサメソッドと呼びます。</p>
<p>— かんたん Ruby</p>
</blockquote>
<blockquote>
<p>フィールドのカプセル化</p>
<p>公開フィールドがある。</p>
<p>それを非公開にして、そのアクセサを用意する。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<p>自動実行の結果、以下のように書き換えられている部分を変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuz</span>、</span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">　<span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:list</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストが動作して既存のコードが壊れていないことが確認できたのでここでコミットします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: フィールドのカプセル化'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/38d2567b-295a-1db9-5878-e410bfb51d2a.png" alt="diag-102c44abf73ca5bda6fd8b87cc722ac9.png"></p>
<p>引き続き、FizzBuzz 配列は保持できるようになりましたがタイプごとに出力される配列のパターンは違います。FizzBuzz クラスにタイプを持たる必要があります。ここでは <strong>コンストラクタ</strong> を使って <strong>インスタンス化</strong> する際に <strong>インスタンス変数</strong> に <strong>代入</strong> するようにします。Ruby では <strong>initialize</strong> というメソッドを使って初期化処理を実行します。</p>
<blockquote>
<p>クラスをインスタンス化した時に初期化処理を行うシチュエーションはよくあります。このような初期化処理を行うメソッドをコンストラクタと呼び、Ruby では initialize という特別なメソッドを用意することで実現できます。</p>
<p>— かんたん Ruby</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:list</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ERROR[<span class="string">"test_3を渡したら文字列3を返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x00005564e21e85b0 @name="数を文字列にして返す::タイプ3の場合::三の倍数の場合"&gt;, 0.004276092993677594]</span></span><br><span class="line"> test_3を渡したら文字列3を返す<span class="comment">#数を文字列にして返す::タイプ3の場合::三の倍数の場合 (0.00s)</span></span><br><span class="line">Minitest::UnexpectedError:         ArgumentError: wrong number of arguments (given 0, expected 1)</span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:7:<span class="keyword">in</span> `initialize<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:101:in `new'</span></span><br><span class="line">            /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:101:<span class="keyword">in</span> `setup<span class="string">'</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>テストが失敗して引数が違うというエラーが表示される用になりました。<code>new</code> メソッドの <strong>引数</strong> にタイプを渡すようにテストを変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzz.new(<span class="number">1</span>)</span><br><span class="line">          fizzbuzz.generate_list</span><br><span class="line">          @result = fizzbuzz.list</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">3</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">4</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">07:28:38 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 6 / 19 LOC (31.58%) covered.</span><br><span class="line">Started with run options --guard --seed 46661</span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00793s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストは直りましたがまだ <strong>インスタンス変数</strong> のタイプが使われていないので使うようにプロダクトコードを変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:list</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number, _type = <span class="number">1</span>)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> @type</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>FizzBuzz.gnerate</code> メソッドの <strong>引数</strong> から <code>type</code> を削除します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:list</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ERROR[<span class="string">"test_15を渡したら文字列FizzBuzzを返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x0000564e16c14200 @name="数を文字列にして返す::タイプ3の場合::三と五の倍数の場合"&gt;, 0.01706391001062002]</span></span><br><span class="line"> test_15を渡したら文字列FizzBuzzを返す<span class="comment">#数を文字列にして返す::タイプ3の場合::三と五の倍数の場合 (0.02s)</span></span><br><span class="line">Minitest::UnexpectedError:         ArgumentError: wrong number of arguments (given 2, expected 1)</span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:11:<span class="keyword">in</span> `generate<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:118:in `test_15を渡したら文字列FizzBuzzを返す'</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>続いて、<code>FizzBuzz#generate</code> メソッドから不要になった <strong>引数</strong> <code>type</code><br>を削除したところテストが壊れたのでテストコードを修正します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">  ...</span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.generate(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.generate(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列15を返す</span></span><br><span class="line">          assert_equal <span class="string">'15'</span>, @fizzbuzz.generate(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.generate(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">3</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.generate(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.generate(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @fizzbuzz.generate(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.generate(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">4</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>例外を返す</span></span><br><span class="line">        e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">          @fizzbuzz.generate(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'該当するタイプは存在しません'</span>, e.message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">07:34:57 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 15 / 19 LOC (78.95%) covered.</span><br><span class="line">Started with run options --guard --seed 59116</span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00700s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>インスタンス変数</strong> の <code>@type</code> も <strong>アクセッサメソッド</strong> を使って <strong>フィールドのカプセル化</strong> を適用しておきます。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:list</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Started with run options --guard --seed 56315</span><br><span class="line"></span><br><span class="line">  32/32: [===========================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.01069s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>コミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: フィールドのカプセル化'</span></span><br></pre></td></tr></table></figure>

<h4 id="setter-の削除"><a href="#setter-の削除" class="headerlink" title="setter の削除"></a>setter の削除</h4><p>FizzBuzz 配列を取得する <strong>アクセッサメソッド</strong> は現在このように定義されています。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:type</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>以下のようにテストコードを変更したらどうなるでしょうか？</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzz.new(<span class="number">1</span>)</span><br><span class="line">          fizzbuzz.generate_list</span><br><span class="line">          @result = fizzbuzz.list</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzz.new(<span class="number">1</span>)</span><br><span class="line">          fizzbuzz.generate_list</span><br><span class="line">          fizzbuzz.list = []</span><br><span class="line">          @result = fizzbuzz.list</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> FAIL[<span class="string">"test_配列の2番目は文字列のFizzを返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x0000563c29a8a8c0 @name="数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す"&gt;, 0.005137628992088139]</span></span><br><span class="line"> test_配列の2番目は文字列のFizzを返す<span class="comment">#数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す (0.01s)</span></span><br><span class="line">        Expected: <span class="string">"Fizz"</span></span><br><span class="line">          Actual: nil</span><br><span class="line">        /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:58:<span class="keyword">in</span> `test_配列の2番目は文字列のFizzを返す<span class="string">'</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>FizzBuzz 配列が初期化されてしまいました。<strong>アクセッサメソッド</strong> に参照のための <strong>getter</strong> と 更新するための <strong>setter</strong> が許可されているため <strong>カプセル化</strong> が破られてしまいました。ここは <strong>setter の削除</strong> を適用して外部からの更新を出来ないようにしておきましょう。</p>
<blockquote>
<p>getter を定義するには、「attr_reader」を使います。このメソッドにインスタンス変数の「@」を除いた名称をシンボル表現にしたものを列挙します。複数ある場合はカンマで区切って複数の値を指定することができます。</p>
<p>— かんたん Ruby</p>
</blockquote>
<blockquote>
<p>setter を定義するには、「attr_writer」を使います。このメソッドも attr_reader と同じくインスタンス変数名の「@」を除いた名称をシンボル表現にしたものを列挙します。複数ある場合はカンマで区切って複数の値を指定することができます。</p>
<p>— かんたん Ruby</p>
</blockquote>
<blockquote>
<p>getter/setter の両方を定義する場合、そのインスタンスは属しているクラス外から自由に参照や更新ができてしまいます。これはカプセル化の観点には反した挙動なので、できる限り attr_reader だけで済ませられないか検討しましょう。</p>
<p>— かんたん Ruby</p>
</blockquote>
<blockquote>
<p>setter の削除</p>
<p>setter が用意されているということは、フィールドが変更される可能性があることを意味します。オブジェクトを生成した後でフィールドを変更したくないなら、setter は用意しません（加えて、フィールドを変更不可にします）。そうすることで、フィールドはコンストラクタでのみで設定され、変更させないという意図が明確になって、フィールドが変更される可能性を、たいていは排除できます。</p>
<p>— リファクタリング(第 2 版)</p>
</blockquote>
<p>Ruby では以下のようにして <strong>インスタンス変数</strong> を読み取り専用にします。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:type</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ERROR[<span class="string">"test_配列の2番目は文字列のFizzを返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x000055b32efd75f0 @name="数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す"&gt;, 0.008614362974185497]</span></span><br><span class="line"> test_配列の2番目は文字列のFizzを返す<span class="comment">#数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す (0.01s)</span></span><br><span class="line">Minitest::UnexpectedError:         NoMethodError: undefined method `list=<span class="string">' for #&lt;FizzBuzz:0x000055b32ee8c678&gt;</span></span><br><span class="line"><span class="string">        Did you mean?  list</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:45:in `setup'</span></span><br></pre></td></tr></table></figure>

<p>更新メソッドは存在しませんというエラーに変わったことが確認できたのでテストを元にもどします。</p>
<p>同様に <strong>インスタンス変数</strong> の <code>@type</code> も読み取り専用にします。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">04:32:06 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 22 / 22 LOC (100.0%) covered.</span><br><span class="line">Started with run options --guard --seed 20902</span><br><span class="line"></span><br><span class="line">  32/32: [===========================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00920s</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストが壊れていないことを確認したらコミットします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: setterの削除'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/ee9e4f7d-6d39-04a5-e8fe-3308d7c510d8.png" alt="diag-a8b45c800de2a31873f9eba1feac2184.png"></p>
<h3 id="ポリモーフィズム"><a href="#ポリモーフィズム" class="headerlink" title="ポリモーフィズム"></a>ポリモーフィズム</h3><h4 id="ポリモーフィズムによる条件記述の置き換え-1"><a href="#ポリモーフィズムによる条件記述の置き換え-1" class="headerlink" title="ポリモーフィズムによる条件記述の置き換え 1"></a>ポリモーフィズムによる条件記述の置き換え 1</h4><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/ee9e4f7d-6d39-04a5-e8fe-3308d7c510d8.png" alt="diag-a8b45c800de2a31873f9eba1feac2184.png"></p>
<p>リファクタリングによりデータとロジックを１つのクラスにまとめて <strong>カプセル化</strong> を進めることが出来ました。しかし、以下の警告メッセージが表示されたままです。<strong>ポリモーフィズム</strong> を使ったロジックのリファクタリングを実施していきましょう。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">07:53:29 - INFO - Inspecting Ruby code style: <span class="built_in">test</span>/fizz_buzz_test.rb lib/fizz_buzz.rb</span><br><span class="line">lib/fizz_buzz.rb:11:3: C: Metrics/CyclomaticComplexity: Cyclomatic complexity <span class="keyword">for</span> generate is too high. [10/8]</span><br><span class="line">  def generate(number) ...</span><br><span class="line">  ^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">lib/fizz_buzz.rb:11:3: C: Metrics/PerceivedComplexity: Perceived complexity <span class="keyword">for</span> generate is too high. [8/7]</span><br><span class="line">  def generate(number) ...</span><br><span class="line">  ^^^^^^^^^^^^^^^^^^^^</span><br><span class="line"> 2/2 files |====================================== 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">2 files inspected, 2 offenses detected</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><a href="https://ja.wikipedia.org/wiki/%E5%BE%AA%E7%92%B0%E7%9A%84%E8%A4%87%E9%9B%91%E5%BA%A6" target="_blank" rel="noopener">循環的複雑度</a> が高く可読性が低く複雑なコードと警告されているようです。対象となっている　<code>FizzBuzz#generate</code> を確認してみましょう。</p>
<ul>
<li><p><a href="https://rubocop.readthedocs.io/en/latest/cops_metrics/#metricscyclomaticcomplexity" target="_blank" rel="noopener">Metrics/CyclomaticComplexity</a></p>
</li>
<li><p><a href="https://rubocop.readthedocs.io/en/latest/cops_metrics/#metricsperceivedcomplexity" target="_blank" rel="noopener">Metrics/PerceivedComplexity</a></p>
</li>
</ul>
<!-- end list -->

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> @type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>コードの不吉な臭いである <strong>スイッチ文</strong> に該当するコードのようなのでここはリファクタリングカタログに従って <strong>ポリモーフィズムによる条件記述の置き換え</strong> を適用していきましょう。比較的大きなリファクタリングなのでいくつかのステップに分けて進めていきます。</p>
<blockquote>
<p>スイッチ文</p>
<p>オブジェクト指向プログラミングのメリットして、スイッチ文が従来にくらべて少なくなるということがあります。スイッチ文は重複したコードを生み出す問題児です。コードのあちらこちらに同じようなスイッチ文が見られることがあります。これでは新たな分岐を追加したときに、すべてのスイッチ文を探して似たような変更をしていかなければなりません。オブジェクト指向ではポリモーフィズムを使い、この問題をエレガントに解決できます。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<blockquote>
<p>重複したスイッチ文</p>
<p>最近はポリモーフィズムも一般的となり、15 年前に比べると switch 文が単純に赤信号というわけでもなくなりました。また、多くのプログラミング言語が、基本データ型以外をサポートする、より洗練された switch 文を提供してきています。そこで、今後問題とするのは、重複した switch 文のみとします。switch/case 文や、ネストした if/else 文の形で、コードのさまざまな箇所に同じ条件分岐ロジックが書かれていれば、それは「不吉な臭い」です。重複した条件分岐が問題なのは、新たな分岐を追加したら、すべての重複した条件分岐を探して更新指定かなけれけならないからです。ポリモーフィズムは、そうした単調な繰り返しに誘うダークフォースに対抗するための、洗練された武器です。コードベースをよりモダンにしていきましょう。</p>
<p>— リファクタリング(第 2 版)</p>
</blockquote>
<blockquote>
<p>ポリモーフィズムによる条件記述の置き換え</p>
<p>オブジェクトのタイプによって異なる振る舞いを選択する条件記述がある。</p>
<p>条件記述の各アクション部をサブクラスでオーバーライドするメソッドに移動する。元のメソッドは abstract にする。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span>;</span> <span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span>;</span> <span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span>;</span> <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>まず、タイプごとのクラスを定義します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">create</span><span class="params">(type)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      FizzBuzzType01.new</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      FizzBuzzType02.new</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      FizzBuzzType03.new</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>次に、タイプごとのクラスを <strong>インスタンス化</strong> する <strong>ファクトリメソッド</strong> を FizzBuzz クラスに追加します。この時点では新しいクラスとメソッドの追加だけなのでテストは壊れていないはずです（警告は出ていますが・・・）。ここでコミットしておきますがリファクタリング作業としては <a href="https://ja.wikipedia.org/wiki/%E4%BB%95%E6%8E%9B%E5%93%81" target="_blank" rel="noopener">仕掛</a> なので WIP(Work In Progress)をメッセージに追加してコミットします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor(WIP): ポリモーフィズムによる条件記述の置き換え'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/abe9acc4-11e7-a82a-f236-87753512f82e.png" alt="diag-c83e15398192d4cb68c948dfda55870b.png"></p>
<h4 id="ポリモーフィズムによる条件記述の置き換え-2"><a href="#ポリモーフィズムによる条件記述の置き換え-2" class="headerlink" title="ポリモーフィズムによる条件記述の置き換え 2"></a>ポリモーフィズムによる条件記述の置き換え 2</h4><p>続いて、各タイプクラスに <strong>インスタンスメソッド</strong> を実装します。ここでは <strong>case 式</strong> の各処理をコピー&amp;ペーストしています。カット&amp;ペーストするとプロダクトコードが壊れたままリファクタリングを進めることになるのでここは慎重に進めていきます。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span>;</span> <span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span>;</span> <span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span>;</span> <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>警告は出ますがテストは壊れていないのでコミットします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor(WIP): ポリモーフィズムによる条件記述の置き換え'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/87bc8d77-c195-852c-e517-86272f494ab7.png" alt="diag-c9ffad9b803420dabdb72a8eaf15cb72.png"></p>
<h4 id="ポリモーフィズムによる条件記述の置き換え-3"><a href="#ポリモーフィズムによる条件記述の置き換え-3" class="headerlink" title="ポリモーフィズムによる条件記述の置き換え 3"></a>ポリモーフィズムによる条件記述の置き換え 3</h4><p>これで準備は整いましたのでテストコードの <code>setup</code> メソッドを <strong>ファクトリメソッド</strong> の呼び出しに変更します。以下の部分は変更してはいけません。理由はわかりますか？</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzz.new(<span class="number">1</span>)</span><br><span class="line">          fizzbuzz.generate_list</span><br><span class="line">          @result = fizzbuzz.list</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.create(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.create(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.create(<span class="number">3</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.create(<span class="number">4</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>例外を返す</span></span><br><span class="line">        e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">          @fizzbuzz.generate(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'該当するタイプは存在しません'</span>, e.message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">08:14:14 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 26 / 42 LOC (61.9%) covered.</span><br><span class="line">Started with run options --guard --seed 37585</span><br><span class="line"></span><br><span class="line">ERROR[<span class="string">"test_例外を返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x000056317940fa28 @name="数を文字列にして返す::それ以外のタイプの場合"&gt;, 0.0037079370085848495]</span></span><br><span class="line"> test_例外を返す<span class="comment">#数を文字列にして返す::それ以外のタイプの場合 (0.00s)</span></span><br><span class="line">Minitest::UnexpectedError:         RuntimeError: 該当するタイプは存在しません</span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:20:<span class="keyword">in</span> `create<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:132:in `setup'</span></span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00685s</span><br><span class="line">32 tests, 33 assertions, 0 failures, 1 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>失敗するテストがありますね、該当するコードを確認したところ例外が発生するタイミングが変わってしまったので以下のように変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.create(<span class="number">4</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>例外を返す</span></span><br><span class="line">        e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">          @fizzbuzz.generate(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'該当するタイプは存在しません'</span>, e.message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>例外を返す</span></span><br><span class="line">        e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">          FizzBuzz.create(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'該当するタイプは存在しません'</span>, e.message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">08:18:08 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 37 / 42 LOC (88.1%) covered.</span><br><span class="line">Started with run options --guard --seed 40171</span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00559s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>コミットしておきましょう。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor(WIP): ポリモーフィズムによる条件記述の置き換え'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/1048a22a-49cd-7f28-f688-69a62e61c5a9.png" alt="diag-852794d6dd3e17ad001905a500b520e3.png"></p>
<h4 id="ポリモーフィズムによる条件記述の置き換え-4"><a href="#ポリモーフィズムによる条件記述の置き換え-4" class="headerlink" title="ポリモーフィズムによる条件記述の置き換え 4"></a>ポリモーフィズムによる条件記述の置き換え 4</h4><p>タイプごとに FizzBuzz を生成するクラスを用意したので FizzBuzz クラスから呼び出せるようにしましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>まず、<strong>コンストラクタ</strong> から <strong>クラスメソッド</strong> の <strong>ファクトリメソッド</strong> を呼び出して <strong>インスタンス変数</strong> の <code>type</code> にタイプクラスの <strong>参照</strong> を <strong>代入</strong> します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = FizzBuzz.create(type)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ERROR[<span class="string">"test_配列の14番目は文字列のFizzBuzzを返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x000055670a343110 @name="数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す"&gt;, 0.006740843993611634]</span></span><br><span class="line"> test_配列の14番目は文字列のFizzBuzzを返す<span class="comment">#数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す (0.01s)</span></span><br><span class="line">Minitest::UnexpectedError:         RuntimeError: 該当するタイプは存在しません</span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:42:<span class="keyword">in</span> `generate<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/lib/fizz_buzz.rb:48:in `block in generate_list'</span></span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:48:<span class="keyword">in</span> `each<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/lib/fizz_buzz.rb:48:in `map'</span></span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:48:<span class="keyword">in</span> `generate_list<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:44:in `setup'</span></span><br></pre></td></tr></table></figure>

<p>テストが失敗して沢山エラーが表示するようになりましたが落ち着いてください。次に <strong>インスタンスメソッド</strong> <code>FizzBuzz#generate_list</code> 内の <code>FizzBuzz#generate</code> メソッド呼び出しを <strong>インスタンス変数</strong> <code>type</code> が参照するタイプクラスのメソッド <code>FizzBuzzTypeXX#generate</code> を呼び出すように変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = FizzBuzz.create(type)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> @type.generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Started with run options --seed 13878</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Progress: |=====================================================================================================|</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00960s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">05:54:49 - INFO - Inspecting Ruby code style: lib/fizz_buzz.rb</span><br><span class="line">lib/fizz_buzz.rb:24:3: C: Metrics/CyclomaticComplexity: Cyclomatic complexity <span class="keyword">for</span> generate is too high. [10/8]</span><br><span class="line">  def generate(number) ...</span><br><span class="line">  ^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">lib/fizz_buzz.rb:24:3: C: Metrics/PerceivedComplexity: Perceived complexity <span class="keyword">for</span> generate is too high. [8/7]</span><br><span class="line">  def generate(number) ...</span><br><span class="line">  ^^^^^^^^^^^^^^^^^^^^</span><br><span class="line"> 1/1 file |======================================= 100 ========================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">1 file inspected, 2 offenses detected</span><br></pre></td></tr></table></figure>

<p>再びテストが通るようになりました。始めのうちはコードを少し変更しただけでなんで動くようになったの？と思うかもしれませんがこれが <strong>ポリモーフィズム</strong> の威力です。この概念を感覚としてつかんで使いこなせるようになることがオブジェクト指向プログラミングの第一歩です。感覚は意識して手を動かしていればそのうちつかめます（多分）。</p>
<p><strong>ポリモーフィズムによる条件記述の置き換え</strong> が完了したので WIP を外してコミットします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor ポリモーフィズムによる条件記述の置き換え'</span></span><br></pre></td></tr></table></figure>

<h4 id="State-Strategy-によるタイプコードの置き換え"><a href="#State-Strategy-によるタイプコードの置き換え" class="headerlink" title="State/Strategy によるタイプコードの置き換え"></a>State/Strategy によるタイプコードの置き換え</h4><p>仕上げは　<strong>State/Strategy によるタイプコードの置き換え</strong> を適用して、警告メッセージを消すとしましょう。</p>
<blockquote>
<p>State/Strategy によるタイプコードの置き換え</p>
<p>クラスの振る舞いに影響するタイプコードがあるが、サブクラス化はできない。</p>
<p>状態オブジェクトでタイプコードを置き換える</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/1048a22a-49cd-7f28-f688-69a62e61c5a9.png" alt="diag-852794d6dd3e17ad001905a500b520e3.png"></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = FizzBuzz.create(type)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">create</span><span class="params">(type)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      FizzBuzzType01.new</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      FizzBuzzType02.new</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      FizzBuzzType03.new</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> @type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line"></span><br><span class="line">      number.to_s</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> @type.generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>まず、<code>FizzBuzz#generate</code> のメソッド呼び出しを <strong>インスタンス変数</strong> <code>type</code> が参照するタイプクラスのメソッド <code>FizzBuzzTypeXX#generate</code> に <strong>委譲</strong> するように変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    @type.generate(number)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> @type.generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Started with run options --seed 49543</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Progress: |=====================================================================================================|</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00925s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">06:34:27 - INFO - Inspecting Ruby code style: lib/fizz_buzz.rb</span><br><span class="line"> 1/1 file |======================================= 100 ========================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">1 file inspected, no offenses detected</span><br><span class="line">06:34:29 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/loading_background.png coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/border.png</span><br><span class="line"> 0/0 files |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">0 files inspected, no offenses detecte</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>警告が消えました。しかもテストは壊れていないようです。実は <code>FizzBuzz#generate</code> メソッドはどこからも使われていないためテストも壊れることが無いのですがこれでは不要なメソッドになってしまうので <strong>移譲の隠蔽</strong> を実施して、ロジックを <strong>カプセル化</strong> します。</p>
<blockquote>
<p>委譲の隠蔽</p>
<p>オブジェクト指向について最初に教わる時、カプセル化とはフィールドを隠すことだと習うでしょう。しかし経験を積むにつれて、他にもカプセル化できるものがあることに気づきます。</p>
<p>— リファクタリング(第 2 版)</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    @type.generate(number)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストも FizzBuzz インスタンス経由で実行するように修正しておきます。これですべての呼び出しが <code>new</code> メソッド経由となりテストコードに一貫性を取り戻すことが出来ました。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzz.new(<span class="number">1</span>)</span><br><span class="line">          fizzbuzz.generate_list</span><br><span class="line">          @result = fizzbuzz.list</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">3</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>例外を返す</span></span><br><span class="line">        e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">          FizzBuzz.new(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'該当するタイプは存在しません'</span>, e.message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">08:32:17 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 32 / 32 LOC (100.0%) covered.</span><br><span class="line">Started with run options --guard --seed 63863</span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00564s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line"></span><br><span class="line">08:32:18 - INFO - Inspecting Ruby code style of all files</span><br><span class="line"> 7/7 files |====================================== 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">7 files inspected, no offenses detected</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>ポリモーフィズム</strong> の感覚がつかめないうちは <code>FizzBuzz#generate</code> のコードが一行になったのに既存のテストも壊れず動いていることが不思議に思うかもしれません。しかしコードとしては FizzBuzz クラスの <code>generate</code> メソッドは任意のタイプクラスの <code>generate</code> メソッドを呼び出しているだけで処理の詳細は理解しなくても振る舞いを理解できる <strong>抽象化</strong> された読みやすいコードになりました。静的コード解析も可読性が高くシンプルなコードとみなしてくれているようです。さて、警告メッセージもなくなり、テストも壊れていないのでコミットしておきましょう。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: State/Strategyによるタイプコードの置き換え'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/1048a22a-49cd-7f28-f688-69a62e61c5a9.png" alt="diag-852794d6dd3e17ad001905a500b520e3.png"></p>
<h3 id="継承"><a href="#継承" class="headerlink" title="継承"></a>継承</h3><p>分割したタイプクラスのメソッドに重複する処理があるので <strong>継承</strong> を使ってリファクタリングしましょう。ここでは <strong>スーパークラスの抽出</strong>を適用します。</p>
<blockquote>
<p>スーパークラスの抽出</p>
<p>似通った特性を持つ２つのクラスがある。</p>
<p>スーパークラスを作成して、共通の特性を移動する。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<h4 id="スーパークラスの抽出"><a href="#スーパークラスの抽出" class="headerlink" title="スーパークラスの抽出"></a>スーパークラスの抽出</h4><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/1048a22a-49cd-7f28-f688-69a62e61c5a9.png" alt="diag-852794d6dd3e17ad001905a500b520e3.png"></p>
<p>まずは、タイプクラスのスーパークラスとなる <code>FizzBuzzType</code> クラスを作成して各タイプクラスに継承させます。</p>
<blockquote>
<p>クラスベースのオブジェクト指向言語の多くはクラスの継承機能を有しています。クラスの継承とはあるクラスを元として、新しいクラスを定義することです。この時、継承元となるクラスを親クラスやスーパークラスと呼び、継承したクラスのことを子クラスやサブクラスと呼びます。</p>
<p>— かんたん Ruby</p>
</blockquote>
<p>Ruby の <strong>クラスの継承</strong> は以下のように書きます。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span>;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span>;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span> &lt; FizzBuzzType</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span> &lt; FizzBuzzType</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span> &lt; FizzBuzzType</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>スーパークラス <code>FizzBuzzType</code> を定義して各サブクラスに継承させます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">08:42:24 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 33 / 33 LOC (100.0%) covered.</span><br><span class="line">Started with run options --guard --seed 43548</span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00860s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line"></span><br><span class="line">08:42:25 - INFO - Inspecting Ruby code style of all files</span><br><span class="line"> 7/7 files |====================================== 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">7 files inspected, no offenses detected</span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/9e68539c-0b82-d0b7-3ede-4f6892399abf.png" alt="diag-df749de89e01204bc0eab92419515a4c.png"></p>
<p>次に <code>is_fizz</code> <code>is_buzz</code> 部分を共通メソッドとしてスーパークラスに定義して各タイプクラスで呼び出すように変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span>;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    is_fizz = number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">    is_buzz = number.modulo(<span class="number">5</span>).zero?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz &amp;&amp; is_buzz</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_fizz</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_buzz</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">5</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz(number) &amp;&amp; is_buzz(number)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz(number)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz(number)</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz(number) &amp;&amp; is_buzz(number)</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">08:50:16 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 33 / 33 LOC (100.0%) covered.</span><br><span class="line">Started with run options --guard --seed 45685</span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.01073s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line"></span><br><span class="line">08:50:17 - INFO - Inspecting Ruby code style of all files</span><br><span class="line">lib/fizz_buzz.rb:35:7: C: Naming/PredicateName: Rename is_fizz to fizz?.</span><br><span class="line">  def is_fizz(number)</span><br><span class="line">      ^^^^^^^</span><br><span class="line">lib/fizz_buzz.rb:39:7: C: Naming/PredicateName: Rename is_buzz to buzz?.</span><br><span class="line">  def is_buzz(number)</span><br><span class="line">      ^^^^^^^</span><br><span class="line"> 7/7 files |====================================== 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">7 files inspected, 2 offenses detected</span><br></pre></td></tr></table></figure>

<p>テストが壊れていないことが確認できたのでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: スーパークラスの抽出'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/ee6b125d-dc1f-3069-5f0c-c698ffe251be.png" alt="diag-119864cf3ef287a3cb00d3a5ae7f7768.png"></p>
<h4 id="メソッド名の変更"><a href="#メソッド名の変更" class="headerlink" title="メソッド名の変更"></a>メソッド名の変更</h4><p><strong>スーパークラスの抽出</strong> を実施したところまた警告メッセージが表示されるようになりました。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">08:50:19 - INFO - Inspecting Ruby code styl</span><br><span class="line">e: coverage/assets/0.10.2/colorbox/loading_background.png coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/border.png lib/fizz_buzz.rb</span><br><span class="line">lib/fizz_buzz.rb:35:7: C: Naming/PredicateName: Rename is_fizz to fizz?.</span><br><span class="line">  def is_fizz(number)</span><br><span class="line">      ^^^^^^^</span><br><span class="line">lib/fizz_buzz.rb:39:7: C: Naming/PredicateName: Rename is_buzz to buzz?.</span><br><span class="line">  def is_buzz(number)</span><br><span class="line">      ^^^^^^^</span><br><span class="line"> 1/1 file |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">1 file inspected, 2 offenses detected</span><br></pre></td></tr></table></figure>

<p><a href="https://rubocop.readthedocs.io/en/latest/cops_naming/#namingpredicatename" target="_blank" rel="noopener">Naming/PredicateName</a> Ruby の  ネーミングとしてはよろしくないようなので指示に従って <strong>メソッド名の変更</strong> を実施しましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_fizz</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_buzz</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">5</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz(number) &amp;&amp; is_buzz(number)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> is_fizz(number)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> is_buzz(number)</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> is_fizz(number) &amp;&amp; is_buzz(number)</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">fizz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">buzz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">5</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> fizz?(number) &amp;&amp; buzz?(number)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> fizz?(number)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> buzz?(number)</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> fizz?(number) &amp;&amp; buzz?(number)</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Progress: |====================================================================================================|</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.01144s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">08:53:35 - INFO - Inspecting Ruby code style: lib/fizz_buzz.rb</span><br><span class="line"> 1/1 file |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">1 file inspected, no offenses detected</span><br></pre></td></tr></table></figure>

<p>作業としては難しくないのでミスタイプしないように（まあ、ミスタイプしてもテストが教えてくれますが・・・）変更してコミットしましょう。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: メソッド名の変更'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/431fe33d-a0fc-669b-e26d-ec514e9959b5.png" alt="diag-f06a12d01484b03fa6f2f85b062a3cf0.png"></p>
<h4 id="メソッドの移動"><a href="#メソッドの移動" class="headerlink" title="メソッドの移動"></a>メソッドの移動</h4><p><code>FizzBuzz</code> クラスの <strong>ファクトリメソッド</strong> ですが <strong>特性の横恋慕</strong> の臭いがするので <strong>メソッドの移動</strong> を実施します。</p>
<blockquote>
<p>特性の横恋慕</p>
<p>オブジェクト指向には、処理および処理に必要なデータを１つにまとめてしまうという重要な考え方があります。あるメソッドが、自分のクラスより他のクラスに興味を持つような場合には、古典的な誤りを犯しています。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<blockquote>
<p>メソッドの移動</p>
<p>あるクラスでメソッドが定義されているが、現在または将来において、そのクラスの特性よりも他のクラスの特性の方が、そのメソッドを使ったり、そのメソッドから使われたりすることが多い。</p>
<p>同様の本体を持つ新たなメソッドを、それを最も多用するクラスに作成する。元のメソッドは、単純な委譲とするか、またはまるごと取り除く。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = FizzBuzz.create(type)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">create</span><span class="params">(type)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      FizzBuzzType01.new</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      FizzBuzzType02.new</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      FizzBuzzType03.new</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    @type.generate(number)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">fizz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">buzz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">5</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>クラスメソッド</strong> <code>FizzBuzz.create</code> をカット&amp;ペーストして <code>FizzBuzzType.create</code> に移動します。 <code>FizzBuzz</code> の <strong>コンストラクタ</strong> で呼び出している <strong>クラスメソッド</strong> を <code>FizzBuzzType.create</code> に変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = FizzBuzzType.create(type)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    @type.generate(number)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">create</span><span class="params">(type)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      FizzBuzzType01.new</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      FizzBuzzType02.new</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      FizzBuzzType03.new</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">fizz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">buzz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">5</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">08:59:27 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 33 / 33 LOC (100.0%) covered.</span><br><span class="line">Started with run options --guard --seed 19583</span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00688s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line"></span><br><span class="line">08:59:28 - INFO - Inspecting Ruby code style of all files</span><br><span class="line"> 7/7 files |====================================== 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">7 files inspected, no offenses detected</span><br></pre></td></tr></table></figure>

<p>テストが壊れていないことを確認したらコミットします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: メソッドの移動'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/f90701c2-c6d1-2ee1-b290-531bef33f282.png" alt="diag-c24dbdafdc4766204e9b3fba9938dbba.png"></p>
<h3 id="値オブジェクト"><a href="#値オブジェクト" class="headerlink" title="値オブジェクト"></a>値オブジェクト</h3><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/f90701c2-c6d1-2ee1-b290-531bef33f282.png" alt="diag-c24dbdafdc4766204e9b3fba9938dbba.png"></p>
<h4 id="オブジェクトによるプリミティブの置き換え"><a href="#オブジェクトによるプリミティブの置き換え" class="headerlink" title="オブジェクトによるプリミティブの置き換え"></a>オブジェクトによるプリミティブの置き換え</h4><p><code>FizzBuzz</code> クラスを <strong>インスタンス化</strong> するには以下のように書きます。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fizz_buzz = FizzBuzz.new(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>クラスとして定義された情報を元に具体的な値を伴ったオブジェクトを作成することをインスタンス化と呼び、生成されたオブジェクトのことをインスタンスと呼びます。</p>
<p>— かんたん Ruby</p>
</blockquote>
<p><strong>コンストラクタ</strong> の <strong>引数</strong> に渡される <code>1</code> は何を表しているのでしょうか？もちろんタイプですが初めてこのコードを見る人にはわからないでしょう。このような整数、浮動小数点、文字列などの基本データ（プリミティブ）型の使い方からは  <strong>基本データ型への執着</strong>の臭いがします。 <strong>オブジェクトによるプリミティブの置き換え</strong> を実施してコードの意図を明確にしましょう。</p>
<blockquote>
<p>基本データ型への執着</p>
<p>オブジェクト指向のメリットとして、基本データ型とそれより大きなクラスとの境界を取り除くということがあります。プログラミング言語の組み込み（built-in）型と区別できないような小さなクラスを自分で定義することが容易です。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<blockquote>
<p>基本データ型への執着</p>
<p>興味深いことに、多くのプログラマは、対象としているドメインに役立つ、貨幣、座標、範囲などの基本的な型を導入するのを嫌がる傾向があります。</p>
<p>— リファクタリング(第 2 版)</p>
</blockquote>
<blockquote>
<p>オブジェクトによるデータ値の置き換え</p>
<p>追加のデータや振る舞いが必要なデータ項目がある。</p>
<p>そのデータ項目をオブジェクトに変える。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<blockquote>
<p>オブジェクトによるプリミティブの置き換え</p>
<p>旧：オブジェクトによるデータ値の置き換え</p>
<p>旧：クラスによるタイプコードの置き換え</p>
<p>— リファクタリング(第 2 版)</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = FizzBuzzType.create(type)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>コンストラクタ</strong> で引き渡されるタイプは整数ではなくタイプクラスの <strong>インスタンス</strong> に変更します。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">ERROR[<span class="string">"test_1を渡したら文字列1を返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x00005654f32602c0 @name="数を文字列にして返す::タイプ3の場合::その他の場合"&gt;, 0.00241121300496161]</span></span><br><span class="line"> test_1を渡したら文字列1を返す<span class="comment">#数を文字列にして返す::タイプ3の場合::その他の場合 (0.00s)</span></span><br><span class="line">Minitest::UnexpectedError:         NoMethodError: undefined method `generate<span class="string">' for 3:Integer</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/lib/fizz_buzz.rb:12:in `generate'</span></span><br><span class="line">            /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:125:<span class="keyword">in</span> `test_1を渡したら文字列1を返す<span class="string">'</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>テストが失敗しました。 <strong>コンストラクタ</strong> の引数を整数からタイプクラスの <strong>インスタンス</strong> に変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzz.new(<span class="number">1</span>)</span><br><span class="line">          fizzbuzz.generate_list</span><br><span class="line">          @result = fizzbuzz.list</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(<span class="number">3</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>例外を返す</span></span><br><span class="line">        e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">          FizzBuzz.new(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'該当するタイプは存在しません'</span>, e.message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>ここで注意するのは <code>それ以外のタイプの場合</code> ですが例外を投げなくなります。静的に型付けされた言語なら型チェックエラーになるのですが Ruby は動的に型付けされる言語のため <code>FizzBuzz#generate</code> メソッド実行までエラーになりません。そこで例外を投げる <code>FizzBuzzType#create</code> メソッドに変更しておきます。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(FizzBuzzType01.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzz.new(FizzBuzzType01.new)</span><br><span class="line">          fizzbuzz.generate_list</span><br><span class="line">          @result = fizzbuzz.list</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(FizzBuzzType02.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(FizzBuzzType03.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>例外を返す</span></span><br><span class="line">        e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">          FizzBuzzType.create(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'該当するタイプは存在しません'</span>, e.message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>それ以外のタイプの場合は <strong>ファクトリメソッド</strong> 経由でないと <strong>例外</strong> を出さなくなるので注意してください。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">09:09:40 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 30 / 33 LOC (90.91%) covered.</span><br><span class="line">Started with run options --guard --seed 17452</span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00687s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br></pre></td></tr></table></figure>

<p>初めてコードを見る人でもテストコードを見ればコードの意図が読み取れるようになりましたのでコミットします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: オブジェクトによるプリミティブの置き換え'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/f90701c2-c6d1-2ee1-b290-531bef33f282.png" alt="diag-c24dbdafdc4766204e9b3fba9938dbba.png"></p>
<h4 id="マジックナンバーの置き換え"><a href="#マジックナンバーの置き換え" class="headerlink" title="マジックナンバーの置き換え"></a>マジックナンバーの置き換え</h4><p>まだプリミティグ型を使っている部分があります。ここは <strong>マジックナンバーの置き換え</strong> を実施して可読性を上げておきましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">create</span><span class="params">(type)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span></span><br><span class="line">      FizzBuzzType01.new</span><br><span class="line">    <span class="keyword">when</span> <span class="number">2</span></span><br><span class="line">      FizzBuzzType02.new</span><br><span class="line">    <span class="keyword">when</span> <span class="number">3</span></span><br><span class="line">      FizzBuzzType03.new</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"> <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">  TYPE_01 = <span class="number">1</span></span><br><span class="line">  TYPE_02 = <span class="number">2</span></span><br><span class="line">  TYPE_03 = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">create</span><span class="params">(type)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_01</span><br><span class="line">      FizzBuzzType01.new</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_02</span><br><span class="line">      FizzBuzzType02.new</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_03</span><br><span class="line">      FizzBuzzType03.new</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">09:18:51 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 33 / 36 LOC (91.67%) covered.</span><br><span class="line">Started with run options --guard --seed 41124</span><br><span class="line"></span><br><span class="line">  32/32: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00909s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br></pre></td></tr></table></figure>

<p>テストは壊れていないのでコミットします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: マジックナンバーの置き換え'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/055ea1c9-54db-543f-9e1d-b0fdfedc2fef.png" alt="diag-be7c345eb3b4de2cc3b4530da0d96f5d.png"></p>
<h4 id="オブジェクトによるプリミティブの置き換え-1"><a href="#オブジェクトによるプリミティブの置き換え-1" class="headerlink" title="オブジェクトによるプリミティブの置き換え"></a>オブジェクトによるプリミティブの置き換え</h4><p>次に <strong>基本データ型への執着</strong> の臭いがする箇所として <code>FizzBuzz#generate</code> メソッドが返す FizzBuzz の値が文字型である点です。文字列の代わりに <strong>値オブジェクト</strong> <code>FizzBuzzValue</code> クラスを定義します。</p>
<blockquote>
<p>値の種類ごとに専用の型を用意するとコードが安定し、コードの意図が明確になります。このように、値を扱うための専用クラスを作るやり方を値オブジェクト（ValueObject）と呼びます。</p>
<p>— 現場で役立つシステム設計の原則</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValue</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:number</span>, <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(number, value)</span></span></span><br><span class="line">    @number = number</span><br><span class="line">    @value = value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">to_s</span></span></span><br><span class="line">    <span class="string">"<span class="subst">#&#123;@number&#125;</span>:<span class="subst">#&#123;@value&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">==</span><span class="params">(other)</span></span></span><br><span class="line">    @number == other.number &amp;&amp; @value == other.value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">alias</span> eql? ==</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>各タイプクラスの <code>generate</code> メソッドが文字列のプリミティブ型を返しているので <strong>値オブジェクト</strong> <code>FizzBuzzValue</code> を返すように変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> fizz?(number) &amp;&amp; buzz?(number)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Fizz'</span> <span class="keyword">if</span> fizz?(number)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Buzz'</span> <span class="keyword">if</span> buzz?(number)</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FizzBuzz'</span> <span class="keyword">if</span> fizz?(number) &amp;&amp; buzz?(number)</span><br><span class="line"></span><br><span class="line">    number.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'FizzBuzz'</span>) <span class="keyword">if</span> fizz?(number) &amp;&amp; buzz?(number)</span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'Fizz'</span>) <span class="keyword">if</span> fizz?(number)</span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'Buzz'</span>) <span class="keyword">if</span> buzz?(number)</span><br><span class="line"></span><br><span class="line">    FizzBuzzValue.new(number, number.to_s)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    FizzBuzzValue.new(number, number.to_s)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'FizzBuzz'</span>) <span class="keyword">if</span> fizz?(number) &amp;&amp; buzz?(number)</span><br><span class="line"></span><br><span class="line">    FizzBuzzValue.new(number, number.to_s)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> FAIL[<span class="string">"test_配列の2番目は文字列のFizzを返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x000055feccc65ab8 @name="数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す"&gt;, 0.012104410998290405]</span></span><br><span class="line"> test_配列の2番目は文字列のFizzを返す<span class="comment">#数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す (0.01s)</span></span><br><span class="line">        --- expected</span><br><span class="line">        +++ actual</span><br><span class="line">        @@ -1 +1 @@</span><br><span class="line">        -<span class="string">"Fizz"</span></span><br><span class="line">        +<span class="comment">#&lt;FizzBuzzValue:0xXXXXXX @number=3, @value="Fizz"&gt;</span></span><br><span class="line">        /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:57:<span class="keyword">in</span> `test_配列の2番目は文字列のFizzを返す<span class="string">'</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>変更によりテストが失敗しました。エラー内容を見てみると文字列からオブジェクトを返しているためアサーションが失敗しているようです。ここは、<strong>値オブジェクト</strong> の <strong>アクセッサメソッド</strong> を経由して取得した値をアサーション対象に変更しましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(FizzBuzzType01.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列<span class="title">Fizz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Fizz'</span>, @fizzbuzz.generate(<span class="number">3</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @fizzbuzz.generate(<span class="number">5</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @fizzbuzz.generate(<span class="number">15</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.generate(<span class="number">1</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzz.new(FizzBuzzType01.new)</span><br><span class="line">          fizzbuzz.generate_list</span><br><span class="line">          @result = fizzbuzz.list</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の初めは文字列の1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @result.first.value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の最後は文字列の<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @result.last.value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の2番目は文字列の<span class="title">Fizz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Fizz'</span>, @result[<span class="number">2</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の4番目は文字列の<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @result[<span class="number">4</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の14番目は文字列の<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @result[<span class="number">14</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(FizzBuzzType02.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.generate(<span class="number">3</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.generate(<span class="number">5</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列15を返す</span></span><br><span class="line">          assert_equal <span class="string">'15'</span>, @fizzbuzz.generate(<span class="number">15</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.generate(<span class="number">1</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzz.new(FizzBuzzType03.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.generate(<span class="number">3</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.generate(<span class="number">5</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @fizzbuzz.generate(<span class="number">15</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.generate(<span class="number">1</span>).value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>例外を返す</span></span><br><span class="line">        e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">          FizzBuzzType.create(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'該当するタイプは存在しません'</span>, e.message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">08:49:28 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 41 / 46 LOC (89.13%) covered.</span><br><span class="line">Started with run options --guard --seed 25972</span><br><span class="line"></span><br><span class="line">  32/32: [==================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00619s</span><br><span class="line">32 tests, 35 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line"></span><br><span class="line">08:49:29 - INFO - Inspecting Ruby code style of all files</span><br><span class="line"> 7/7 files |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">7 files inspected, no offenses detected</span><br><span class="line">08:49:30 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/loading_background.png coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/border.png</span><br><span class="line"> 0/0 files |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">0 files inspected, no offenses detected</span><br></pre></td></tr></table></figure>

<p>テストコードをそれほど変更することなく <strong>値オブジェクト</strong> を返すリファクタリングが出来ました。コミットしておきましょう。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: オブジェクトによるプリミティブの置き換え'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/230b50d5-9f01-5e41-18fc-998be9c52c46.png" alt="diag-719d1727313ce1fe35a0a3eaeca9a624.png"></p>
<h4 id="学習用テスト"><a href="#学習用テスト" class="headerlink" title="学習用テスト"></a>学習用テスト</h4><p><strong>値オブジェクト</strong> の理解を深めるために <strong>学習用テスト</strong> を追加します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  describe <span class="string">'FizzBuzzValue'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">      @fizzbuzz = FizzBuzz.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>同じで値である</span></span><br><span class="line">      value1 = @fizzbuzz.generate(<span class="number">1</span>)</span><br><span class="line">      value2 = @fizzbuzz.generate(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">      assert value1.eql?(value2)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_to_string</span>メソッド</span></span><br><span class="line">      value = @fizzbuzz.generate(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">'3:Fizz'</span>, value.to_s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'test: 学習用テスト'</span></span><br></pre></td></tr></table></figure>

<h3 id="ファーストクラスコレクション"><a href="#ファーストクラスコレクション" class="headerlink" title="ファーストクラスコレクション"></a>ファーストクラスコレクション</h3><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/230b50d5-9f01-5e41-18fc-998be9c52c46.png" alt="diag-719d1727313ce1fe35a0a3eaeca9a624.png"></p>
<h4 id="コレクションのカプセル化"><a href="#コレクションのカプセル化" class="headerlink" title="コレクションのカプセル化"></a>コレクションのカプセル化</h4><p><strong>値オブジェクト</strong> を扱う FizzBuzz リストですが <strong>コレクションのカプセル化</strong> を適用して <strong>ファーストクラスコレクション</strong> オブジェクトを追加しましょう。</p>
<blockquote>
<p>コレクションのカプセル化</p>
<p>メソッドがコレクションを返している。</p>
<p>読み取り専用のビューを返して、追加と削除のメソッドを提供する。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<blockquote>
<p>このように、コレクション型のデータとロジックを特別扱いにして、コレクションを１つだけ持つ専用クラスを作るやり方をコレクションオブジェクトあるいはファーストクラスコレクションと呼びます。</p>
<p>— 現場で役立つシステム設計の原則</p>
</blockquote>
<p>まず、 <strong>ファーストクラスコレクション</strong> クラスを追加します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzList</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(list)</span></span></span><br><span class="line">    @value = list</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">to_s</span></span></span><br><span class="line">    @value.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(value)</span></span></span><br><span class="line">    FizzBuzzList.new(@value + value)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>FizzBuzz 配列を <strong>ファーストクラスコレクション</strong> から取得するように変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = (<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> generate(n) &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">    @list = FizzBuzzList.new([])</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = @list.add((<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> @type.generate(n) &#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>なんだか紛らわしい書き方になってしましました。配列を作るのに以前の配列を元に新しい配列を作るとか回りくどいことをしないで既存の配列を使い回せばいいじゃんと思うかもしれませんが <strong>変更可能なデータ</strong> はバグの原因となる傾向があります。変更可能な <strong>ミュータブル</strong> な変数ではなく 永続的に変更されない <strong>イミュータブル</strong> な変数を使うように心がけましょう。</p>
<blockquote>
<p>変更可能なデータ</p>
<p>データの変更はしばし予期せぬ結果結果や、厄介なバグを引き起こします。他で違う値を期待していることに気づかないままに、ソフトウェアのある箇所で値を変更してしまえば、それだけで動かなくなってしまいます。これは値が変わる条件がまれにしかない場合、特に見つけにくいバグとなります。そのため、ソフトウェア開発の一つの潮流である関数型プログラミングは、データは不変であるべきで、更新時は常に元にデータ構造のコピーを返すようにし、元データには手を触れないという思想に基づいています。</p>
<p>— リファクタリング(第 2 版)</p>
</blockquote>
<blockquote>
<p>値オブジェクトと同じようにコレクションオブジェクトも、できるだけ「不変」スタイルで設計します。そのほうがプログラムが安定します。</p>
<p>— 現場で役立つシステム設計の原則</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ERROR[<span class="string">"test_配列の14番目は文字列のFizzBuzzを返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x00005561331b7940 @name="FizzBuzz::数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す"&gt;, 0.011710233025951311]</span></span><br><span class="line"> test_配列の14番目は文字列のFizzBuzzを返す<span class="comment">#FizzBuzz::数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す (0.01s)</span></span><br><span class="line">Minitest::UnexpectedError:         NoMethodError: undefined method `[]<span class="string">' for #&lt;FizzBuzzList:0x0000556133198ba8 @value=[]&gt;</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:66:in `test_配列の14番目は文字列のFizzBuzzを返す'</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>ファーストクラスコレクション</strong> 経由で取得するようになったので <strong>アクセッサメソッド</strong> を変更する必要があります。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:list</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">    @list = FizzBuzzList.new([])</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">list</span></span></span><br><span class="line">    @list.value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">    @list = FizzBuzzList.new([])</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">09:12:46 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 53 / 56 LOC (94.64%) covered.</span><br><span class="line">Started with run options --guard --seed 61051</span><br><span class="line"></span><br><span class="line">  34/34: [==================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.01285s</span><br><span class="line">34 tests, 37 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line"></span><br><span class="line">09:12:47 - INFO - Inspecting Ruby code style of all files</span><br><span class="line"> 7/7 files |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">7 files inspected, no offenses detected</span><br><span class="line">09:12:48 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/loading_background.png coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/border.png</span><br><span class="line"> 0/0 files |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">0 files inspected, no offenses detected</span><br></pre></td></tr></table></figure>

<p>テストが直ったのでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: コレクションのカプセル化'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/9c7d1661-11c3-f495-e41b-b3ed7f8eb940.png" alt="diag-f753577a92fab80607a2e63cf53e8389.png"></p>
<h4 id="学習用テスト-1"><a href="#学習用テスト-1" class="headerlink" title="学習用テスト"></a>学習用テスト</h4><p><strong>ファーストクラスコレクション</strong> を理解するため <strong>学習用テスト</strong> を追加しておきましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  describe <span class="string">'FizzBuzzValueList'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">      @fizzbuzz = FizzBuzz.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>新しいインスタンスが作られる</span></span><br><span class="line">      list1 = @fizzbuzz.generate_list</span><br><span class="line">      list2 = list1.add(list1.value)</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="number">100</span>, list1.value.count</span><br><span class="line">      assert_equal <span class="number">200</span>, list2.value.count</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: 学習用テスト'</span></span><br></pre></td></tr></table></figure>

<h3 id="オブジェクト指向設計-1"><a href="#オブジェクト指向設計-1" class="headerlink" title="オブジェクト指向設計"></a>オブジェクト指向設計</h3><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/9c7d1661-11c3-f495-e41b-b3ed7f8eb940.png" alt="diag-f753577a92fab80607a2e63cf53e8389.png"></p>
<p><strong>値オブジェクト</strong> 及び <strong>ファーストクラスコレクション</strong> の適用で <strong>基本データ型への執着</strong> の臭いはなくなりました。今度は設計の観点から全体を眺めてみましょう。ここで気になるのが <code>FizzBuzz</code> クラスです。このクラスは他のクラスと比べてやることが多いようです。このようなクラスは <strong>単一責任の原則</strong> に違反している可能性があります。そこで <strong>デザインパターン</strong> の１つである <strong>Command パターン</strong> を使ったリファクタリングである <strong>メソッドオブジェクトによるメソッドの置き換え</strong> 適用してみようと思います。</p>
<blockquote>
<p>SRP:<br>単一責任の原則</p>
<p>かつて単一責任の原則(SRP)は、以下のように語られてきた。</p>
<pre><code>モジュールを変更する理由はたったひとつだけであるべきである</code></pre><p>ソフトウェアシステムに手を加えるのは、ユーザーやステークホルダーを満足させるためだ。この「ユーザーやステークホルダー」こそが、単一責任の原則（SRP）を指す「変更する理由」である。つまり、この原則は以下のように言い換えられる。</p>
<pre><code>モジュールはたったひとりのユーザーやステークホルダーに対して責任を負うべきである。</code></pre><p>残念ながら「たったひとりのユーザーやステークホルダー」という表現は適切ではない。複数のユーザーやステークホルダーがシステムを同じように変更したいと考えることもある。ここでは、変更を望む人たちをひとまとめにしたグループとして扱いたい。このグループのことをアクターと呼ぶことにしよう。<br>これを踏まえると、最終的な単一責任の原則（SRP）は以下のようになる。</p>
<pre><code>モジュールはたったひとつのアクターに対して責任を負うべきである。</code></pre><p>さて、ここでいう「モジュール」とは何のことだろう？端的に言えば、モジュールとはソースファイルのことである。たいていの場合は、この定義で問題ないだろう。だが、ソースファイル以外のところにコードを格納する言語や開発環境も存在する。そのような場合の「モジュール」は、いくつかの関数やデータをまとめた凝集性のあるものだと考えよう。</p>
<p>「凝集性のある」という言葉が単一責任の原則（SRP）を匂わせる。凝集性が、ひとつのアクターに対する責務を負うコードをまとめるフォースとなる。</p>
<p>— Clean Architecture 達人に学ぶソフトウェアの構造と設計</p>
</blockquote>
<blockquote>
<p>Command パターン</p>
<p>処理の呼び出しが、シンプルなメソッド呼び出しよりも複雑になってきたときはどうすればよいだろうか—処理のためのオブジェクトを作成し、それを起動するようにしよう。</p>
<p>— テスト駆動開発</p>
</blockquote>
<blockquote>
<p>メソッドオブジェクトによるメソッドの置き換え</p>
<p>長いメソッドで、「メソッドの抽出」を適用できないようなローカル変数の使い方をしている。</p>
<p>メソッド自身をオブジェクトとし、すべてのローカル変数をそのオブジェクトのフィールドとする。そうすれば、そのメソッドを同じオブジェクト中のメソッド群に分解できる。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<h4 id="メソッドオブジェクトによるメソッドの置き換え"><a href="#メソッドオブジェクトによるメソッドの置き換え" class="headerlink" title="メソッドオブジェクトによるメソッドの置き換え"></a>メソッドオブジェクトによるメソッドの置き換え</h4><p>まず、<strong>値オブジェクト</strong> の <code>FizzBuzzValue</code> を返す責務だけを持った <strong>メソッドオブジェクト</strong> を抽出します。Ruby のような動的言語では必要が無いのですが <strong>Command パターン</strong> の説明のため <strong>インターフェイス</strong> にあたるスーパークラスを継承した <strong>メソッドオブジェクト</strong> を定義します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzCommand</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span>;</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValueCommand</span> &lt; FizzBuzzCommand</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(number)</span></span></span><br><span class="line">    @type.generate(number).value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>テストコードを <code>FizzBuzzValueCommand</code> を呼び出すように変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzzValueCommand.new(FizzBuzzType01.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列<span class="title">Fizz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Fizz'</span>, @fizzbuzz.execute(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @fizzbuzz.execute(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @fizzbuzz.execute(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.execute(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzz.new(FizzBuzzType01.new)</span><br><span class="line">          fizzbuzz.generate_list</span><br><span class="line">          @result = fizzbuzz.list</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の初めは文字列の1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @result.first.value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の最後は文字列の<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @result.last.value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の2番目は文字列の<span class="title">Fizz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Fizz'</span>, @result[<span class="number">2</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の4番目は文字列の<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @result[<span class="number">4</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の14番目は文字列の<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @result[<span class="number">14</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzzValueCommand.new(FizzBuzzType02.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.execute(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.execute(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列15を返す</span></span><br><span class="line">          assert_equal <span class="string">'15'</span>, @fizzbuzz.execute(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.execute(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzzValueCommand.new(FizzBuzzType03.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.execute(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.execute(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @fizzbuzz.execute(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.execute(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>例外を返す</span></span><br><span class="line">        e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">          FizzBuzzType.create(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'該当するタイプは存在しません'</span>, e.message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">09:56:19 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 60 / 63 LOC (95.24%) covered.</span><br><span class="line">Started with run options --guard --seed 27353</span><br><span class="line"></span><br><span class="line">  35/35: [==================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00692s</span><br><span class="line">35 tests, 39 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line"></span><br><span class="line">09:56:20 - INFO - Inspecting Ruby code style of all files</span><br><span class="line"> 7/7 files |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">7 files inspected, no offenses detected</span><br><span class="line">09:56:21 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/loading_background.png coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/border.png</span><br><span class="line"> 0/0 files |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>

<p><code>FizzBuzzValueCommand</code> の抽出ができたのでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: メソッドオブジェクトによるメソッドの置き換え'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/29eee45e-037a-04be-ff2f-e2696e1ab4d3.png" alt="diag-ee5628564b01a6264bda537c84b0458b.png"></p>
<h4 id="メソッドオブジェクトによるメソッドの置き換え-1"><a href="#メソッドオブジェクトによるメソッドの置き換え-1" class="headerlink" title="メソッドオブジェクトによるメソッドの置き換え"></a>メソッドオブジェクトによるメソッドの置き換え</h4><p>続いて、<strong>ファーストクラスコレクション</strong> を扱う <code>FizzBuzzList</code> を返す責務だけを持った <strong>メソッドオブジェクト</strong> を抽出します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzListCommand</span> &lt; FizzBuzzCommand</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(number)</span></span></span><br><span class="line">    FizzBuzzList.new((<span class="number">1</span>..number).map &#123; <span class="params">|i|</span> @type.generate(i) &#125;).value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>テストコードを <strong>FizzBuzzListCommand</strong> 経由から実行するように変更します</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">        describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">          <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">            fizzbuzz = FizzBuzz.new(FizzBuzzType01.new)</span><br><span class="line">            fizzbuzz.generate_list</span><br><span class="line">            @result = fizzbuzz.list</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzzListCommand.new(FizzBuzzType01.new)</span><br><span class="line">          @result = fizzbuzz.execute(<span class="number">100</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">01:27:54 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 61 / 66 LOC (92.42%) covered.</span><br><span class="line">Started with run options --guard --seed 62253</span><br><span class="line"></span><br><span class="line">  35/35: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00652s</span><br><span class="line">35 tests, 39 assertions, 0 failures, 0 errors, 0 skips</span><br></pre></td></tr></table></figure>

<p>テストが通ったのでコミットします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: メソッドオブジェクトによるメソッドの置き換え'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/d94351bd-23d9-6081-baa4-8f71ab75d3de.png" alt="diag-4a094b5dcd7f922c01a8ad5b39f6839d.png"></p>
<h4 id="デッドコードの削除"><a href="#デッドコードの削除" class="headerlink" title="デッドコードの削除"></a>デッドコードの削除</h4><p><code>FizzBuzz</code> クラスの責務は各 <strong>メソッドオブジェクト</strong> が実行するようになったので削除しましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzz</span></span></span><br><span class="line">  MAX_NUMBER = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">    @list = FizzBuzzList.new([])</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">list</span></span></span><br><span class="line">    @list.value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    @type.generate(number)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_list</span></span></span><br><span class="line">    <span class="comment"># 1から最大値までのFizzBuzz配列を1発で作る</span></span><br><span class="line">    @list = @list.add((<span class="number">1</span>..MAX_NUMBER).map &#123; <span class="params">|n|</span> @type.generate(n) &#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ERROR[<span class="string">"test_同じで値である"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x0000562fd34f7848 @name="FizzBuzzValue"&gt;, 0.008059715997660533]</span></span><br><span class="line"> test_同じで値である<span class="comment">#FizzBuzzValue (0.01s)</span></span><br><span class="line">Minitest::UnexpectedError:         NameError: uninitialized constant FizzBuzzTest::FizzBuzz</span><br><span class="line">            /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:225:<span class="keyword">in</span> `setup<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ERROR["test_to_stringメソッド", #&lt;Minitest::Reporters::Suite:0x0000562fd37694a0 @name="FizzBuzzValue"&gt;, 0.01728590900893323]</span></span><br><span class="line"><span class="string"> test_to_stringメソッド#FizzBuzzValue (0.02s)</span></span><br><span class="line"><span class="string">Minitest::UnexpectedError:         NameError: uninitialized constant FizzBuzzTest::FizzBuzz</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:225:in `setup'</span></span><br><span class="line"></span><br><span class="line">ERROR[<span class="string">"test_新しいインスタンスが作られる"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x0000562fd39be070 @name="FizzBuzzValueList"&gt;, 0.028008958004647866]</span></span><br><span class="line"> test_新しいインスタンスが作られる<span class="comment">#FizzBuzzValueList (0.03s)</span></span><br><span class="line">Minitest::UnexpectedError:         NameError: uninitialized constant FizzBuzzTest::FizzBuzz</span><br><span class="line">            /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:244:<span class="keyword">in</span> `setup<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">========================================|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Finished in 0.03539s</span></span><br><span class="line"><span class="string">35 tests, 35 assertions, 0 failures, 3 errors, 0 skips</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>テストが失敗しました。これは <strong>学習用テスト</strong> で <code>FizzBuzz</code> クラスを使っている箇所があるからですね。 <strong>メソッドオブジェクト</strong> 呼び出しに変更しておきましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  describe <span class="string">'FizzBuzzValue'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">      @fizzbuzz = FizzBuzz.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>同じで値である</span></span><br><span class="line">      value1 = @fizzbuzz.generate(<span class="number">1</span>)</span><br><span class="line">      value2 = @fizzbuzz.generate(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">      assert value1.eql?(value2)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_to_string</span>メソッド</span></span><br><span class="line">      value = @fizzbuzz.generate(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">'3:Fizz'</span>, value.to_s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">'FizzBuzzValueList'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">      @fizzbuzz = FizzBuzz.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>新しいインスタンスが作られる</span></span><br><span class="line">      list1 = @fizzbuzz.generate_list</span><br><span class="line">      list2 = list1.add(list1.value)</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="number">100</span>, list1.value.count</span><br><span class="line">      assert_equal <span class="number">200</span>, list2.value.count</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  describe <span class="string">'FizzBuzzValue'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>同じで値である</span></span><br><span class="line">      value1 = FizzBuzzValue.new(<span class="number">1</span>, <span class="string">'1'</span>)</span><br><span class="line">      value2 = FizzBuzzValue.new(<span class="number">1</span>, <span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">      assert value1.eql?(value2)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_to_string</span>メソッド</span></span><br><span class="line">      value = FizzBuzzValue.new(<span class="number">3</span>, <span class="string">'Fizz'</span>)</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">'3:Fizz'</span>, value.to_s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">'FizzBuzzValueList'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>新しいインスタンスが作られる</span></span><br><span class="line">      command = FizzBuzzListCommand.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">      array = command.execute(<span class="number">100</span>)</span><br><span class="line">      list1 = FizzBuzzList.new(array)</span><br><span class="line">      list2 = list1.add(array)</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="number">100</span>, list1.value.count</span><br><span class="line">      assert_equal <span class="number">200</span>, list2.value.count</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">01:35:22 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 50 / 56 LOC (89.29%) covered.</span><br><span class="line">Started with run options --guard --seed 10411</span><br><span class="line"></span><br><span class="line">  35/35: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00704s</span><br><span class="line">35 tests, 39 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>不要なコードを残しておくとメンテナンスの時に削除していいのかわからなくなり可読性を落とし原因となります。削除できる時に削除しておきましょう。後で必要になったとしてもバージョン管理システムを使えば問題ありません。ということでコミットします。</p>
<blockquote>
<p>デッドコードの削除</p>
<p>コードが使用されなくなったら削除すべきです。そのコードが将来必要になるかもしれないなどという心配はしません。必要になったらいつでも、バージョン管理システムから再び掘り起こせるからです。</p>
<p>（中略）</p>
<p>デッドコードのコメントアウトは、かつては一般的な習慣でした。それは、バージョン管理システムが広く使用される以前の時代や、使いづらかった時代には有用でした。現在では、とても小さなコードベースでもバージョン管理システムに置けるため、もはや必要のない習慣です。</p>
<p>— リファクタリング(第 2 版)</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: デッドコードの削除'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/9a745e4a-4f98-9723-1b94-e116805604fd.png" alt="diag-55cb49d0a54190528d027b3768e4aa29.png"></p>
<h4 id="デザインパターン"><a href="#デザインパターン" class="headerlink" title="デザインパターン"></a>デザインパターン</h4><p><strong>メソッドオブジェクトによるメソッドの置き換え</strong> リファクタリングの結果として <strong>Command パターン</strong> という <strong>デザインパターン</strong> を適用しました。実はこれまでにも <strong>オブジェクトによるプリミティブの置き換え</strong> では <strong>Value Object パターン</strong> を <strong>ポリモーフィズムによる条件記述の置き換え</strong> では <strong>Factory Method パターン</strong> をそして、 <strong>委譲の隠蔽</strong> の実施による <strong>State/Strategy によるタイプコードの置き換え</strong> では <strong>Strategy パターン</strong> を適用しています。</p>
<p><a href="https://ja.wikipedia.org/wiki/Command_%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3" target="_blank" rel="noopener">Command パターン</a></p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/742f33e5-d884-2a28-104a-6d311bccd060.png" alt="diag-3f9e53f62bd2f1b3bfe0f476521170ca.png"></p>
<blockquote>
<p>Value Object パターン</p>
<p>広く共有されるものの、同一インスタンスであることはさほど重要でないオブジェクトを設計するにはどうしたらよいだろうか—-オブジェクト作成時に状態を設定したら、その後決して変えないようにする。オブジェクトへの操作は必ず新しいオブジェクトを返すようにしよう。</p>
<p>— テスト駆動開発</p>
</blockquote>
<blockquote>
<p>Factory Method パターン</p>
<p>オブジェクト作成に柔軟性をもたせたいときは、どうすればよいだろうか—単にコンストラクタで作るのではなく、メソッドを使ってオブジェクトを作成しよう。</p>
<p>— テスト駆動開発</p>
</blockquote>
<p><a href="https://ja.wikipedia.org/wiki/Strategy_%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3" target="_blank" rel="noopener">Strategy パターン</a></p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/b4fad4c5-8268-6ed7-0338-7a6ff98ea6ce.png" alt="diag-4969f773bcc5408d3afec24f14c006d3.png"></p>
<p>作成したコードはパターンと完全に一致しているわけではありませんし、Ruby のような動的言語ではもっと簡単な実現方法もありますがここでは先人の考えた設計パターンというものがありオブジェクト指向設計の <a href="https://ja.wikipedia.org/wiki/%E3%82%A4%E3%83%87%E3%82%A3%E3%82%AA%E3%83%A0" target="_blank" rel="noopener">イデオム</a> として使えること。そしてテスト駆動開発では一般的な設計アプローチとは異なる形で導かれているということくらいを頭に残しておけば結構です。どのパターンをいつ適用するかはリファクタリングを繰り返しているうちに思いつくようになってきます（多分）。</p>
<blockquote>
<p>ただ、書籍『デザインパターン』（通称 Gof 本）の  大ヒットは、その反面、それらパターンを表現する方法の多様性を奪ってしまった。Gof 本には、設計をフェーズとして扱うという暗黙の前提があるように見受けられる。つまり、リファクタリングを設計行為として捉えていない。TDD における設計は、デザインパターンを少しだけ違う側面から捉えなければならない。</p>
<p>— テスト駆動開発</p>
</blockquote>
<p>あと、設計の観点から今回 <strong>単一責任の原則</strong> に従って <code>FizzBuzz</code> クラスを <strong>メソッドオブジェクト</strong> に分割して削除しました。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/eeb0db27-d842-1058-09b1-e35244464cf1.png" alt="diag-51044325ad9691ebfe6e60879f6c95e7.png"></p>
<p>もし、新しい処理を追加する必要が発生した場合はどうしましょうか？ <code>FizzBuzzCommand</code> インターフェイスを実装した <strong>メソッドオブジェクト</strong> を追加しましょう。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/da6aaae2-b8fb-a5ed-4441-289d52f0ec51.png" alt="diag-ea3196c5b1015bd1c10121bc92095fcb.png"></p>
<p>もし、新しいタイプが必要になったらどうしましょうか？ <code>FizzBuzzType</code> クラスを継承した新しいタイプクラスを追加しましょう。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/ab873b26-19f9-2f3a-b7d0-54c14842c341.png" alt="diag-479f7874fa6e2b242ebd5a2f54730e37.png"></p>
<p>このように既存のコードを変更することなく振る舞いを変更できるので <strong>オープン・クローズドの原則</strong> を満たした設計といえます。</p>
<blockquote>
<p>OCP:オープン・クローズドの原則</p>
<p>「オープン・クローズドの原則（OCP）」は、1988 年に Bertrand Maeer が提唱した以下のような原則だ。</p>
<pre><code>ソフトウェアの構成要素は拡張に対しては開いていて、修正に対しては閉じていなければならない。
　　　　　　　　　　　　『アジャイルソフトウェア開発の奥義　第2版』（SBクリエイティブ）より引用</code></pre><p>言い換えれば、ソフトウェアの振る舞いは、既存の成果物を変更せず拡張できるようにすべきである、ということだ。</p>
<p>— Clean Architecture 達人に学ぶソフトウェアの構造と設計</p>
</blockquote>
<h3 id="例外"><a href="#例外" class="headerlink" title="例外"></a>例外</h3><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/9a745e4a-4f98-9723-1b94-e116805604fd.png" alt="diag-55cb49d0a54190528d027b3768e4aa29.png"></p>
<p>ここまでは、正常系をリファクタリングして設計を改善してきました。しかし、アプリケーションは例外系も考慮する必要があります。続いて、<strong>アサーションの導入</strong> を適用した例外系のリファクタリングに取り組むとしましょう。</p>
<blockquote>
<p>アサーションの導入</p>
<p>前提を明示するためのすぐれたテクニックとして、アサーションを記述する方法があります。</p>
<p>— リファクタリング(第 2 版)</p>
</blockquote>
<h4 id="アサーションの導入"><a href="#アサーションの導入" class="headerlink" title="アサーションの導入"></a>アサーションの導入</h4><p>まず、 <strong>メソッドオブジェクト</strong> の <code>FizzBuzzValueCommand</code> にマイナスの値が渡された場合の振る舞いをどうするか考えます。ここでは正の値のみ許可する振る舞いにしたいので以下のテストコードを追加します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTest</span> &lt; Minitest::Test</span></span><br><span class="line">...</span><br><span class="line">  describe <span class="string">'例外ケース'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>値は正の値のみ許可する</span></span><br><span class="line">      assert_raises Assertions::AssertionFailedError <span class="keyword">do</span></span><br><span class="line">        FizzBuzzValueCommand.new(</span><br><span class="line">          FizzBuzzType.create(FizzBuzzType::TYPE_01)</span><br><span class="line">        ).execute(-<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ERROR[<span class="string">"test_値は正の値のみ許可する"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x00007fadf30c45d8 @name="例外ケース"&gt;, 0.006546000000525964]</span></span><br><span class="line"> test_値は正の値のみ許可する<span class="comment">#例外ケース (0.01s)</span></span><br><span class="line">Minitest::UnexpectedError:         NameError: uninitialized constant FizzBuzzTest::Assertions</span><br><span class="line">            /Users/k2works/Projects/sandbox/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:249:<span class="keyword">in</span> `test_値は正の値のみ許可する<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  36/36: [=========================================================================] 100% Time: 00:00:00, Time: 00:00:00</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Finished in 0.03159s</span></span><br><span class="line"><span class="string">36 tests, 39 assertions, 0 failures, 1 errors, 0 skips</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>テストを通すためアサーションモジュールを追加します。Ruby では <strong>モジュール</strong> を使います。</p>
<blockquote>
<p>モジュールはクラスと非常によく似ていますが、以下の二点が異なります。</p>
<ul>
<li><p>モジュールはインスタンス化できない</p>
</li>
<li><p>本章後半可能なのは include や extend が可能なのはモジュールだけ</p>
</li>
</ul>
<p>それ以外のクラスメソッドや定数の定義などはクラスと同じように定義することができます。</p>
<p>— かんたん Ruby</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Assertions</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">AssertionFailedError</span> &lt; StandardError;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">assert</span><span class="params">(&amp;condition)</span></span></span><br><span class="line">    raise AssertionFailedError, <span class="string">'Assertion Failed'</span> <span class="keyword">unless</span> condition.call</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValue</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>アサーションモジュールを追加してエラーはなくなりましたがテストは失敗したままです。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> FAIL[<span class="string">"test_値は正の値のみ許可する"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x00007fdcfc0c2548 @name="例外ケース"&gt;, 0.005800000000817818]</span></span><br><span class="line"> test_値は正の値のみ許可する<span class="comment">#例外ケース (0.01s)</span></span><br><span class="line">        Assertions::AssertionFailedError expected but nothing was raised.</span><br><span class="line">        /Users/k2works/Projects/sandbox/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:249:<span class="keyword">in</span> `test_値は正の値のみ許可する<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">============================================================================================================|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Finished in 0.00621s</span></span><br><span class="line"><span class="string">36 tests, 40 assertions, 1 failures, 0 errors, 0 skips</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>追加したモジュールを <code>FizzBuzzValue</code> クラスをに <strong>Mix-in</strong> します。そして、<strong>コンストラクタ</strong> 実行時に数値は 0 以上であるアサーションを追加します。</p>
<blockquote>
<p>Ruby での継承は一種類、単一継承しか実行できませんが、複数のクラスを継承する多重継承の代わりに Mix-in というメソッドの共有方法を提供します。</p>
<p>— かんたん Ruby</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValue</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:number</span>, <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(number, value)</span></span></span><br><span class="line">    @number = number</span><br><span class="line">    @value = value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValue</span></span></span><br><span class="line">  <span class="keyword">include</span> Assertions</span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:number</span>, <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(number, value)</span></span></span><br><span class="line">    assert &#123; number &gt;= <span class="number">0</span> &#125;</span><br><span class="line">    @number = number</span><br><span class="line">    @value = value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Started with run options --seed 37354</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Progress: |====================================================================================================|</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.01433s</span><br><span class="line">36 tests, 40 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>アサーションが機能するようになりました、コミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: アサーションの導入'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/bbe4d4ea-87a5-ff7d-c7b5-07867aabff16.png" alt="diag-31809a5e0bf909bd8ffd6bf80e82857a.png"></p>
<p>次は、<strong>メソッドオブジェクト</strong> の <code>FizzBuzzListCommand</code> の実行時に 100 件以上指定された場合の振る舞いをどうするか考えます。ここでは 100 までを許可する振る舞いにします。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  describe <span class="string">'例外ケース'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>値は正の値のみ許可する</span></span><br><span class="line">      assert_raises Assertions::AssertionFailedError <span class="keyword">do</span></span><br><span class="line">        FizzBuzzValueCommand.new(</span><br><span class="line">          FizzBuzzType.create(FizzBuzzType::TYPE_01)</span><br><span class="line">        ).execute(-<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_100</span>より多い数を許可しない</span></span><br><span class="line">      assert_raises Assertions::AssertionFailedError <span class="keyword">do</span></span><br><span class="line">        FizzBuzzListCommand.new(</span><br><span class="line">          FizzBuzzType.create(FizzBuzzType::TYPE_01)</span><br><span class="line">        ).execute(<span class="number">101</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>FizzBuzzList</code> にアサーションモジュールを <strong>Mix-in</strong> します。<strong>コンストラクタ</strong> 実行時に配列のサイズは 100 までというアサーションを追加します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzList</span></span></span><br><span class="line">  <span class="keyword">include</span> Assertions</span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(list)</span></span></span><br><span class="line">    assert &#123; list.count &lt;= <span class="number">100</span> &#125;</span><br><span class="line">    @value = list</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ERROR[<span class="string">"test_新しいインスタンスが作られる"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x00005558ca6e8e80 @name="FizzBuzzValueList"&gt;, 0.010412617004476488]</span></span><br><span class="line"> test_新しいインスタンスが作られる<span class="comment">#FizzBuzzValueList (0.01s)</span></span><br><span class="line">Minitest::UnexpectedError:         Assertions::AssertionFailedError: Assertion Failed</span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:58:<span class="keyword">in</span> `assert<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/lib/fizz_buzz.rb:88:in `initialize'</span></span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:97:<span class="keyword">in</span> `new<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/lib/fizz_buzz.rb:97:in `add'</span></span><br><span class="line">            /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:259:<span class="keyword">in</span> `test_新しいインスタンスが作られる<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">====================================================================================================|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Finished in 0.01238s</span></span><br><span class="line"><span class="string">36 tests, 38 assertions, 0 failures, 1 errors, 0 skips</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>追加したテストはパスするようになりましたが既存のテストコードでエラーが出るようになりました。該当するテストコードを見たところ 100 件より多い <strong>学習用テスト</strong> で <strong>ファーストクラスコレクション</strong> を作ろうとしたため <code>AssertionFailedError</code> を発生させたようです。テストコードを修正しておきましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  describe <span class="string">'FizzBuzzValueList'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>新しいインスタンスが作られる</span></span><br><span class="line">      command = FizzBuzzListCommand.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">      array = command.execute(<span class="number">100</span>)</span><br><span class="line">      list1 = FizzBuzzList.new(array)</span><br><span class="line">      list2 = list1.add(array)</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="number">100</span>, list1.value.count</span><br><span class="line">      assert_equal <span class="number">200</span>, list2.value.count</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>最初は 50 件作るように変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  describe <span class="string">'FizzBuzzValueList'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>新しいインスタンスが作られる</span></span><br><span class="line">      command = FizzBuzzListCommand.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">      array = command.execute(<span class="number">50</span>)</span><br><span class="line">      list1 = FizzBuzzList.new(array)</span><br><span class="line">      list2 = list1.add(array)</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="number">100</span>, list1.value.count</span><br><span class="line">      assert_equal <span class="number">200</span>, list2.value.count</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>アサーションエラーはなくなりましたが期待した値と違うと指摘されています。テストコードのアサーションを修正します。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> FAIL[<span class="string">"test_新しいインスタンスが作られる"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x0000556b5137c780 @name="FizzBuzzValueList"&gt;, 0.003735148988198489]</span></span><br><span class="line"> test_新しいインスタンスが作られる<span class="comment">#FizzBuzzValueList (0.00s)</span></span><br><span class="line">        Expected: 100</span><br><span class="line">          Actual: 50</span><br><span class="line">        /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:261:<span class="keyword">in</span> `test_新しいインスタンスが作られる<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  36/36: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Finished in 0.00837s</span></span><br><span class="line"><span class="string">36 tests, 39 assertions, 1 failures, 0 errors, 0 skips</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  describe <span class="string">'FizzBuzzValueList'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>新しいインスタンスが作られる</span></span><br><span class="line">      command = FizzBuzzListCommand.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">      array = command.execute(<span class="number">50</span>)</span><br><span class="line">      list1 = FizzBuzzList.new(array)</span><br><span class="line">      list2 = list1.add(array)</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="number">50</span>, list1.value.count</span><br><span class="line">      assert_equal <span class="number">200</span>, list2.value.count</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>２つ目のアサーションに引っかかってしまいました。こちらも修正します。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> FAIL[<span class="string">"test_新しいインスタンスが作られる"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x0000563a0c4fc2b0 @name="FizzBuzzValueList"&gt;, 0.005684088013367727]</span></span><br><span class="line"> test_新しいインスタンスが作られる<span class="comment">#FizzBuzzValueList (0.01s)</span></span><br><span class="line">        Expected: 200</span><br><span class="line">          Actual: 100</span><br><span class="line">        /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:262:<span class="keyword">in</span> `test_新しいインスタンスが作られる<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  36/36: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Finished in 0.00809s</span></span><br><span class="line"><span class="string">36 tests, 40 assertions, 1 failures, 0 errors, 0 skips</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  describe <span class="string">'FizzBuzzValueList'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>新しいインスタンスが作られる</span></span><br><span class="line">      command = FizzBuzzListCommand.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">      array = command.execute(<span class="number">50</span>)</span><br><span class="line">      list1 = FizzBuzzList.new(array)</span><br><span class="line">      list2 = list1.add(array)</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="number">50</span>, list1.value.count</span><br><span class="line">      assert_equal <span class="number">100</span>, list2.value.count</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">01:58:57 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 61 / 64 LOC (95.31%) covered.</span><br><span class="line">Started with run options --guard --seed 44956</span><br><span class="line"></span><br><span class="line">  36/36: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00717s</span><br><span class="line">36 tests, 40 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>仕様変更による反映  が出来たのでコミットしましょう。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: アサーションの導入'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/29ff3f05-d607-1549-19e8-dd10cd9d845a.png" alt="diag-6390574a6b0b9b04721636e71b66aea3.png"></p>
<p><strong>アサーションの導入</strong> とは別のアプローチとして <strong>例外</strong> を返す方法もあります。 <strong>例外によるエラーコードの置き換え</strong> を適用してアサーションモジュールを削除しましょう。</p>
<blockquote>
<p>例外によるエラーコードの置き換え</p>
<p>エラーを示す特別なコードをメソッドがリターンしている。</p>
<p>代わりに例外を発生させる。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<h4 id="例外によるエラーコードの置き換え"><a href="#例外によるエラーコードの置き換え" class="headerlink" title="例外によるエラーコードの置き換え"></a>例外によるエラーコードの置き換え</h4><p>アサーションモジュールを削除してアサーション部分を <strong>例外</strong> に変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Assertions</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">AssertionFailedError</span> &lt; StandardError;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">assert</span><span class="params">(&amp;condition)</span></span></span><br><span class="line">    raise AssertionFailedError, <span class="string">'Assertion Failed'</span> <span class="keyword">unless</span> condition.call</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValue</span></span></span><br><span class="line">  <span class="keyword">include</span> Assertions</span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:number</span>, <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(number, value)</span></span></span><br><span class="line">    assert &#123; number &gt;= <span class="number">0</span> &#125;</span><br><span class="line">    @number = number</span><br><span class="line">    @value = value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzList</span></span></span><br><span class="line">  <span class="keyword">include</span> Assertions</span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(list)</span></span></span><br><span class="line">    assert &#123; list.count &lt;= <span class="number">100</span> &#125;</span><br><span class="line">    @value = list</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValue</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:number</span>, <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(number, value)</span></span></span><br><span class="line">    raise <span class="string">'正の値のみ有効です'</span> <span class="keyword">if</span> number &lt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    @number = number</span><br><span class="line">    @value = value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzList</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(list)</span></span></span><br><span class="line">    raise <span class="string">'上限は100件までです'</span> <span class="keyword">if</span> list.count &gt; <span class="number">100</span></span><br><span class="line"></span><br><span class="line">    @value = list</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ERROR[<span class="string">"test_値は正の値のみ許可する"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x000055d30f0b8a50 @name="FizzBuzz::数を文字列にして返す::例外ケース"&gt;, 0.004186890990240499]</span></span><br><span class="line"> test_値は正の値のみ許可する<span class="comment">#FizzBuzz::数を文字列にして返す::例外ケース (0.00s)</span></span><br><span class="line">Minitest::UnexpectedError:         NameError: uninitialized constant FizzBuzzTest::Assertions</span><br><span class="line">            /workspace/tdd_rb/<span class="built_in">test</span>/fizz_buzz_test.rb:143:<span class="keyword">in</span> `test_値は正の値のみ許可する<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ERROR["test_100より多い数を許可しない", #&lt;Minitest::Reporters::Suite:0x000055d30f114210 @name="FizzBuzz::数を文字列にして返す::例外ケース"&gt;, 0.008254560001660138]</span></span><br><span class="line"><span class="string"> test_100より多い数を許可しない#FizzBuzz::数を文字列にして返す::例外ケース (0.01s)</span></span><br><span class="line"><span class="string">Minitest::UnexpectedError:         NameError: uninitialized constant FizzBuzzTest::Assertions</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:151:in `test_100より多い数を許可しない'</span></span><br><span class="line"></span><br><span class="line">  37/37: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.01731s</span><br><span class="line">37 tests, 39 assertions, 0 failures, 2 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>アサーションモジュールを削除したのでエラーが発生しています。テストコードを修正しましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  describe <span class="string">'例外ケース'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>値は正の値のみ許可する</span></span><br><span class="line">      assert_raises Assertions::AssertionFailedError <span class="keyword">do</span></span><br><span class="line">        FizzBuzzValueCommand.new(</span><br><span class="line">          FizzBuzzType.create(FizzBuzzType::TYPE_01)</span><br><span class="line">        ).execute(-<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_100</span>より多い数を許可しない</span></span><br><span class="line">      assert_raises Assertions::AssertionFailedError <span class="keyword">do</span></span><br><span class="line">        FizzBuzzListCommand.new(</span><br><span class="line">          FizzBuzzType.create(FizzBuzzType::TYPE_01)</span><br><span class="line">        ).execute(<span class="number">101</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  describe <span class="string">'例外ケース'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>値は正の値のみ許可する</span></span><br><span class="line">      e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">        FizzBuzzValueCommand.new(</span><br><span class="line">          FizzBuzzType.create(FizzBuzzType::TYPE_01)</span><br><span class="line">        ).execute(-<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">'正の値のみ有効です'</span>, e.message</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_100</span>より多い数を許可しない</span></span><br><span class="line">      e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">        FizzBuzzListCommand.new(</span><br><span class="line">          FizzBuzzType.create(FizzBuzzType::TYPE_01)</span><br><span class="line">        ).execute(<span class="number">101</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">'上限は100件までです'</span>, e.message</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">02:13:46 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 55 / 58 LOC (94.83%) covered.</span><br><span class="line">Started with run options --guard --seed 55179</span><br><span class="line"></span><br><span class="line">  37/37: [=================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00738s</span><br><span class="line">37 tests, 43 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>再びテストが通るようになったのでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor:  例外によるエラーコードの置き換え'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/946fb41e-b83f-cae4-78d3-effdff059f93.png" alt="diag-cd1dbf997043a35c9bb55b407c0a2af9.png"></p>
<h4 id="アルゴリズムの置き換え"><a href="#アルゴリズムの置き換え" class="headerlink" title="アルゴリズムの置き換え"></a>アルゴリズムの置き換え</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">02:13:46 - INFO - Inspecting Ruby code style: <span class="built_in">test</span>/fizz_buzz_test.rb lib/fizz_buzz.rb</span><br><span class="line">lib/fizz_buzz.rb:58:26: C: Style/NumericPredicate: Use number.negative? instead of number &lt; 0.</span><br><span class="line">    raise <span class="string">'正の値のみ有効です'</span> <span class="keyword">if</span> number &lt; 0</span><br><span class="line">                         ^^^^^^^^^^</span><br><span class="line"> 2/2 files |====================================== 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">2 files inspected, 1 offense detected</span><br></pre></td></tr></table></figure>

<p>テストは通りますが警告が表示されるようになりました。 <code>Style/NumericPredicate: Use number.negative? instead of number &lt; 0.</code> とのことなので <strong>アルゴリズムの置き換え</strong> を適用しておきましょう。</p>
<blockquote>
<p>アルゴリズムの取り替え</p>
<p>アルゴリズムをよりわかりやすいものに置き換えたい</p>
<p>メソッドの本体を新たなアルゴリズムで置き換える。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValue</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:number</span>, <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(number, value)</span></span></span><br><span class="line">    raise <span class="string">'正の値のみ有効です'</span> <span class="keyword">if</span> number &lt; <span class="number">0</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValue</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:number</span>, <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(number, value)</span></span></span><br><span class="line">    raise <span class="string">'正の値のみ有効です'</span> <span class="keyword">if</span> number.negative?</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">02:18:31 - INFO - Inspecting Ruby code style: lib/fizz_buzz.rb</span><br><span class="line"> 1/1 file |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">1 file inspected, no offenses detected</span><br></pre></td></tr></table></figure>

<p>警告が消えたのでコミットします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: アルゴリズムの置き換え'</span></span><br></pre></td></tr></table></figure>

<h4 id="マジックナンバーの置き換え-1"><a href="#マジックナンバーの置き換え-1" class="headerlink" title="マジックナンバーの置き換え"></a>マジックナンバーの置き換え</h4><p>件数に <strong>リテラル</strong> を使っています。ここは <strong>マジックナンバーの置き換え</strong> を適用するべきですね。</p>
<blockquote>
<p>シンボリック定数によるマジックナンバーの置き換え</p>
<p>特別な意味を持った数字のリテラルがある。</p>
<p>定数を作り、それにふさわしい名前をつけて、そのリテラルを置き換える。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzList</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(list)</span></span></span><br><span class="line">    raise <span class="string">'上限は100件までです'</span> <span class="keyword">if</span> list.count &gt; <span class="number">100</span></span><br><span class="line"></span><br><span class="line">    @value = list</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>式展開</strong> を使ってメッセージ内容も定数から参照するようにしましょう。</p>
<blockquote>
<p>式展開</p>
<p>式展開とは、「#{}」の書式で文字列中に何らかの変数や式を埋め込むことが可能な機能です。これは、ダブルクオートを使用した場合のみの機能です。</p>
<p>— かんたん Ruby</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzList</span></span></span><br><span class="line">  MAX_COUNT = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(list)</span></span></span><br><span class="line">    raise <span class="string">"上限は<span class="subst">#&#123;MAX_COUNT&#125;</span>件までです"</span> <span class="keyword">if</span> list.count &gt; MAX_COUNT</span><br><span class="line"></span><br><span class="line">    @value = list</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストは壊れていないようですが <code>MAX_COUNT</code> を変更したらテストが失敗するか確認しておきましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzList</span></span></span><br><span class="line">  MAX_COUNT = <span class="number">10</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ERROR[<span class="string">"test_配列の14番目は文字列のFizzBuzzを返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x000055942ab5e230 @name="FizzBuzz::数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す"&gt;, 0.008073228993453085]</span></span><br><span class="line"> test_配列の14番目は文字列のFizzBuzzを返す<span class="comment">#FizzBuzz::数を文字列にして返す::タイプ1の場合::1から100までのFizzBuzzの配列を返す (0.01s)</span></span><br><span class="line">Minitest::UnexpectedError:         RuntimeError: 上限は10件までです</span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:80:<span class="keyword">in</span> `initialize<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/lib/fizz_buzz.rb:112:in `new'</span></span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:112:<span class="keyword">in</span> `execute<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:45:in `setup'</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>想定通りのエラーが発生したのでコードを元に戻してコミットしましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzList</span></span></span><br><span class="line">  MAX_COUNT = <span class="number">100</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Started with run options --seed 5525</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Progress: |====================================================================================================|</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.01262s</span><br><span class="line">37 tests, 43 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: マジックナンバーの置き換え'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/946fb41e-b83f-cae4-78d3-effdff059f93.png" alt="diag-cd1dbf997043a35c9bb55b407c0a2af9.png"></p>
<h4 id="特殊ケースの導入"><a href="#特殊ケースの導入" class="headerlink" title="特殊ケースの導入"></a>特殊ケースの導入</h4><p>最後に <strong>ポリモーフィズム</strong> の応用としてタイプクラスが未定義の場合に <strong>例外</strong> ではなく未定義のタイプクラスを返す <strong>特殊ケースの導入</strong> を適用してみましょう。</p>
<blockquote>
<p>ヌルオブジェクトの導入</p>
<p>null 値のチェックが繰り返し現れる。</p>
<p>その null 値をヌルオブジェクトで置き換える。</p>
<p>— 新装版 リファクタリング</p>
</blockquote>
<blockquote>
<p>特殊ケースの導入</p>
<p>旧：ヌルオブジェクトの導入</p>
<p>特殊ケースの処理を要する典型的な値が null なので、このパターンをヌルオブジェクトパターンと呼ぶことがあります、しかし、通常の特殊ケースとアプローチは同じです。いわばヌルオブジェクトは「特殊ケース」の特殊ケースです。</p>
<p>— リファクタリング(第 2 版)</p>
</blockquote>
<p>まず、それ以外のタイプの場合の振る舞いを変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>例外を返す</span></span><br><span class="line">        e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">          FizzBuzzType.create(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'該当するタイプは存在しません'</span>, e.message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">   describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>未定義のタイプを返す</span></span><br><span class="line">        fizzbuzz = FizzBuzzType.create(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'未定義'</span>, fizzbuzz.to_s</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ERROR[<span class="string">"test_未定義のタイプを返す"</span>, <span class="comment">#&lt;Minitest::Reporters::Suite:0x00005593e21297d0 @name="数を文字列にして返す::それ以外のタイプの場合"&gt;, 0.0065623498521745205]</span></span><br><span class="line"> test_未定義のタイプを返す<span class="comment">#数を文字列にして返す::それ以外のタイプの場合 (0.01s)</span></span><br><span class="line">Minitest::UnexpectedError:         RuntimeError: 該当するタイプは存在しません</span><br><span class="line">            /workspace/tdd_rb/lib/fizz_buzz.rb:17:<span class="keyword">in</span> `create<span class="string">'</span></span><br><span class="line"><span class="string">            /workspace/tdd_rb/test/fizz_buzz_test.rb:131:in `test_未定義のタイプを返す'</span></span><br><span class="line"></span><br><span class="line">  37/37: [==================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00780s</span><br><span class="line">37 tests, 41 assertions, 0 failures, 1 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>現時点では <strong>例外</strong> を投げるので未定義タイプ <code>FizzBuzzTypeNotDefined</code> を作成して <strong>ファクトリメソッド</strong> を変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">  TYPE_01 = <span class="number">1</span></span><br><span class="line">  TYPE_02 = <span class="number">2</span></span><br><span class="line">  TYPE_03 = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">create</span><span class="params">(type)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_01</span><br><span class="line">      FizzBuzzType01.new</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_02</span><br><span class="line">      FizzBuzzType02.new</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_03</span><br><span class="line">      FizzBuzzType03.new</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">'該当するタイプは存在しません'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">fizz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">buzz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">5</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span> &lt; FizzBuzzType</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">  TYPE_01 = <span class="number">1</span></span><br><span class="line">  TYPE_02 = <span class="number">2</span></span><br><span class="line">  TYPE_03 = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">create</span><span class="params">(type)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_01</span><br><span class="line">      FizzBuzzType01.new</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_02</span><br><span class="line">      FizzBuzzType02.new</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_03</span><br><span class="line">      FizzBuzzType03.new</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      FizzBuzzTypeNotDefined.new</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTypeNotDefined</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    FizzBuzzValue.new(number, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">to_s</span></span></span><br><span class="line">    <span class="string">'未定義'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValue</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Started with run options --seed 33939</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Progress: |=====================================================================================================|</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.01193s</span><br><span class="line">37 tests, 42 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">06:46:48 - INFO - Inspecting Ruby code style: lib/fizz_buzz.rb</span><br><span class="line"> 1/1 file |======================================= 100 ========================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">1 file inspected, no offenses detected</span><br><span class="line">06:46:49 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/border.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/loading_background.png</span><br><span class="line"> 0/0 files |======================================= 100 =======================================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">0 files inspected, no offenses detected</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストが通るようになりました。 <strong>メソッドオブジェクト</strong> から実行された場合の振る舞いも明記しておきましょう。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>未定義のタイプを返す</span></span><br><span class="line">        fizzbuzz = FizzBuzzType.create(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'未定義'</span>, fizzbuzz.to_s</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>空の文字列を返す</span></span><br><span class="line">        type = FizzBuzzType.create(<span class="number">4</span>)</span><br><span class="line">        command = FizzBuzzValueCommand.new(type)</span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">''</span>, command.execute(<span class="number">3</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">06:48:54 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 62 / 65 LOC (95.38%) covered.</span><br><span class="line">Started with run options --guard --seed 18202</span><br><span class="line"></span><br><span class="line">  38/38: [==================================================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00747s</span><br><span class="line">38 tests, 43 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>FizzBuzzTypeNotDefined</code> オブジェクトは <strong>Null Object パターン</strong> を適用したものです。</p>
<blockquote>
<p>Null Object パターン</p>
<p>特殊な状況をオブジェクトで表現するにはどうすればよいだろうか—その特殊な状況を表現するオブジェクトを作り、通常のオブジェクトと同じプロトコル（メソッド群）を実装しよう。</p>
<p>— テスト駆動開発</p>
</blockquote>
<p><strong>オープン・クローズドの原則</strong> に従って未定義のタイプである <strong>Null Object</strong> を安全に追加することができたのでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: 特殊ケースの導入'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/ca6f3d49-ca33-7e5a-5d72-7dd715f0eb12.png" alt="diag-88e1d9090efb8e346a8986204d1decac.png"></p>
<h3 id="モジュール分割"><a href="#モジュール分割" class="headerlink" title="モジュール分割"></a>モジュール分割</h3><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/ca6f3d49-ca33-7e5a-5d72-7dd715f0eb12.png" alt="diag-88e1d9090efb8e346a8986204d1decac.png"></p>
<p>クラスモジュールの抽出によってアプリケーションの構造が <strong>抽象化</strong> された結果、視覚的に把握できるようになりました。ここでアプリケーションを実行してみましょう。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ruby main.rb</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">main.rb:5:<span class="keyword">in</span> `&lt;main&gt;<span class="string">': uninitialized constant FizzBuzz (NameError)</span></span><br><span class="line"><span class="string">Did you mean?  FizzBuzzType</span></span><br></pre></td></tr></table></figure>

<p>エラーが出ています、これはアプリケーションの構成が変わったためです。クライアントプログラムをアプリケーションの変更に合わせて修正します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz.rb'</span></span><br><span class="line"></span><br><span class="line">puts FizzBuzz.generate_list</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line">require <span class="string">'./lib/fizz_buzz.rb'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">command</span> = FizzBuzzListCommand.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">command.execute(100).each &#123; |i| puts i.value &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ruby main.rb</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">Fizz</span><br><span class="line">4</span><br><span class="line">Buzz</span><br><span class="line">...</span><br><span class="line">Fizz</span><br></pre></td></tr></table></figure>

<p>クライアントプログラムが直ったのでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'fix: プリントする'</span></span><br></pre></td></tr></table></figure>

<h4 id="ドメインモデル"><a href="#ドメインモデル" class="headerlink" title="ドメインモデル"></a>ドメインモデル</h4><p><code>fizz_buzz.rb</code> ファイル内のクラスモジュールをファイルとして分割していきます。まずは <strong>ドメインオブジェクト</strong> を抽出して <strong>ドメインモデル</strong> として整理しましょう。既存のテストを壊さないように１つづつコピー&amp;ペーストしていきます。</p>
<blockquote>
<p>関連する業務データと業務ロジックを１つにまとめたこのようなオブジェクトをドメインオブジェクトと呼びます。</p>
<p>「ドメイン」とは、対象領域とか問題領域という意味です。業務アプリケーションの場合、そのアプリケーションが対象となる業務活動全体がドメインです。業務活動という問題領域（ドメイン）で扱うデータと業務ロジックを、オブジェクトとして表現したものドメインオブジェクトです。ドメインオブジェクトは、業務データと業務ロジックを密接に関係づけます。</p>
<p>— 現場で役立つシステム設計の原則</p>
</blockquote>
<blockquote>
<p>このように業務アプリケーションの対象領域（ドメイン）をオブジェクトのモデルとして整理したものをドメインモデルと呼びます。</p>
<p>— 現場で役立つシステム設計の原則</p>
</blockquote>
<pre><code>/main.rb
  |--lib/
      |
       -- fizz_buzz.rb
  |--test/
      |
       -- fizz_buzz_test.rb

/main.rb
  |--lib/
      |
      domain/
           |
           model/
               |
               -- fizz_buzz_value.rb
               -- fizz_buzz_list.rb
           type/
               |
               -- fizz_buzz_type.rb
               -- fizz_buzz_type_01.rb
               -- fizz_buzz_type_02.rb
               -- fizz_buzz_type_03.rb
               -- fizz_buzz_type_not_defined.rb
       -- fizz_buzz.rb
  |--test/
      |
       -- fizz_buzz_test.rb</code></pre><p><strong>値オブジェクトクラス</strong> と <strong>タイプクラス</strong> を <code>domain</code> フォルダ以下に配置します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValue</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:number</span>, <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(number, value)</span></span></span><br><span class="line">    raise <span class="string">'正の値のみ有効です'</span> <span class="keyword">if</span> number.negative?</span><br><span class="line"></span><br><span class="line">    @number = number</span><br><span class="line">    @value = value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">to_s</span></span></span><br><span class="line">    <span class="string">"<span class="subst">#&#123;@number&#125;</span>:<span class="subst">#&#123;@value&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">==</span><span class="params">(other)</span></span></span><br><span class="line">    @number == other.number &amp;&amp; @value == other.value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">alias</span> eql? ==</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzList</span></span></span><br><span class="line">  MAX_COUNT = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(list)</span></span></span><br><span class="line">    raise <span class="string">"上限は<span class="subst">#&#123;MAX_COUNT&#125;</span>件までです"</span> <span class="keyword">if</span> list.count &gt; MAX_COUNT</span><br><span class="line"></span><br><span class="line">    @value = list</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">to_s</span></span></span><br><span class="line">    @value.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(value)</span></span></span><br><span class="line">    FizzBuzzList.new(@value + value)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">  TYPE_01 = <span class="number">1</span></span><br><span class="line">  TYPE_02 = <span class="number">2</span></span><br><span class="line">  TYPE_03 = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">create</span><span class="params">(type)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_01</span><br><span class="line">      FizzBuzzType01.new</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_02</span><br><span class="line">      FizzBuzzType02.new</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_03</span><br><span class="line">      FizzBuzzType03.new</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      FizzBuzzTypeNotDefined.new</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">fizz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">buzz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">5</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'FizzBuzz'</span>) <span class="keyword">if</span> fizz?(number) &amp;&amp; buzz?(number)</span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'Fizz'</span>) <span class="keyword">if</span> fizz?(number)</span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'Buzz'</span>) <span class="keyword">if</span> buzz?(number)</span><br><span class="line"></span><br><span class="line">    FizzBuzzValue.new(number, number.to_s)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    FizzBuzzValue.new(number, number.to_s)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'FizzBuzz'</span>) <span class="keyword">if</span> fizz?(number) &amp;&amp; buzz?(number)</span><br><span class="line"></span><br><span class="line">    FizzBuzzValue.new(number, number.to_s)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTypeNotDefined</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    FizzBuzzValue.new(number, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">to_s</span></span></span><br><span class="line">    <span class="string">'未定義'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">07:29:03 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/border.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/loading_background.png lib/domain/<span class="built_in">type</span>/fizz_buzz_type_not_defined.rb lib/domain/<span class="built_in">type</span>/fizz_buzz_type_03.rb lib/domain/<span class="built_in">type</span>/fizz_buzz_type_02.rb lib/domain/<span class="built_in">type</span>/fizz_buzz_type_01.rb lib/domain/<span class="built_in">type</span>/fizz_buzz_type.rb lib/domain/model/fizz_buzz_list.rb lib/domain/model/fizz_buzz_value.rb</span><br><span class="line">lib/domain/<span class="built_in">type</span>/fizz_buzz_type_not_defined.rb:3:1: C: Style/Documentation: Missing top-level class documentation comment.</span><br><span class="line">class FizzBuzzTypeNotDefined &lt; FizzBuzzType</span><br><span class="line">^^^^^</span><br><span class="line">lib/domain/<span class="built_in">type</span>/fizz_buzz_type_03.rb:3:1: C: Style/Documentation: Missing top-level class documentation comment.</span><br><span class="line">class FizzBuzzType03 &lt; FizzBuzzType</span><br><span class="line">^^^^^</span><br><span class="line">lib/domain/<span class="built_in">type</span>/fizz_buzz_type_02.rb:3:1: C: Style/Documentation: Missing top-level class documentation comment.</span><br><span class="line">class FizzBuzzType02 &lt; FizzBuzzType</span><br><span class="line">^^^^^</span><br><span class="line">lib/domain/<span class="built_in">type</span>/fizz_buzz_type_01.rb:3:1: C: Style/Documentation: Missing top-level class documentation comment.</span><br><span class="line">class FizzBuzzType01 &lt; FizzBuzzType</span><br><span class="line">^^^^^</span><br><span class="line">lib/domain/<span class="built_in">type</span>/fizz_buzz_type.rb:3:1: C: Style/Documentation: Missing top-level class documentation comment.</span><br><span class="line">class FizzBuzzType</span><br><span class="line">^^^^^</span><br><span class="line">lib/domain/model/fizz_buzz_list.rb:3:1: C: Style/Documentation: Missing top-level class documentation comment.</span><br><span class="line">class FizzBuzzList</span><br><span class="line">^^^^^</span><br><span class="line">lib/domain/model/fizz_buzz_value.rb:3:1: C: Style/Documentation: Missing top-level class documentation comment.</span><br><span class="line">class FizzBuzzValue</span><br><span class="line">^^^^^</span><br><span class="line"> 7/7 files |======================== 100 =========================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">7 files inspected, 7 offenses detected</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストは壊れていないようですが警告が出るようになりました。まだ仕掛ですが一旦コミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor(WIP): モジュール分割'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/3da7c995-b63a-7864-7091-a0f43d3c99b1.png" alt="diag-5f47ca3306a2dc4364311b77c4b5cea3.png"></p>
<h4 id="アプリケーション"><a href="#アプリケーション" class="headerlink" title="アプリケーション"></a>アプリケーション</h4><p>続いて <strong>アプリケーション層</strong> の分割を行います。</p>
<blockquote>
<p>データクラスと機能クラスを分ける手続き型の設計では、アプリケーション層のクラスに業務ロジックの詳細を記述します。</p>
<p>— 現場で役立つシステム設計の原則</p>
</blockquote>
<pre><code>/main.rb
  |--lib/
      |
      domain/
           |
           model/
               |
               -- fizz_buzz_value.rb
               -- fizz_buzz_list.rb
           type/
               |
               -- fizz_buzz_type.rb
               -- fizz_buzz_type_01.rb
               -- fizz_buzz_type_02.rb
               -- fizz_buzz_type_03.rb
       -- fizz_buzz.rb
  |--test/
      |
       -- fizz_buzz_test.rb

/main.rb
  |--lib/
      |
     application/
           |
           -- fizz_buzz_command.rb
           -- fizz_buzz_value_command.rb
           -- fizz_buzz_list_command.rb
     domain/
           |
           model/
               |
               -- fizz_buzz_value.rb
               -- fizz_buzz_list.rb
           type/
               |
               -- fizz_buzz_type.rb
               -- fizz_buzz_type_01.rb
               -- fizz_buzz_type_02.rb
               -- fizz_buzz_type_03.rb
       -- fizz_buzz.rb
  |--test/
      |
       -- fizz_buzz_test.rb</code></pre><p>ここでは <strong>ドメインオブジェクト</strong> を操作する <strong>メソッドオブジェクト</strong> を <code>application</code> フォルダ以下に配置します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzCommand</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span>;</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValueCommand</span> &lt; FizzBuzzCommand</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(number)</span></span></span><br><span class="line">    @type.generate(number).value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzListCommand</span> &lt; FizzBuzzCommand</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(number)</span></span></span><br><span class="line">    FizzBuzzList.new((<span class="number">1</span>..number).map &#123; <span class="params">|i|</span> @type.generate(i) &#125;).value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>テストは壊れていないのでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor(WIP): モジュール分割'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/b4adb851-0e0d-a5eb-f490-cddd272822cc.png" alt="diag-84a49e2f281dfc169055d0bfc4b4aeb6.png"></p>
<h4 id="テスト"><a href="#テスト" class="headerlink" title="テスト"></a>テスト</h4><p>アプリケーションのメイン部分は分割できました。続いてテストも分割しましょう。</p>
<pre><code>/main.rb
  |--lib/
      |
     application/
           |
           -- fizz_buzz_command.rb
           -- fizz_buzz_value_command.rb
           -- fizz_buzz_list_command.rb
     domain/
           |
           model/
               |
               -- fizz_buzz_value.rb
               -- fizz_buzz_list.rb
           type/
               |
               -- fizz_buzz_type.rb
               -- fizz_buzz_type_01.rb
               -- fizz_buzz_type_02.rb
               -- fizz_buzz_type_03.rb
       -- fizz_buzz.rb
  |--test/
      |
       -- fizz_buzz_test.rb

/main.rb
  |--lib/
      |
     application/
           |
           -- fizz_buzz_command.rb
           -- fizz_buzz_value_command.rb
           -- fizz_buzz_list_command.rb
     domain/
           |
           model/
               |
               -- fizz_buzz_value.rb
               -- fizz_buzz_list.rb
           type/
               |
               -- fizz_buzz_type.rb
               -- fizz_buzz_type_01.rb
               -- fizz_buzz_type_02.rb
               -- fizz_buzz_type_03.rb
       -- fizz_buzz.rb
  |--test/
      |
      application/
           |
           -- fizz_buzz_value_command_test.rb
           -- fizz_buzz_list_command_test.rb
      domain/
           |
           model/
                 |
                 -- fizz_buzz_value_test.rb
                 -- fizz_buzz_list_test.rb
      |
       -- learning_test.rb</code></pre><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'simplecov'</span></span><br><span class="line">SimpleCov.start</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/reporters'</span></span><br><span class="line">Minitest::Reporters.use!</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValueCommandTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzzValueCommand.new(FizzBuzzType01.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列<span class="title">Fizz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Fizz'</span>, @fizzbuzz.execute(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @fizzbuzz.execute(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @fizzbuzz.execute(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.execute(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzzValueCommand.new(FizzBuzzType02.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.execute(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.execute(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列15を返す</span></span><br><span class="line">          assert_equal <span class="string">'15'</span>, @fizzbuzz.execute(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.execute(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzzValueCommand.new(FizzBuzzType03.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.execute(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.execute(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @fizzbuzz.execute(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.execute(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>未定義のタイプを返す</span></span><br><span class="line">        fizzbuzz = FizzBuzzType.create(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'未定義'</span>, fizzbuzz.to_s</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>空の文字列を返す</span></span><br><span class="line">        type = FizzBuzzType.create(<span class="number">4</span>)</span><br><span class="line">        command = FizzBuzzValueCommand.new(type)</span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">''</span>, command.execute(<span class="number">3</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">'例外ケース'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>値は正の値のみ許可する</span></span><br><span class="line">      e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">        FizzBuzzValueCommand.new(</span><br><span class="line">          FizzBuzzType.create(FizzBuzzType::TYPE_01)</span><br><span class="line">        ).execute(-<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">'正の値のみ有効です'</span>, e.message</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'simplecov'</span></span><br><span class="line">SimpleCov.start</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/reporters'</span></span><br><span class="line">Minitest::Reporters.use!</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzListCommandTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzzListCommand.new(FizzBuzzType01.new)</span><br><span class="line">          @result = fizzbuzz.execute(<span class="number">100</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の初めは文字列の1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @result.first.value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の最後は文字列の<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @result.last.value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の2番目は文字列の<span class="title">Fizz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Fizz'</span>, @result[<span class="number">2</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の4番目は文字列の<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @result[<span class="number">4</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の14番目は文字列の<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @result[<span class="number">14</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">'例外ケース'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_100</span>より多い数を許可しない</span></span><br><span class="line">      e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">        FizzBuzzListCommand.new(</span><br><span class="line">          FizzBuzzType.create(FizzBuzzType::TYPE_01)</span><br><span class="line">        ).execute(<span class="number">101</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">'上限は100件までです'</span>, e.message</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'simplecov'</span></span><br><span class="line">SimpleCov.start</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/reporters'</span></span><br><span class="line">Minitest::Reporters.use!</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValueTest</span> &lt; Minitest::Test</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_</span>同じで値である</span></span><br><span class="line">    value1 = FizzBuzzValue.new(<span class="number">1</span>, <span class="string">'1'</span>)</span><br><span class="line">    value2 = FizzBuzzValue.new(<span class="number">1</span>, <span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">    assert value1.eql?(value2)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_to_string</span>メソッド</span></span><br><span class="line">    value = FizzBuzzValue.new(<span class="number">3</span>, <span class="string">'Fizz'</span>)</span><br><span class="line"></span><br><span class="line">    assert_equal <span class="string">'3:Fizz'</span>, value.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'simplecov'</span></span><br><span class="line">SimpleCov.start</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/reporters'</span></span><br><span class="line">Minitest::Reporters.use!</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzListTest</span> &lt; Minitest::Test</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_</span>新しいインスタンスが作られる</span></span><br><span class="line">    command = FizzBuzzListCommand.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">    array = command.execute(<span class="number">50</span>)</span><br><span class="line">    list1 = FizzBuzzList.new(array)</span><br><span class="line">    list2 = list1.add(array)</span><br><span class="line"></span><br><span class="line">    assert_equal <span class="number">50</span>, list1.value.count</span><br><span class="line">    assert_equal <span class="number">100</span>, list2.value.count</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'simplecov'</span></span><br><span class="line">SimpleCov.start</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/reporters'</span></span><br><span class="line">Minitest::Reporters.use!</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LearningTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'配列や繰り返し処理を理解する'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>繰り返し処理</span></span><br><span class="line">      $stdout = StringIO.new</span><br><span class="line">      [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].each &#123; <span class="params">|i|</span> p i * i &#125;</span><br><span class="line">      output = $stdout.string</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">"1\n"</span> + <span class="string">"4\n"</span> + <span class="string">"9\n"</span>, output</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_select</span>メソッドで特定の条件を満たす要素だけを配列に入れて返す</span></span><br><span class="line">      result = [<span class="number">1.1</span>, <span class="number">2</span>, <span class="number">3.3</span>, <span class="number">4</span>].select(&amp;<span class="symbol">:integer?</span>)</span><br><span class="line">      assert_equal [<span class="number">2</span>, <span class="number">4</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_find_all</span>メソッドで特定の条件を満たす要素だけを配列に入れて返す</span></span><br><span class="line">      result = [<span class="number">1.1</span>, <span class="number">2</span>, <span class="number">3.3</span>, <span class="number">4</span>].find_all(&amp;<span class="symbol">:integer?</span>)</span><br><span class="line">      assert_equal [<span class="number">2</span>, <span class="number">4</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>特定の条件を満たさない要素だけを配列に入れて返す</span></span><br><span class="line">      result = [<span class="number">1.1</span>, <span class="number">2</span>, <span class="number">3.3</span>, <span class="number">4</span>].reject(&amp;<span class="symbol">:integer?</span>)</span><br><span class="line">      assert_equal [<span class="number">1.1</span>, <span class="number">3.3</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_map</span>メソッドで新しい要素の配列を返す</span></span><br><span class="line">      result = <span class="string">%w[apple orange pineapple strawberry]</span>.map(&amp;<span class="symbol">:size</span>)</span><br><span class="line">      assert_equal [<span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_collect</span>メソッドで新しい要素の配列を返す</span></span><br><span class="line">      result = <span class="string">%w[apple orange pineapple strawberry]</span>.collect(&amp;<span class="symbol">:size</span>)</span><br><span class="line">      assert_equal [<span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_find</span>メソッドで配列の中から条件に一致する要素を取得する</span></span><br><span class="line">      result = <span class="string">%w[apple orange pineapple strawberry]</span>.find(&amp;<span class="symbol">:size</span>)</span><br><span class="line">      assert_equal <span class="string">'apple'</span>, result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_detect</span>メソッドで配列の中から条件に一致する要素を取得する</span></span><br><span class="line">      result = <span class="string">%w[apple orange pineapple strawberry]</span>.detect(&amp;<span class="symbol">:size</span>)</span><br><span class="line">      assert_equal <span class="string">'apple'</span>, result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>指定した評価式で並び変えた配列を返す</span></span><br><span class="line">      result1 = <span class="string">%w[2 4 13 3 1 10]</span>.sort</span><br><span class="line">      result2 = <span class="string">%w[2 4 13 3 1 10]</span>.sort &#123; <span class="params">|a, b|</span> a.to_i &lt;=&gt; b.to_i &#125;</span><br><span class="line">      result3 = <span class="string">%w[2 4 13 3 1 10]</span>.sort &#123; <span class="params">|b, a|</span> a.to_i &lt;=&gt; b.to_i &#125;</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">%w[1 10 13 2 3 4]</span>, result1</span><br><span class="line">      assert_equal <span class="string">%w[1 2 3 4 10 13]</span>, result2</span><br><span class="line">      assert_equal <span class="string">%w[13 10 4 3 2 1]</span>, result3</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の中から条件に一致する要素を取得する</span></span><br><span class="line">      result = <span class="string">%w[apple orange pineapple strawberry apricot]</span>.grep(<span class="regexp">/^a/</span>)</span><br><span class="line">      assert_equal <span class="string">%w[apple apricot]</span>, result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>ブロック内の条件式が真である間までの要素を返す</span></span><br><span class="line">      result = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>].take_while &#123; <span class="params">|item|</span> item &lt; <span class="number">6</span> &#125;</span><br><span class="line">      assert_equal [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>ブロック内の条件式が真である以降の要素を返す</span></span><br><span class="line">      result = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>].drop_while &#123; <span class="params">|item|</span> item &lt; <span class="number">6</span> &#125;</span><br><span class="line">      assert_equal [<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_inject</span>メソッドで畳み込み演算を行う</span></span><br><span class="line">      result = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>].inject(<span class="number">0</span>) &#123; <span class="params">|total, n|</span> total + n &#125;</span><br><span class="line">      assert_equal <span class="number">15</span>, result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_reduce</span>メソッドで畳み込み演算を行う</span></span><br><span class="line">      result = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>].reduce &#123; <span class="params">|total, n|</span> total + n &#125;</span><br><span class="line">      assert_equal <span class="number">15</span>, result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>ファイル分割でテストは壊れていないようですが警告がたくさん出てきました。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="built_in">test</span>/learning_test.rb:70:14: C: Naming/AsciiIdentifiers: Use only ascii symbols <span class="keyword">in</span> identifiers.</span><br><span class="line">    def test_ブロック内の条件式が真である間までの要素を返す</span><br><span class="line">             ^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line"><span class="built_in">test</span>/learning_test.rb:75:9: C: Naming/MethodName: Use snake_case <span class="keyword">for</span> method names.</span><br><span class="line">    def test_ブロック内の条件式が真である以降の要素を返す</span><br><span class="line">        ^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line"><span class="built_in">test</span>/learning_test.rb:75:14: C: Naming/AsciiIdentifiers: Use only ascii symbols <span class="keyword">in</span> identifiers.</span><br><span class="line">    def test_ブロック内の条件式が真である以降の要素を返す</span><br><span class="line">             ^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line"><span class="built_in">test</span>/learning_test.rb:80:9: C: Naming/MethodName: Use snake_case <span class="keyword">for</span> method names.</span><br><span class="line">    def test_injectメソッドで畳み込み演算を行う</span><br><span class="line">        ^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line"><span class="built_in">test</span>/learning_test.rb:80:20: C: Naming/AsciiIdentifiers: Use only ascii symbols <span class="keyword">in</span> identifiers.</span><br><span class="line">    def test_injectメソッドで畳み込み演算を行う</span><br><span class="line">                   ^^^^^^^^^^^^^^</span><br><span class="line"><span class="built_in">test</span>/learning_test.rb:85:9: C: Naming/MethodName: Use snake_case <span class="keyword">for</span> method names.</span><br><span class="line">    def test_reduceメソッドで畳み込み演算を行う</span><br><span class="line">        ^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line"><span class="built_in">test</span>/learning_test.rb:85:20: C: Naming/AsciiIdentifiers: Use only ascii symbols <span class="keyword">in</span> identifiers.</span><br><span class="line">    def test_reduceメソッドで畳み込み演算を行う</span><br><span class="line">                   ^^^^^^^^^^^^^^</span><br><span class="line"> 15/15 files |======================= 100 ========================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">15 files inspected, 87 offenses detected</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>これらはテストコードに関する警告がほとんどなので <code>.rubocop.yml</code> を編集してチェック対象から外しておきましょう。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inherit_from:</span> <span class="string">.rubocop_todo.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Naming/AsciiIdentifiers:</span></span><br><span class="line">  <span class="attr">Exclude:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"test/**/*"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Naming/MethodName:</span></span><br><span class="line">  <span class="attr">EnforcedStyle:</span> <span class="string">snake_case</span></span><br><span class="line">  <span class="attr">Exclude:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"test/**/*"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Metrics/BlockLength:</span></span><br><span class="line">  <span class="attr">Max:</span> <span class="number">62</span></span><br><span class="line">  <span class="attr">Exclude:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"test/**/*"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Documentation:</span></span><br><span class="line">  <span class="attr">Enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">08:21:55 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 144 / 215 LOC (66.98%) covered.</span><br><span class="line">Started with run options --guard --seed 55977</span><br><span class="line"></span><br><span class="line">  70/70: [=====================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.01518s</span><br><span class="line">70 tests, 79 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line"></span><br><span class="line">08:21:56 - INFO - Inspecting Ruby code style of all files</span><br><span class="line">/workspace/tdd_rb/.rubocop.yml: Warning: no department given <span class="keyword">for</span> Documentation.</span><br><span class="line"> 22/22 files |======================= 100 ========================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">22 files inspected, no offenses detected</span><br><span class="line">08:21:58 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/border.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/loading_background.png</span><br><span class="line">/workspace/tdd_rb/.rubocop.yml: Warning: no department given <span class="keyword">for</span> Documentation.</span><br><span class="line"> 0/0 files |======================== 100 =========================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">0 files inspected, no offenses detected</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>警告は消えました、仕上げに <code>fizz_buzz_test.rb</code> ファイルを削除します。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">08:24:12 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest, Unit Tests to /workspace/tdd_rb/coverage. 135 / 201 LOC (67.16%) covered.</span><br><span class="line">Started with run options --guard --seed 40104</span><br><span class="line"></span><br><span class="line">  32/32: [=====================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00601s</span><br><span class="line">32 tests, 36 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line"></span><br><span class="line">08:24:13 - INFO - Inspecting Ruby code style of all files</span><br><span class="line">/workspace/tdd_rb/.rubocop.yml: Warning: no department given <span class="keyword">for</span> Documentation.</span><br><span class="line"> 21/21 files |======================= 100 ========================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">21 files inspected, no offenses detected</span><br><span class="line">08:24:14 - INFO - Inspecting Ruby code style: coverage/assets/0.10.2/colorbox/controls.png coverage/assets/0.10.2/colorbox/border.png coverage/assets/0.10.2/colorbox/loading.gif coverage/assets/0.10.2/colorbox/loading_background.png</span><br><span class="line">/workspace/tdd_rb/.rubocop.yml: Warning: no department given <span class="keyword">for</span> Documentation.</span><br><span class="line"> 0/0 files |======================== 100 =========================&gt;| Time: 00:00:00</span><br><span class="line"></span><br><span class="line">0 files inspected, no offenses detected</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストの分割も完了したのでコミットしておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor(WIP): モジュール分割'</span></span><br></pre></td></tr></table></figure>

<h4 id="エントリーポイント"><a href="#エントリーポイント" class="headerlink" title="エントリーポイント"></a>エントリーポイント</h4><p>仕上げはクラスモジュールのエントリーポイント作成とテストヘルパーの追加です。</p>
<pre><code>/main.rb
  |--lib/
      |
     application/
           |
           -- fizz_buzz_command.rb
           -- fizz_buzz_value_command.rb
           -- fizz_buzz_list_command.rb
     domain/
           |
           model/
               |
               -- fizz_buzz_value.rb
               -- fizz_buzz_list.rb
           type/
               |
               -- fizz_buzz_type.rb
               -- fizz_buzz_type_01.rb
               -- fizz_buzz_type_02.rb
               -- fizz_buzz_type_03.rb
       -- fizz_buzz.rb
  |--test/
      |
      application/
           |
           -- fizz_buzz_value_command_test.rb
           -- fizz_buzz_list_command._test.rb
      domain/
           |
           model/
                 |
                 -- fizz_buzz_value_test.rb
                 -- fizz_buzz_list_test.rb
      |
       -- learning_test.rb

/main.rb
  |--lib/
      |
     application/
           |
           -- fizz_buzz_command.rb
           -- fizz_buzz_value_command.rb
           -- fizz_buzz_list_command.rb
     domain/
           |
           model/
               |
               -- fizz_buzz_value.rb
               -- fizz_buzz_list.rb
           type/
               |
               -- fizz_buzz_type.rb
               -- fizz_buzz_type_01.rb
               -- fizz_buzz_type_02.rb
               -- fizz_buzz_type_03.rb
       -- fizz_buzz.rb
  |--test/
      |
      application/
           |
           -- fizz_buzz_value_command_test.rb
           -- fizz_buzz_list_command._test.rb
      domain/
           |
           model/
                 |
                 -- fizz_buzz_value_test.rb
                 -- fizz_buzz_list_test.rb
      |
       -- learning_test.rb
       -- test_helper.rb</code></pre><p><code>fizz_buzz.rb</code> ファイルの内容をクラスモジュール読み込みに変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'./lib/application/fizz_buzz_command.rb'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/application/fizz_buzz_value_command.rb'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/application/fizz_buzz_list_command.rb'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/domain/model/fizz_buzz_value.rb'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/domain/model/fizz_buzz_list.rb'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/domain/type/fizz_buzz_type.rb'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/domain/type/fizz_buzz_type_01.rb'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/domain/type/fizz_buzz_type_02.rb'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/domain/type/fizz_buzz_type_03.rb'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/domain/type/fizz_buzz_type_not_defined.rb'</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">08:34:32 - INFO - Running: all tests</span><br><span class="line">Coverage report generated <span class="keyword">for</span> MiniTest to /workspace/tdd_rb/coverage. 119 / 211 LOC (56.4%) covered.</span><br><span class="line">Started with run options --guard --seed 18696</span><br><span class="line"></span><br><span class="line">  32/32: [=====================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00561s</span><br><span class="line">32 tests, 36 assertions, 0 failures, 0 errors, 0 skips</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>コードカバレッジがうまく機能していないようなので、<code>test_helper.rb</code> を追加して共通部分を各テストファイルから読み込むように変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'simplecov'</span></span><br><span class="line">SimpleCov.start</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/reporters'</span></span><br><span class="line">Minitest::Reporters.use!</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'simplecov'</span></span><br><span class="line">SimpleCov.start</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/reporters'</span></span><br><span class="line">Minitest::Reporters.use!</span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'./test/test_helper'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>テストタスクを実行したところ動作しなくなりました。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rake <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>テスト対象をテストディレクトリ内のすべてのテストコードに変更します。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Rake::TestTask.new <span class="keyword">do</span> <span class="params">|test|</span></span><br><span class="line">  test.test_files = Dir[<span class="string">'./test/fizz_buzz_test.rb'</span>]</span><br><span class="line">  test.verbose = <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Rake::TestTask.new <span class="keyword">do</span> <span class="params">|test|</span></span><br><span class="line">  test.test_files = Dir[<span class="string">'./test/**/*_test.rb'</span>]</span><br><span class="line">  test.verbose = <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ rake <span class="built_in">test</span></span><br><span class="line">Started with run options --seed 46929</span><br><span class="line"></span><br><span class="line">  32/32: [=====================================] 100% Time: 00:00:00, Time: 00:00:00</span><br><span class="line"></span><br><span class="line">Finished <span class="keyword">in</span> 0.00800s</span><br><span class="line">32 tests, 36 assertions, 0 failures, 0 errors, 0 skips</span><br></pre></td></tr></table></figure>

<p>テストも壊れていないし警告も出ていません。モジュール分割完了です。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'refactor: モジュール分割'</span></span><br></pre></td></tr></table></figure>

<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/7b7ead60-577c-fb59-6866-0b3c49b30112.png" alt="diag-c335939a7cce862d0b767629390a1852.png"></p>
<h3 id="ふりかえり"><a href="#ふりかえり" class="headerlink" title="ふりかえり"></a>ふりかえり</h3><p>今回、 <strong>オブジェクト指向プログラム</strong> から <strong>オブジェクト指向設計</strong> そして <strong>モジュール分割</strong> を <strong>テスト駆動開発</strong>を通じて実践しました。各トピックを振り返ってみましょう。</p>
<h4 id="オブジェクト指向プログラム-2"><a href="#オブジェクト指向プログラム-2" class="headerlink" title="オブジェクト指向プログラム"></a>オブジェクト指向プログラム</h4><p>エピソード 1 で作成したプログラムの追加仕様を <strong>テスト駆動開発</strong> で実装しました。 次に <strong>手続き型コード</strong> との比較から <strong>オブジェクト指向プログラム</strong> を構成する <strong>カプセル化</strong> <strong>ポリモフィズム</strong> <strong>継承</strong> という概念をコードベースの <strong>リファクタリング</strong> を通じて解説しました。</p>
<p>具体的には <strong>フィールドのカプセル</strong> から <strong>setter の削除</strong> を適用することにより <strong>カプセル化</strong> を実現しました。続いて、 <strong>ポリモーフィズムによる条件記述の置き換え</strong> から <strong>State/Strategy によるタイプコードの置き換え</strong> を適用することにより <strong>ポリモーフィズム</strong> の効果を体験しました。そして、 <strong>スーパークラスの抽出</strong> から <strong>メソッド名の変更</strong> <strong>メソッドの移動</strong> の適用を通して <strong>継承</strong> の使い方を体験しました。さらに <strong>値オブジェクト</strong> と <strong>ファーストクラス</strong> というオブジェクト指向プログラミングに必要なツールの使い方も学習しました。</p>
<h4 id="オブジェクト指向設計-2"><a href="#オブジェクト指向設計-2" class="headerlink" title="オブジェクト指向設計"></a>オブジェクト指向設計</h4><p>次に設計の観点から <strong>単一責任の原則</strong> に違反している <code>FizzBuzz</code> クラスを <strong>デザインパターン</strong> の 1 つである <strong>Command パターン</strong> を使ったリファクタリングである <strong>メソッドオブジェクトによるメソッドの置き換え</strong> を適用してクラスの責務を分割しました。オブジェクト指向設計のイデオムである <strong>デザインパターン</strong> として <strong>Command パターン</strong> 以外に <strong>Value Object パターン</strong> <strong>Factory Method パターン</strong> <strong>Strategy パターン</strong> を <strong>リファクタリング</strong> を適用する過程ですでに実現していたことを説明しました。そして、<strong>オープン・クローズドの原則</strong> を満たすコードに <strong>リファクタリング</strong> されたことで既存のコードを変更することなく振る舞いを変更できるようになりました。</p>
<p>加えて、正常系の設計を改善した後 <strong>アサーションの導入</strong> <strong>例外によるエラーコードの置き換え</strong> といった例外系の <strong>リファクタリング</strong> を適用しました。最後に <strong>ポリモーフィズム</strong> の応用として <strong>特殊ケースの導入</strong> の適用による <strong>Null Object パターン</strong> を使った <strong>オープン・クローズドの原則</strong> に従った安全なコードの追加方法を解説しました。</p>
<h4 id="モジュールの分割-1"><a href="#モジュールの分割-1" class="headerlink" title="モジュールの分割"></a>モジュールの分割</h4><p>仕上げに、<strong>モノリシック</strong> なファイルから個別のクラスモジュールへの分割を <strong>ドメインオブジェクト</strong> の抽出を通して <strong>ドメインモデル</strong> へと整理することにより <strong>モジュール分割</strong> を実現しました。最終的にプログラムからアプリケーションへと体裁を整えることが出来ました。以下が最終的なモジュール構造とコードです。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20035/7b7ead60-577c-fb59-6866-0b3c49b30112.png" alt="diag-c335939a7cce862d0b767629390a1852.png"></p>
<ul>
<li>Application</li>
</ul>
<p><strong>/main.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz.rb'</span></span><br><span class="line"></span><br><span class="line">command = FizzBuzzListCommand.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">command.execute(<span class="number">100</span>).each &#123; <span class="params">|i|</span> puts i.value &#125;</span><br></pre></td></tr></table></figure>

<p><strong>/lib/application/fizz_buzz_command.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzCommand</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span>;</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/lib/application/fizz_buzz_value_command.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValueCommand</span> &lt; FizzBuzzCommand</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(number)</span></span></span><br><span class="line">    @type.generate(number).value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/lib/application/fizz_buzz_list_command.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzListCommand</span> &lt; FizzBuzzCommand</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(type)</span></span></span><br><span class="line">    @type = type</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(number)</span></span></span><br><span class="line">    FizzBuzzList.new((<span class="number">1</span>..number).map &#123; <span class="params">|i|</span> @type.generate(i) &#125;).value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Domain</li>
</ul>
<p><strong>/lib/domain/model/fizz_buzz_value.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValue</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:number</span>, <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(number, value)</span></span></span><br><span class="line">    raise <span class="string">'正の値のみ有効です'</span> <span class="keyword">if</span> number.negative?</span><br><span class="line"></span><br><span class="line">    @number = number</span><br><span class="line">    @value = value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">to_s</span></span></span><br><span class="line">    <span class="string">"<span class="subst">#&#123;@number&#125;</span>:<span class="subst">#&#123;@value&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">==</span><span class="params">(other)</span></span></span><br><span class="line">    @number == other.number &amp;&amp; @value == other.value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">alias</span> eql? ==</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/lib/domain/model/fizz_buzz_list.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzList</span></span></span><br><span class="line">  MAX_COUNT = <span class="number">100</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(list)</span></span></span><br><span class="line">    raise <span class="string">"上限は<span class="subst">#&#123;MAX_COUNT&#125;</span>件までです"</span> <span class="keyword">if</span> list.count &gt; MAX_COUNT</span><br><span class="line"></span><br><span class="line">    @value = list</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">to_s</span></span></span><br><span class="line">    @value.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(value)</span></span></span><br><span class="line">    FizzBuzzList.new(@value + value)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/lib/domain/type/fizz_buzz_type.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType</span></span></span><br><span class="line">  TYPE_01 = <span class="number">1</span></span><br><span class="line">  TYPE_02 = <span class="number">2</span></span><br><span class="line">  TYPE_03 = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">create</span><span class="params">(type)</span></span></span><br><span class="line">    <span class="keyword">case</span> type</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_01</span><br><span class="line">      FizzBuzzType01.new</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_02</span><br><span class="line">      FizzBuzzType02.new</span><br><span class="line">    <span class="keyword">when</span> FizzBuzzType::TYPE_03</span><br><span class="line">      FizzBuzzType03.new</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      FizzBuzzTypeNotDefined.new</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">fizz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">3</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">buzz?</span><span class="params">(number)</span></span></span><br><span class="line">    number.modulo(<span class="number">5</span>).zero?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/lib/domain/type/fizz_buzz_type_01.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType01</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'FizzBuzz'</span>) <span class="keyword">if</span> fizz?(number) &amp;&amp; buzz?(number)</span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'Fizz'</span>) <span class="keyword">if</span> fizz?(number)</span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'Buzz'</span>) <span class="keyword">if</span> buzz?(number)</span><br><span class="line"></span><br><span class="line">    FizzBuzzValue.new(number, number.to_s)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/lib/domain/type/fizz_buzz_type_02.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType02</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    FizzBuzzValue.new(number, number.to_s)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/lib/domain/type/fizz_buzz_type_03.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzType03</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    <span class="keyword">return</span> FizzBuzzValue.new(number, <span class="string">'FizzBuzz'</span>) <span class="keyword">if</span> fizz?(number) &amp;&amp; buzz?(number)</span><br><span class="line"></span><br><span class="line">    FizzBuzzValue.new(number, number.to_s)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/lib/domain/type/fizz_buzz_type_not_defined.b.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzTypeNotDefined</span> &lt; FizzBuzzType</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(number)</span></span></span><br><span class="line">    FizzBuzzValue.new(number, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">to_s</span></span></span><br><span class="line">    <span class="string">'未定義'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Test</li>
</ul>
<p><strong>/test/application/fizz_buzz_value_command_test.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./test/test_helper'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValueCommandTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzzValueCommand.new(FizzBuzzType01.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列<span class="title">Fizz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Fizz'</span>, @fizzbuzz.execute(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @fizzbuzz.execute(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @fizzbuzz.execute(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.execute(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ2の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzzValueCommand.new(FizzBuzzType02.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.execute(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.execute(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列15を返す</span></span><br><span class="line">          assert_equal <span class="string">'15'</span>, @fizzbuzz.execute(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.execute(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'タイプ3の場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">        @fizzbuzz = FizzBuzzValueCommand.new(FizzBuzzType03.new)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_3</span>を渡したら文字列3を返す</span></span><br><span class="line">          assert_equal <span class="string">'3'</span>, @fizzbuzz.execute(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_5</span>を渡したら文字列5を返す</span></span><br><span class="line">          assert_equal <span class="string">'5'</span>, @fizzbuzz.execute(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'三と五の倍数の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_15</span>を渡したら文字列<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @fizzbuzz.execute(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      describe <span class="string">'その他の場合'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>を渡したら文字列1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @fizzbuzz.execute(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    describe <span class="string">'それ以外のタイプの場合'</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>未定義のタイプを返す</span></span><br><span class="line">        fizzbuzz = FizzBuzzType.create(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">'未定義'</span>, fizzbuzz.to_s</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test_</span>空の文字列を返す</span></span><br><span class="line">        type = FizzBuzzType.create(<span class="number">4</span>)</span><br><span class="line">        command = FizzBuzzValueCommand.new(type)</span><br><span class="line"></span><br><span class="line">        assert_equal <span class="string">''</span>, command.execute(<span class="number">3</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">'例外ケース'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>値は正の値のみ許可する</span></span><br><span class="line">      e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">        FizzBuzzValueCommand.new(</span><br><span class="line">          FizzBuzzType.create(FizzBuzzType::TYPE_01)</span><br><span class="line">        ).execute(-<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">'正の値のみ有効です'</span>, e.message</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/test/application/fizz_buzz_list_command_test.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./test/test_helper'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzListCommandTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'数を文字列にして返す'</span> <span class="keyword">do</span></span><br><span class="line">    describe <span class="string">'タイプ1の場合'</span> <span class="keyword">do</span></span><br><span class="line">      describe <span class="string">'1から100までのFizzBuzzの配列を返す'</span> <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">          fizzbuzz = FizzBuzzListCommand.new(FizzBuzzType01.new)</span><br><span class="line">          @result = fizzbuzz.execute(<span class="number">100</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の初めは文字列の1を返す</span></span><br><span class="line">          assert_equal <span class="string">'1'</span>, @result.first.value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の最後は文字列の<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @result.last.value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の2番目は文字列の<span class="title">Fizz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Fizz'</span>, @result[<span class="number">2</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の4番目は文字列の<span class="title">Buzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'Buzz'</span>, @result[<span class="number">4</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の14番目は文字列の<span class="title">FizzBuzz</span>を返す</span></span><br><span class="line">          assert_equal <span class="string">'FizzBuzz'</span>, @result[<span class="number">14</span>].value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">'例外ケース'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_100</span>より多い数を許可しない</span></span><br><span class="line">      e = assert_raises RuntimeError <span class="keyword">do</span></span><br><span class="line">        FizzBuzzListCommand.new(</span><br><span class="line">          FizzBuzzType.create(FizzBuzzType::TYPE_01)</span><br><span class="line">        ).execute(<span class="number">101</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">'上限は100件までです'</span>, e.message</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/test/domain/model/fizz_buzz_value_test.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./test/test_helper'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzValueTest</span> &lt; Minitest::Test</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_</span>同じで値である</span></span><br><span class="line">    value1 = FizzBuzzValue.new(<span class="number">1</span>, <span class="string">'1'</span>)</span><br><span class="line">    value2 = FizzBuzzValue.new(<span class="number">1</span>, <span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">    assert value1.eql?(value2)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_to_string</span>メソッド</span></span><br><span class="line">    value = FizzBuzzValue.new(<span class="number">3</span>, <span class="string">'Fizz'</span>)</span><br><span class="line"></span><br><span class="line">    assert_equal <span class="string">'3:Fizz'</span>, value.to_s</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/test/domain/model/fizz_buzz_list_test.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./test/test_helper'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FizzBuzzListTest</span> &lt; Minitest::Test</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_</span>新しいインスタンスが作られる</span></span><br><span class="line">    command = FizzBuzzListCommand.new(FizzBuzzType.create(FizzBuzzType::TYPE_01))</span><br><span class="line">    array = command.execute(<span class="number">50</span>)</span><br><span class="line">    list1 = FizzBuzzList.new(array)</span><br><span class="line">    list2 = list1.add(array)</span><br><span class="line"></span><br><span class="line">    assert_equal <span class="number">50</span>, list1.value.count</span><br><span class="line">    assert_equal <span class="number">100</span>, list2.value.count</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>/test/learning_test.rb.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frozen_string_literal: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./test/test_helper'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'minitest/autorun'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./lib/fizz_buzz'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LearningTest</span> &lt; Minitest::Test</span></span><br><span class="line">  describe <span class="string">'配列や繰り返し処理を理解する'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>繰り返し処理</span></span><br><span class="line">      $stdout = StringIO.new</span><br><span class="line">      [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].each &#123; <span class="params">|i|</span> p i * i &#125;</span><br><span class="line">      output = $stdout.string</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">"1\n"</span> + <span class="string">"4\n"</span> + <span class="string">"9\n"</span>, output</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_select</span>メソッドで特定の条件を満たす要素だけを配列に入れて返す</span></span><br><span class="line">      result = [<span class="number">1.1</span>, <span class="number">2</span>, <span class="number">3.3</span>, <span class="number">4</span>].select(&amp;<span class="symbol">:integer?</span>)</span><br><span class="line">      assert_equal [<span class="number">2</span>, <span class="number">4</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_find_all</span>メソッドで特定の条件を満たす要素だけを配列に入れて返す</span></span><br><span class="line">      result = [<span class="number">1.1</span>, <span class="number">2</span>, <span class="number">3.3</span>, <span class="number">4</span>].find_all(&amp;<span class="symbol">:integer?</span>)</span><br><span class="line">      assert_equal [<span class="number">2</span>, <span class="number">4</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>特定の条件を満たさない要素だけを配列に入れて返す</span></span><br><span class="line">      result = [<span class="number">1.1</span>, <span class="number">2</span>, <span class="number">3.3</span>, <span class="number">4</span>].reject(&amp;<span class="symbol">:integer?</span>)</span><br><span class="line">      assert_equal [<span class="number">1.1</span>, <span class="number">3.3</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_map</span>メソッドで新しい要素の配列を返す</span></span><br><span class="line">      result = <span class="string">%w[apple orange pineapple strawberry]</span>.map(&amp;<span class="symbol">:size</span>)</span><br><span class="line">      assert_equal [<span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_collect</span>メソッドで新しい要素の配列を返す</span></span><br><span class="line">      result = <span class="string">%w[apple orange pineapple strawberry]</span>.collect(&amp;<span class="symbol">:size</span>)</span><br><span class="line">      assert_equal [<span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_find</span>メソッドで配列の中から条件に一致する要素を取得する</span></span><br><span class="line">      result = <span class="string">%w[apple orange pineapple strawberry]</span>.find(&amp;<span class="symbol">:size</span>)</span><br><span class="line">      assert_equal <span class="string">'apple'</span>, result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_detect</span>メソッドで配列の中から条件に一致する要素を取得する</span></span><br><span class="line">      result = <span class="string">%w[apple orange pineapple strawberry]</span>.detect(&amp;<span class="symbol">:size</span>)</span><br><span class="line">      assert_equal <span class="string">'apple'</span>, result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>指定した評価式で並び変えた配列を返す</span></span><br><span class="line">      result1 = <span class="string">%w[2 4 13 3 1 10]</span>.sort</span><br><span class="line">      result2 = <span class="string">%w[2 4 13 3 1 10]</span>.sort &#123; <span class="params">|a, b|</span> a.to_i &lt;=&gt; b.to_i &#125;</span><br><span class="line">      result3 = <span class="string">%w[2 4 13 3 1 10]</span>.sort &#123; <span class="params">|b, a|</span> a.to_i &lt;=&gt; b.to_i &#125;</span><br><span class="line"></span><br><span class="line">      assert_equal <span class="string">%w[1 10 13 2 3 4]</span>, result1</span><br><span class="line">      assert_equal <span class="string">%w[1 2 3 4 10 13]</span>, result2</span><br><span class="line">      assert_equal <span class="string">%w[13 10 4 3 2 1]</span>, result3</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>配列の中から条件に一致する要素を取得する</span></span><br><span class="line">      result = <span class="string">%w[apple orange pineapple strawberry apricot]</span>.grep(<span class="regexp">/^a/</span>)</span><br><span class="line">      assert_equal <span class="string">%w[apple apricot]</span>, result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>ブロック内の条件式が真である間までの要素を返す</span></span><br><span class="line">      result = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>].take_while &#123; <span class="params">|item|</span> item &lt; <span class="number">6</span> &#125;</span><br><span class="line">      assert_equal [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_</span>ブロック内の条件式が真である以降の要素を返す</span></span><br><span class="line">      result = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>].drop_while &#123; <span class="params">|item|</span> item &lt; <span class="number">6</span> &#125;</span><br><span class="line">      assert_equal [<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>], result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_inject</span>メソッドで畳み込み演算を行う</span></span><br><span class="line">      result = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>].inject(<span class="number">0</span>) &#123; <span class="params">|total, n|</span> total + n &#125;</span><br><span class="line">      assert_equal <span class="number">15</span>, result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_reduce</span>メソッドで畳み込み演算を行う</span></span><br><span class="line">      result = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>].reduce &#123; <span class="params">|total, n|</span> total + n &#125;</span><br><span class="line">      assert_equal <span class="number">15</span>, result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="良い設計"><a href="#良い設計" class="headerlink" title="良い設計"></a>良い設計</h4><p>エピソード 1 では <strong>良いコード</strong> について考えました。</p>
<blockquote>
<p>TDD は「より良いコードを書けば、よりうまくいく」という素朴で奇妙な仮設によって成り立っている</p>
<p>— テスト駆動開発</p>
</blockquote>
<blockquote>
<p>「動作するきれいなコード」。RonJeffries のこの簡潔な言葉が、テスト駆動開発(TDD)のゴールだ。動作するきれいなコードはあらゆる意味で価値がある。</p>
<p>— テスト駆動開発</p>
</blockquote>
<blockquote>
<p>良いコードかどうかは、変更がどれだけ容易なのかで決まる。</p>
<p>— リファクタリング(第 2 版)</p>
</blockquote>
<blockquote>
<p>コードは理解しやすくなければいけない。</p>
<p>— リーダブルコード</p>
</blockquote>
<p>本エピソードでは <strong>テスト駆動開発</strong> による <strong>オブジェクト指向プログラミング</strong> の <strong>リファクタリング</strong> を経てコードベースを改善してきました。そして <strong>オブジェクト指向設計</strong> により <strong>良いコード</strong> のプログラムを <strong>良い設計</strong> のアプリケーションへと進化させることができました。</p>
<blockquote>
<p>どこに何が書いてあるかをわかりやすくし、変更の影響を狭い範囲に閉じ込め、安定して動作する部品を柔軟に組み合わせながらソフトウェアを構築する技法がオブジェクト指向設計です。</p>
<p>— 現場で役立つシステム設計の原則</p>
</blockquote>
<blockquote>
<p>設計の良し悪しは、ソフトウェアを変更するときにはっきりします。</p>
<p>構造が入り組んだわかりづらいプログラムは内容の理解に時間がかかります。重複したコードをあちこちで修正する作業が増え、変更の副作用に悩まされます。</p>
<p>一方、うまく設計されたプログラムは変更が楽で安全です。変更すべき箇所がかんたんにわかり、変更するコード量が少なく、変更の影響を狭い範囲に限定できます。</p>
<p>プログラムの修正に３日かかるか、それとも半日で済むか。その違いを生むのが「設計」なのです。</p>
<p>— 現場で役立つシステム設計の原則</p>
</blockquote>
<p>では、いつ設計をしていたのでしょうか？ わかりますよね、このエピソードの始まりから終わりまで常に設計をしていたのです。</p>
<blockquote>
<p>TDD は分析技法であり、設計技法であり、実際には開発のすべてのアクティビティを構造化する技法なのだ。</p>
<p>— テスト駆動開発</p>
</blockquote>
<h2 id="参考サイト"><a href="#参考サイト" class="headerlink" title="参考サイト"></a>参考サイト</h2><ul>
<li><a href="https://qiita.com/nrslib/items/73bf176147192c402049" target="_blank" rel="noopener">オブジェクト指向のいろは</a></li>
</ul>
<h2 id="参考図書"><a href="#参考図書" class="headerlink" title="参考図書"></a>参考図書</h2><ul>
<li><p>テスト駆動開発 Kent Beck (著), 和田 卓人 (翻訳): オーム社; 新訳版 (2017/10/14)</p>
</li>
<li><p>新装版 リファクタリング―既存のコードを安全に改善する― (OBJECT TECHNOLOGY SERIES) Martin<br>Fowler (著), 児玉 公信 (翻訳), 友野 晶夫 (翻訳), 平澤 章 (翻訳), その他: オーム社; 新装版<br>(2014/7/26)</p>
</li>
<li><p>リファクタリング(第 2 版): 既存のコードを安全に改善する (OBJECT TECHNOLOGY SERIES) Martin<br>Fowler (著), 児玉 公信 (翻訳), 友野 晶夫 (翻訳), 平澤 章 (翻訳), その他: オーム社; 第 2 版<br>(2019/12/1)</p>
</li>
<li><p>リーダブルコード ―より良いコードを書くためのシンプルで実践的なテクニック (Theory in practice)<br>Dustin Boswell (著), Trevor Foucher (著), 須藤 功平 (解説), 角 征典 (翻訳):<br>オライリージャパン; 初版八刷版 (2012/6/23)</p>
</li>
<li><p>Clean Code 　アジャイルソフトウェア達人の技 (アスキードワンゴ) Ｒｏｂｅｒｔ Ｃ．Ｍａｒｔｉｎ (著), 花井<br>志生 (著) ドワンゴ (2017/12/28)</p>
</li>
<li><p>現場で役立つシステム設計の原則 〜変更を楽で安全にするオブジェクト指向の実践技法 増田 亨 (著) 技術評論社<br>(2017/7/5)</p>
</li>
<li><p>かんたん Ruby (プログラミングの教科書) すがわらまさのり (著) 技術評論社 (2018/6/21)</p>
</li>
</ul>
<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="https://rcm-fe.amazon-adsystem.com/e/cm?ref=qf_sp_asin_til&t=k2works0c-22&m=amazon&o=9&p=8&l=as1&IS1=1&detail=1&asins=4274217884&linkId=568f25b974af5645e862928a12c354e1&bc1=ffffff&lt1=_top&fc1=333333&lc1=0066c0&bg1=ffffff&f=ifr"></iframe>
<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="https://rcm-fe.amazon-adsystem.com/e/cm?ref=qf_sp_asin_til&t=k2works0c-22&m=amazon&o=9&p=8&l=as1&IS1=1&detail=1&asins=427405019X&linkId=08e705a5969e20f5129b4d3cefbcdb15&bc1=000000&lt1=_top&fc1=333333&lc1=0066c0&bg1=ffffff&f=ifr"></iframe>
<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=k2works0c-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4274224546&linkId=5f857b58e988073ce92e0adcf1dd3ebb"></iframe>
<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=k2works0c-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4873115655&linkId=82416afd8e4042cbfd2dc6d4b80653f1"></iframe>
<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=k2works0c-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=B078HYWY5X&linkId=920b3fce45a79c528e5be0b2140cce9c"></iframe>
<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=k2works0c-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=B073GSDBGT&linkId=84e5b25b776d7583da1d5addf2e24fa7"></iframe>
<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=k2works0c-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4774198617&linkId=7858ddef815d9a093fcacb3a1208b774"></iframe>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">k2works</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://k2works.github.io/2020/04/19/1587440874/">https://k2works.github.io/2020/04/19/1587440874/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E3%83%86%E3%82%B9%E3%83%88%E9%A7%86%E5%8B%95%E9%96%8B%E7%99%BA/">テスト駆動開発</a><a class="post-meta__tags" href="/tags/Ruby/">Ruby</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e9e7853f8eb0c4e" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/04/21/1587434415/"><i class="fa fa-chevron-left">  </i><span>テスト駆動開発から始めるドメイン駆動設計入門 ~値オブジェクト~</span></a></div><div class="next-post pull-right"><a href="/2020/04/18/1587440576/"><span>テスト駆動開発から始めるRuby入門 ~アルゴリズムのパフォーマンスチューニングとベンチマークを実践する~</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By k2works</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>